
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ReinKarma</title>
    <style>
        #turn-transition-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 25px;
            z-index: 200; /* Ensure it's on top of most things */
            max-width: 80%;
            width: 400px;
            display: none;
            text-align: center;
            border-style: solid;
            border-width: 30px;
            border-image-source: url('https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F0F6CE608-7672-4AF9-81A2-114C2FF834F8.png?alt=media&token=b2bdd63c-6499-44b3-8375-5d2a4c28dbee');
            border-image-slice: 40;
            border-image-repeat: stretch;
            box-shadow: 0 0 25px rgba(0, 0, 0, 0.6);
        }

        #turn-transition-modal h3 {
            margin-top: 0;
            font-size: 1.8rem;
            color: #ffd700;
        }

        #turn-transition-modal p {
            font-size: 1.2rem;
            margin-bottom: 25px;
        }

        #turn-transition-ok-button {
            padding: 12px 25px;
            font-size: 1rem;
            background-color: #4CAF50;
 /* Default OK button color */
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }
        
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            overflow: hidden;
            touch-action: manipulation;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .empty-square {
            background-image: url('https://firebasestorage.googleapis.com/v0/b/sticky-20bca.appspot.com/o/sgm-asset%2F252ae59a-7d62-44a9-8947-8f8bbbb08037%2Fe86ac469-4e3c-491a-b525-3c2bb4257301.png?alt=media&token=3bb2cddc-9324-4d35-b275-abe5912beb3b');
            background-size: cover;
            background-position: center;
        }
        
        #event-buttons {
            display: flex;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        #start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F58982D29-A33E-42F0-AA85-E4239C882FF9.png?alt=media&token=a8eb47d3-9537-442d-b08e-a7d740c81c57');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            /* Fallback color if image fails to load */
            background-color: rgba(0, 0, 0, 0.8); 
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }
        
        #menu-container {
            width: 90%;
            max-width: 500px;
            background-color: rgba(51, 51, 51, 0.85);
            /* border-radius: 15px; */
            padding: 20px;
            text-align: center;
            color: white;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            border-style: solid;
            border-width: 30px;
            border-image-source: url('https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F0F6CE608-7672-4AF9-81A2-114C2FF834F8.png?alt=media&token=b2bdd63c-6499-44b3-8375-5d2a4c28dbee');
            border-image-slice: 40;
            border-image-repeat: stretch;
        }
        
        #menu-container h1 {
            margin-top: 0;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
        }
        
        #menu-container p {
            margin-bottom: 30px;
            font-size: 1.2rem;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.9);
        }
        
        .player-count-btn {
            display: inline-block;
            margin: 10px;
            width: 60px;
            height: 60px;
            font-size: 1.5rem;
            border-radius: 50%;
            background-color: rgba(76, 175, 80, 0.8);
            border: 3px solid white;
            color: white;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .player-count-btn:hover, .player-count-btn:active {
            transform: scale(1.1);
            background-color: rgba(76, 175, 80, 1);
        }
        
        #game-container {
            position: relative;
            width: 100%;
            flex-grow: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        #board-container {
            position: relative;
            width: 100%;
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            background-image: url('https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F903EF642-C564-4E6E-BF64-B3EBA2C27443.png?alt=media&token=8cae310c-4381-478e-80a8-862e933ed18f');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            touch-action: none; /* Prevent browser handling of touch gestures */
            padding: 5px; /* Reduced padding to allow more space for the board */
        }
        
        #board-wrapper {
            position: relative;
            width: 95vmin;
            height: 95vmin;
            max-width: 700px;
            max-height: 700px;
            overflow: visible; /* Allow content to extend beyond boundaries */
            transform-origin: center;
            transition: transform 0.3s ease;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            margin: 0 auto; /* Center the board wrapper */
            left: 0; /* Ensure perfect centering */
            right: 0; /* Ensure perfect centering */
        }
        
        #game-board {
            position: relative;
            width: 100%;
            height: 100%;
            background-image: url('https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2FC704317E-E69B-496A-BD94-5AB327EC05C4.png?alt=media&token=8f1b70fe-489d-4a0b-8550-3febfc084e29');
            background-size: contain; /* Aspect fit */
            background-repeat: no-repeat;
            background-position: center;
            background-color: #222; /* Fallback color if image is transparent or doesn't cover */
            display: grid;
            grid-template-columns: repeat(16, 1fr);
            grid-template-rows: repeat(16, 1fr);
            gap: 6px; /* Slightly reduced gap to allow for larger cells */
            padding: 6px; /* Slightly reduced padding to allow for larger cells */
            overflow: visible;
            transform-origin: center;
            box-sizing: border-box;
        }
        
        #zoom-controls {
            position: absolute;
            top: 15px; /* Changed from bottom */
            left: 15px; /* Changed from right */
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 50;
        }
        
        #zoom-controls button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            font-size: 18px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
        }
        
        .cell {
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 0px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 9px; /* Slightly larger font for better readability */
            position: relative;
            overflow: hidden;
            text-align: center;
            padding: 0; /* Removed padding to ensure images fill the cell completely */
            border: 1px solid transparent;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            aspect-ratio: 1/1;
            margin: 0;
            transition: transform 0.2s, box-shadow 0.2s;
            box-sizing: border-box; /* Ensure padding doesn't affect size */
        }
        
        .cell:hover {
            transform: scale(1.05);
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
            z-index: 5;
        }
        
        .cell.era-ancient { background-color: rgba(255, 224, 130, 0.8); }
        .cell.era-dark { background-color: rgba(144, 202, 249, 0.8); }
        .cell.era-kings { background-color: rgba(179, 157, 219, 0.8); }
        .cell.era-industrial { background-color: rgba(239, 154, 154, 0.8); }
        .cell.era-nirvana { background-color: rgba(248, 187, 208, 0.8); }
        
        .player-token {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            z-index: 20; /* Increased z-index to appear above board tiles */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: white;
            font-size: 6px;
            border: 1px solid white;
            animation: pulse 1.5s infinite;
            pointer-events: none; /* Prevent tokens from blocking cell clicks */
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            transform-origin: center;
            transition: transform 0.3s ease-out, width 0.3s ease-out, height 0.3s ease-out, box-shadow 0.3s ease-out;
            will-change: transform, left, top; /* Optimize for animations */
        }
        
        .player-token.current-player {
            width: 16px;
            height: 16px;
            box-shadow: 0 0 8px 2px rgba(255, 255, 255, 0.8);
            z-index: 21; /* Increased z-index to ensure current player is on top of other tokens */
            animation: currentPlayerPulse 1.5s infinite;
            transition: transform 0.3s ease-out, width 0.3s ease-out, height 0.3s ease-out, box-shadow 0.3s ease-out;
        }
        
        @keyframes currentPlayerPulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.9); }
            70% { box-shadow: 0 0 0 8px rgba(255, 255, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7); }
            70% { box-shadow: 0 0 0 5px rgba(255, 255, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
        }
        
        #controls {
            display: flex;
            justify-content: space-around;
            padding: 10px;
            background-color: #333;
            color: white;
        }
        
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            background-color: #4CAF50;
            color: white;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            touch-action: manipulation;
        }
        
        button:disabled {
            background-color: #cccccc;
            color: #666666;
        }
        
        #player-info {
            padding: 10px;
            background-image: url('https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F4BA9A657-FBB4-4646-BF29-47819B63007B.png?alt=media&token=826a3fef-d351-4fe1-babb-faadf5dc3ead');
            background-size: cover;
            background-position: center;
            color: white;
            display: flex;
            justify-content: center;  /* Changed from space-between */
            gap: 10px;               /* Added for spacing */
            flex-wrap: wrap;
        }
        
        .player-stats {
            margin: 5px;
            padding: 8px;
            border-radius: 5px;
            /* flex: 1; */ /* Removed to prevent excessive stretching */
            width: 250px; /* Fixed width for consistent size */
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .treasures-list {
            font-size: 0.8em;
            margin-top: 5px;
            max-height: 60px;
            overflow-y: auto;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            padding: 3px;
        }
        
        #event-display {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            /* border-radius: 10px; */
            z-index: 100;
            max-width: 80%;
            display: none;
            border-style: solid;
            border-width: 30px;
            border-image-source: url('https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F0F6CE608-7672-4AF9-81A2-114C2FF834F8.png?alt=media&token=b2bdd63c-6499-44b3-8375-5d2a4c28dbee');
            border-image-slice: 40;
            border-image-repeat: stretch;
        }
        
        #toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 5px;
            z-index: 100;
            display: none;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            font-weight: bold;
            max-width: 80%;
            text-align: center;
        }
        
        #inventory {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px;
            display: none;
            z-index: 50;
            /* border-radius: 10px; */
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            overflow-y: auto;
            border-style: solid;
            border-width: 30px;
            border-image-source: url('https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F0F6CE608-7672-4AF9-81A2-114C2FF834F8.png?alt=media&token=b2bdd63c-6499-44b3-8375-5d2a4c28dbee');
            border-image-slice: 40;
            border-image-repeat: stretch;
        }
        
        .inventory-item {
            display: block;
            margin: 8px 0;
            padding: 8px;
            background-color: #555;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.1s;
        }
        
        .inventory-item:hover {
            transform: scale(1.02);
            background-color: #666;
        }
        
        #dice-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 10px;
            height: 60px;
        }
        
        .dice {
            position: relative;
            width: 50px;
            height: 50px;
            margin: 0 5px;
            transform-style: preserve-3d;
            transition: transform 1.5s ease-out;
        }
        
        .dice-face {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 2px solid #333;
            border-radius: 5px;
            background-color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
        }
        
        /* Dice face positions */
        .dice-face:nth-child(1) { transform: rotateY(0deg) translateZ(25px); }
        .dice-face:nth-child(2) { transform: rotateY(180deg) translateZ(25px); }
        .dice-face:nth-child(3) { transform: rotateX(90deg) translateZ(25px); }
        .dice-face:nth-child(4) { transform: rotateX(-90deg) translateZ(25px); }
        .dice-face:nth-child(5) { transform: rotateY(90deg) translateZ(25px); }
        .dice-face:nth-child(6) { transform: rotateY(-90deg) translateZ(25px); }
        
        /* Dice dots */
        .dot {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #333;
        }
        
        /* Dot positions for each face */
        .dice-face.face-1 .dot:nth-child(1) { top: 50%; left: 50%; transform: translate(-50%, -50%); }
        
        .dice-face.face-2 .dot:nth-child(1) { top: 25%; left: 25%; }
        .dice-face.face-2 .dot:nth-child(2) { bottom: 25%; right: 25%; }
        
        .dice-face.face-3 .dot:nth-child(1) { top: 25%; left: 25%; }
        .dice-face.face-3 .dot:nth-child(2) { top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .dice-face.face-3 .dot:nth-child(3) { bottom: 25%; right: 25%; }
        
        .dice-face.face-4 .dot:nth-child(1) { top: 25%; left: 25%; }
        .dice-face.face-4 .dot:nth-child(2) { top: 25%; right: 25%; }
        .dice-face.face-4 .dot:nth-child(3) { bottom: 25%; left: 25%; }
        .dice-face.face-4 .dot:nth-child(4) { bottom: 25%; right: 25%; }
        
        .dice-face.face-5 .dot:nth-child(1) { top: 25%; left: 25%; }
        .dice-face.face-5 .dot:nth-child(2) { top: 25%; right: 25%; }
        .dice-face.face-5 .dot:nth-child(3) { top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .dice-face.face-5 .dot:nth-child(4) { bottom: 25%; left: 25%; }
        .dice-face.face-5 .dot:nth-child(5) { bottom: 25%; right: 25%; }
        
        .dice-face.face-6 .dot:nth-child(1) { top: 25%; left: 25%; }
        .dice-face.face-6 .dot:nth-child(2) { top: 25%; right: 25%; }
        .dice-face.face-6 .dot:nth-child(3) { top: 50%; left: 25%; }
        .dice-face.face-6 .dot:nth-child(4) { top: 50%; right: 25%; }
        .dice-face.face-6 .dot:nth-child(5) { bottom: 25%; left: 25%; }
        .dice-face.face-6 .dot:nth-child(6) { bottom: 25%; right: 25%; }
        
        #dice-total {
            font-size: 18px;
            margin-left: 10px;
            font-weight: bold;
            color: white;
        }
        
        .karmic-level {
            display: inline-block;
            margin-left: 5px;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 0.8em;
            background-color: gold;
            color: black;
        }
        
        #rules-button {
            position: fixed;
            bottom: 10px;
            right: 10px;
            z-index: 50;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            cursor: pointer;
        }
        
        #rules-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 20px;
            /* border-radius: 10px; */
            z-index: 150;
            display: none;
            overflow-y: auto;
            border-style: solid;
            border-width: 30px;
            border-image-source: url('https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F0F6CE608-7672-4AF9-81A2-114C2FF834F8.png?alt=media&token=b2bdd63c-6499-44b3-8375-5d2a4c28dbee');
            border-image-slice: 40;
            border-image-repeat: stretch;
        }
    </style>
</head>
<body>
  <!-- Start Screen Main Menu -->
<div id="start-screen">
  <div id="menu-container">
    <h1>ReinKarma</h1>
    <p>A journey through past lives to reach Nirvana. How many players?</p>
    <div>
      <!-- Local game player count buttons -->
      <button class="player-count-btn" data-players="1">1</button>
      <button class="player-count-btn" data-players="2">2</button>
      <button class="player-count-btn" data-players="3">3</button>
      <button class="player-count-btn" data-players="4">4</button>
      <button class="player-count-btn" data-players="5">5</button>
      <br><br>
      <!-- Start online multiplayer button -->
      <button id="start-multiplayer-button" style="margin-top: 15px; padding: 12px 20px; font-size: 1.2rem; color: white; background-color: #4CAF50; border: 3px solid white; cursor: pointer;">
        Start Multiplayer
      </button>
    </div>
  </div>
</div>
<!-- Multiplayer Setup Modal (choose number of players) -->
<div id="multiplayer-setup-screen" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(0,0,0,0.85); color: white; padding: 25px; text-align: center; width: 400px; max-width: 80%; z-index: 200; border-style: solid; border-width: 30px; border-image-source: url('https://firebasestorage.googleapis.com/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F0F6CE608-7672-4AF9-81A2-114C2FF834F8.png?alt=media&token=b2bdd63c-6499-44b3-8375-5d2a4c28dbee'); border-image-slice: 40; border-image-repeat: stretch; box-shadow: 0 0 25px rgba(0,0,0,0.6);">
  <h2>Multiplayer Setup</h2>
  <p>Select total number of players (including you):</p>
  <div>
    <button class="player-count-btn" data-players="2">2</button>
    <button class="player-count-btn" data-players="3">3</button>
    <button class="player-count-btn" data-players="4">4</button>
    <button class="player-count-btn" data-players="5">5</button>
  </div>
</div>
<!-- Multiplayer Lobby Modal -->
<div id="lobby-screen" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(0,0,0,0.85); color: white; padding: 25px; text-align: center; width: 400px; max-width: 80%; z-index: 200; border-style: solid; border-width: 30px; border-image-source: url('https://firebasestorage.googleapis.com/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F0F6CE608-7672-4AF9-81A2-114C2FF834F8.png?alt=media&token=b2bdd63c-6499-44b3-8375-5d2a4c28dbee'); border-image-slice: 40; border-image-repeat: stretch; box-shadow: 0 0 25px rgba(0,0,0,0.6);">
  <h2>Lobby</h2>
  <p id="lobby-message">Waiting for other players to join...</p>
  <div id="player-list" style="margin: 15px 0;"></div>
  <p id="lobby-count">0/0 players connected</p>
  <button id="start-game-button" style="display: none; padding: 12px 20px; font-size: 1.1rem;" disabled>Start Game</button>
</div>
    <!-- Name Entry Modal for joining players -->
<div id="name-entry-modal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(0,0,0,0.85); color: white; padding: 20px; text-align: center; width: 300px; max-width: 80%; z-index: 300; border-style: solid; border-width: 30px; border-image-source: url('https://firebasestorage.googleapis.com/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F0F6CE608-7672-4AF9-81A2-114C2FF834F8.png?alt=media&token=b2bdd63c-6499-44b3-8375-5d2a4c28dbee'); border-image-slice: 40; border-image-repeat: stretch; box-shadow: 0 0 25px rgba(0,0,0,0.6);">
  <h2>Join Game</h2>
  <p>Enter your name to join:</p>
  <input type="text" id="player-name-input" style="width: 80%; padding: 5px; margin-bottom: 15px;" placeholder="Your name">
  <br>
  <button id="name-submit-button" style="padding: 8px 15px; font-size: 1rem; background-color: #4CAF50; color: white; border: none; cursor: pointer;">
    Join Game
  </button>
</div>
            
    <div id="game-container">
        <div id="player-info"></div>
        
        <div id="board-container">
            <div id="board-wrapper">
                <div id="game-board"></div>
                
            </div>
            <div id="zoom-controls">
                <button id="zoom-in">+</button>
                <button id="zoom-reset">‚ü≤</button>
                <button id="zoom-out">-</button>
            </div>
        </div>
      <div id="your-turn-indicator" style="display: none; color: yellow; font-size: 1.2rem; margin-bottom: 10px;">
  üîÅ Your Turn!
</div>  
        <div id="controls">
            <button id="roll-button">Roll Dice</button>
            <div id="dice-container">
                <div class="dice" id="dice1">
                    <div class="dice-face face-1">
                        <div class="dot"></div>
                    </div>
                    <div class="dice-face face-2">
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                    <div class="dice-face face-3">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                    <div class="dice-face face-4">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                    <div class="dice-face face-5">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                    <div class="dice-face face-6">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                </div>
                <div class="dice" id="dice2">
                    <div class="dice-face face-1">
                        <div class="dot"></div>
                    </div>
                    <div class="dice-face face-2">
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                    <div class="dice-face face-3">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                    <div class="dice-face face-4">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                    <div class="dice-face face-5">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                    <div class="dice-face face-6">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                </div>
                <div id="dice-total"></div>
            </div>
            <button id="inventory-button">Inventory</button>
        </div>
    </div>
    
    <div id="event-display">
        <h3 id="event-title"></h3>
        <p id="event-description"></p>
        <div id="event-buttons">
            <button id="event-button">OK</button>
        </div>
    </div>
    
    <div id="cell-modal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(0, 0, 0, 0.8); color: white; padding: 20px; /* border-radius: 10px; */ z-index: 150; max-width: 80%; border-style: solid; border-width: 30px; border-image-source: url('https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F0F6CE608-7672-4AF9-81A2-114C2FF834F8.png?alt=media&token=b2bdd63c-6499-44b3-8375-5d2a4c28dbee'); border-image-slice: 40; border-image-repeat: stretch;">
        <h3 id="cell-title"></h3>
        <p id="cell-description"></p>
        <p id="cell-era"></p>
        <button id="cell-close-button">Close</button>
    </div>
    
    <div id="item-modal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(0, 0, 0, 0.8); color: white; padding: 20px; border-radius: 10px; z-index: 150; max-width: 80%;">
        <h3 id="item-title"></h3>
        <p id="item-description"></p>
        <button id="item-close-button">Close</button>
    </div>
    
    <div id="toast"></div>
    
    <div id="treasure-flash" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 200;">
        <img src="https://firebasestorage.googleapis.com/v0/b/sticky-20bca.appspot.com/o/sgm-asset%2Fb91e8e4f-b357-4c10-8d6d-283275e4ae1d%2Fa8ea7e74-ff0d-407a-8c1a-7841bede785c.png?alt=media&token=71649277-f913-4d88-8e9e-e1d31a8a5156" alt="Treasure Chest" style="width: 150px; height: auto; object-fit: contain;">
    </div>

    <div id="sudden-death-flash" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 201;">
        <img src="https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F68456DF2-77E9-43D7-8AD8-121435CBE93B.png?alt=media&token=961fed9d-bd59-4d1a-8375-fb3c7de97a0d" alt="Sudden Death" style="width: 150px; height: auto; object-fit: contain;">
    </div>

    <div id="vengeance-flash" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 201;">
        <img src="https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2FF4FC172A-113E-41F6-8534-349F233A7537.png?alt=media&token=be5ab9bf-3312-443d-9a38-a6d1d05d1b72" alt="Vengeance" style="width: 150px; height: auto; object-fit: contain;">
    </div>

    <div id="barter-flash" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 201;">
        <img src="https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F6D9CD3AC-DB0E-4A4E-B6E4-770AFB8A4148.png?alt=media&token=d2d1a328-84e6-4c3c-9880-f7faed22950a" alt="Barter" style="width: 150px; height: auto; object-fit: contain;">
    </div>

    <div id="twist-flash" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 201;">
        <img src="https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2FC264838E-B352-4B6F-90FE-4F7A4AD509DF.png?alt=media&token=16c1d136-27cc-4cfd-a9d4-bf0af6d4f08a" alt="Twist" style="width: 150px; height: auto; object-fit: contain;">
    </div>
    
    <div id="robbery-flash" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 201;">
        <img src="https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2FAAA4EB8C-2489-41F3-BD7F-D600AC43C9D7.png?alt=media&token=cd0735b3-4f85-497a-b887-127193f302f4" alt="Robbery" style="width: 150px; height: auto; object-fit: contain;">
    </div>
    
    <div id="select-inventory-modal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(0, 0, 0, 0.9); color: white; padding: 20px; z-index: 160; max-width: 80%; border-style: solid; border-width: 30px; border-image-source: url('https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F0F6CE608-7672-4AF9-81A2-114C2FF834F8.png?alt=media&token=b2bdd63c-6499-44b3-8375-5d2a4c28dbee'); border-image-slice: 40; border-image-repeat: stretch;">
        <h3>View Inventory For:</h3>
        <div id="select-inventory-player-buttons" style="margin-bottom: 15px; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;">
            <!-- Player buttons will be dynamically added here -->
        </div>
        <button id="close-select-inventory-modal-button" style="background-color: #f44336;">Cancel</button>
    </div>

    <div id="inventory">
        <h3>Inventory</h3>
        <div id="inventory-items"></div>
        <button id="close-inventory">Close</button>
    </div>
    
    <div id="rules-button">?</div>
    
    <div id="rules-modal">
        <h2>ReinKarma ‚Äî Game Instructions</h2>
        
        <h3>OBJECTIVE</h3>
        <p>Accumulate treasure and karma across multiple past lives. Reach Nirvana (square 160) and finish the game with the highest credit total to win.</p>
        
        <h3>HOW TO WIN</h3>
        <ul>
            <li>The first player to reach Nirvana (square 160) ends the game.</li>
            <li>Once Nirvana is reached, all players' final scores are tallied:</li>
            <li>Total value of treasure cards</li>
            <li>Remaining credits</li>
            <li>Karmic Levels achieved (each one banks 3,000 credits at the cost of 3,000 credits)</li>
        </ul>
        
        <h3>TURN SEQUENCE</h3>
        <ol>
            <li>Roll the dice to begin your turn.</li>
            <li>Move your token the number of spaces rolled.</li>
            <li>Take the action listed on the square you land on.</li>
            <li>If instructed to "roll again," repeat step 1.</li>
        </ol>
        
        <h3>KARMIC LEVELS</h3>
        <p>As you accumulate wealth, you progress spiritually.</p>
        <ul>
            <li>When a player's combined total of credits and treasure value reaches 3,000, they are prompted: "Would you like to ascend to the next Karmic Level?"</li>
            <li>If they say yes:</li>
            <li>3,000 worth of combined credits and treasures are deducted</li>
            <li>One level is locked in</li>
            <li>The player banks 3,000 credits that cannot be lost</li>
            <li>There is no bonus for karmic levels ‚Äî only the locked-in value.</li>
        </ul>
        
        <p>Karmic Levels (in order):</p>
        <ol>
            <li>Scum of the Earth</li>
            <li>Common Place</li>
            <li>Heroes and Heroines</li>
            <li>Greats and Saints</li>
        </ol>
        
        <h3>SQUARE TYPES & ACTIONS</h3>
        <table style="width:100%; border-collapse: collapse; margin-top: 10px;">
            <tr style="border-bottom: 1px solid white;">
                <th style="text-align: left; padding: 5px;">Square</th>
                <th style="text-align: left; padding: 5px;">Action Description</th>
            </tr>
            <tr style="border-bottom: 1px solid rgba(255,255,255,0.2);">
                <td style="padding: 5px;">Start</td>
                <td style="padding: 5px;">Where all players begin.</td>
            </tr>
            <tr style="border-bottom: 1px solid rgba(255,255,255,0.2);">
                <td style="padding: 5px;">Title</td>
                <td style="padding: 5px;">Gain 200 credits. Option to buy insurance.</td>
            </tr>
            <tr style="border-bottom: 1px solid rgba(255,255,255,0.2);">
                <td style="padding: 5px;">Treasure</td>
                <td style="padding: 5px;">Pay 200 credits to draw a Treasure Card.</td>
            </tr>
            <tr style="border-bottom: 1px solid rgba(255,255,255,0.2);">
                <td style="padding: 5px;">Major Treasure</td>
                <td style="padding: 5px;">Free! Draw a high-value treasure card. One per era.</td>
            </tr>
            <tr style="border-bottom: 1px solid rgba(255,255,255,0.2);">
                <td style="padding: 5px;">Twist of Fate</td>
                <td style="padding: 5px;">Draw a random event card ‚Äî good, bad, or wild.</td>
            </tr>
            <tr style="border-bottom: 1px solid rgba(255,255,255,0.2);">
                <td style="padding: 5px;">Gamble</td>
                <td style="padding: 5px;">Roll for a reward, penalty, or trade.</td>
            </tr>
            <tr style="border-bottom: 1px solid rgba(255,255,255,0.2);">
                <td style="padding: 5px;">Barter</td>
                <td style="padding: 5px;">Trade a treasure card for a random one from the deck.</td>
            </tr>
            <tr style="border-bottom: 1px solid rgba(255,255,255,0.2);">
                <td style="padding: 5px;">Robbery</td>
                <td style="padding: 5px;">Choose a player. Steal one treasure face-down.</td>
            </tr>
            <tr style="border-bottom: 1px solid rgba(255,255,255,0.2);">
                <td style="padding: 5px;">Vengeance</td>
                <td style="padding: 5px;">Take 200 credits from another player.</td>
            </tr>
            <tr style="border-bottom: 1px solid rgba(255,255,255,0.2);">
                <td style="padding: 5px;">Evil Eye</td>
                <td style="padding: 5px;">Duel another player for a treasure. Cannot be targeted if they have Protection.</td>
            </tr>
            <tr style="border-bottom: 1px solid rgba(255,255,255,0.2);">
                <td style="padding: 5px;">Time Portal</td>
                <td style="padding: 5px;">Jump forward or backward to another square in a different era.</td>
            </tr>
            <tr style="border-bottom: 1px solid rgba(255,255,255,0.2);">
                <td style="padding: 5px;">Lucky Day</td>
                <td style="padding: 5px;">Roll again. Move forward or backward, your choice. Gain 100 credits.</td>
            </tr>
            <tr style="border-bottom: 1px solid rgba(255,255,255,0.2);">
                <td style="padding: 5px;">Roll Again</td>
                <td style="padding: 5px;">Roll the dice again immediately.</td>
            </tr>
            <tr style="border-bottom: 1px solid rgba(255,255,255,0.2);">
                <td style="padding: 5px;">Charity</td>
                <td style="padding: 5px;">Collect all treasures and credits lost by others due to Sudden Death.</td>
            </tr>
            <tr style="border-bottom: 1px solid rgba(255,255,255,0.2);">
                <td style="padding: 5px;">Hazard / Lose a Turn</td>
                <td style="padding: 5px;">Miss your next turn. Found before/after Major Treasures.</td>
            </tr>
            <tr style="border-bottom: 1px solid rgba(255,255,255,0.2);">
                <td style="padding: 5px;">Sudden Death</td>
                <td style="padding: 5px;">Lose everything (credits and treasures) unless you have insurance.</td>
            </tr>
            <tr style="border-bottom: 1px solid rgba(255,255,255,0.2);">
                <td style="padding: 5px;">Nirvana</td>
                <td style="padding: 5px;">End the game for everyone. Trigger final score count.</td>
            </tr>
        </table>
        
        <h3>CREDITS & TREASURES</h3>
        <ul>
            <li>You start with 1,500 credits.</li>
            <li>You use credits to:</li>
            <li>Buy treasures</li>
            <li>Gamble</li>
            <li>Advance karmic levels</li>
            <li>Treasures are secret until revealed.</li>
            <li>Treasures are worth 0 to 500 credits.</li>
            <li>Major Treasures are the most valuable and free.</li>
        </ul>
        
        <h3>INSURANCE</h3>
        <ul>
            <li>Offered after each Title square.</li>
            <li>Protects against Sudden Death.</li>
        </ul>
        
        <button id="close-rules">Close Rules</button>
    </div>

    <div id="past-life-modal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(0, 0, 0, 0.92); color: white; padding: 25px; z-index: 250; max-width: 90%; width: 600px; max-height: 85vh; overflow-y: auto; border-style: solid; border-width: 30px; border-image-source: url('https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F0F6CE608-7672-4AF9-81A2-114C2FF834F8.png?alt=media&token=b2bdd63c-6499-44b3-8375-5d2a4c28dbee'); border-image-slice: 40; border-image-repeat: stretch; text-align: center;">
        <h3 id="past-life-player-name" style="margin-top: 0; margin-bottom: 5px; font-size: 1.6rem;"></h3>
        <h4 id="past-life-karmic-level" style="margin-top: 0; margin-bottom: 5px; font-size: 1.2rem; color: #ffd700;"></h4>
        <p id="past-life-score-info" style="margin-top: 0; margin-bottom: 15px; font-size: 1rem;"></p>
        <hr style="border-color: rgba(255,255,255,0.3); margin-bottom:15px;">
        <p id="past-life-text" style="white-space: pre-wrap; text-align: left; font-size: 0.95rem; line-height: 1.5; margin-bottom: 10px;"></p>
        <h5 id="past-life-title" style="font-style: italic; font-size: 1.1rem; margin-top: 15px; margin-bottom: 20px;"></h5>
        <button id="next-past-life-button" style="padding: 12px 20px; font-size: 1rem;">Next Player</button>
    </div>

    <div id="turn-transition-modal">
        <h3 id="turn-transition-player-name"></h3>
        <p id="turn-transition-message">It's your turn!</p>
        <button id="turn-transition-ok-button">Start Turn</button>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
        // Initialize sound effects using Howler.js
        // Set HTML5 Audio as the preferred method for iOS compatibility, especially for consistent behavior.
        Howler.html5 = true; // Global setting for Howler to use HTML5 Audio.

        function generateGameId() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let id = '';
  for (let i = 0; i < 6; i++) {
    id += chars[Math.floor(Math.random() * chars.length)];
  }
  return id;
}

function generateClientId() {
  return 'client-' + Math.random().toString(36).substr(2, 9);
}

// üî• Initialize Firebase
const firebaseConfig = {
  apiKey: "AIzaSyBJXHRD2xs75a7icYk8Njygc30LhZFdjtY",
  authDomain: "reinkarma-be704.firebaseapp.com",
  databaseURL: "https://reinkarma-be704-default-rtdb.firebaseio.com",
  projectId: "reinkarma-be704",
  storageBucket: "reinkarma-be704.firebasestorage.app",
  messagingSenderId: "622953179983",
  appId: "1:622953179983:web:61fe806b729e82ef29733a"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
// Check if joining an existing game via URL
const urlParams = new URLSearchParams(window.location.search);
const joinGameId = urlParams.get("game");

if (joinGameId) {
  // Joining as a client: hide other screens and prompt for name
  window.currentGameId = joinGameId;
  window.localPlayerId = generateClientId();
  // Hide all other sections while waiting for name
  document.getElementById("start-screen").style.display = "none";
  document.getElementById("multiplayer-setup-screen").style.display = "none";
  document.getElementById("lobby-screen").style.display = "none";
  // Show name entry modal for the joiner
  document.getElementById("name-entry-modal").style.display = "block";

  // When the joiner submits their name, add them to the game
  const nameInput = document.getElementById("player-name-input");
  const submitNameBtn = document.getElementById("name-submit-button");
  // Allow pressing Enter to submit name
  nameInput.addEventListener("keydown", e => {
    if (e.key === "Enter") submitNameBtn.click();
  });
  submitNameBtn.onclick = () => {
    const playerName = nameInput.value.trim();
    if (!playerName) {
      alert("Please enter your name to join the game.");
      return;
    }
    // Fetch game data to confirm it exists and get player count
    db.ref(`/games/${joinGameId}`).once("value").then(snapshot => {
      if (!snapshot.exists()) {
        alert("Game not found or no longer available.");
        // Hide name modal and show start screen again
        document.getElementById("name-entry-modal").style.display = "none";
        document.getElementById("start-screen").style.display = "block";
        return;
      }
      const gameData = snapshot.val();
      console.log("Joining game:", joinGameId, gameData);
      // If rejoining as host (same ID), show Start Game button (edge case)
      if (window.localPlayerId === gameData.hostId) {
        document.getElementById("start-game-button").style.display = "inline-block";
      }
      // Prepare new player object (with token color assignment)
      const playersSoFar = gameData.state.players || {};
      const colorList = ["red", "blue", "green", "orange", "magenta"];
      const playerIndex = Object.keys(playersSoFar).length;  // how many already in game
      const assignedColor = colorList[playerIndex] || "white";
      const newPlayer = {
        id: window.localPlayerId,
        name: playerName,
        tokenColor: assignedColor,
        inventory: [],
        position: 0,
        credits: 0,
        isAI: false
      };
      // Add this player to the game's player list in Firebase
      db.ref(`/games/${joinGameId}/state/players/${window.localPlayerId}`)
        .set(newPlayer)
        .then(() => {
          console.log("Player added:", newPlayer);
          // Hide name entry modal and show the lobby
          document.getElementById("name-entry-modal").style.display = "none";
          document.getElementById("lobby-screen").style.display = "block";
          // Real-time update of lobby player list for this joiner
          const playerListDiv = document.getElementById("player-list");
          const lobbyCountText = document.getElementById("lobby-count");
          const totalPlayers = gameData.playerCount;
          db.ref(`/games/${joinGameId}/state/players`).on("value", snapshot => {
            const players = snapshot.val() || {};
            playerListDiv.innerHTML = "";
            let count = 0;
            Object.values(players).forEach(player => {
              count++;
              // Display a colored token dot and the player's name and ID
              const entry = document.createElement("div");
              entry.innerHTML = `<span style="color:${player.tokenColor};">&#x25CF;</span> ${player.name} (${player.id})`;
              playerListDiv.appendChild(entry);
            });
            // Update player count display (e.g., "3/5 players connected")
            lobbyCountText.textContent = `${count}/${totalPlayers} players connected`;
          }, error => {
            console.error("Players list read failed:", error);
            alert("Connection lost. Please refresh the page.");
          });
          // Listen for game start signal to transition to the game board
          db.ref(`/games/${joinGameId}/state/started`).on("value", snapshot => {
            if (snapshot.val() === true) {
              console.log("Game started signal received (joiner)!");
              // Hide lobby and any start screens, show game board
              document.getElementById("start-game-button").style.display = "none";
              document.getElementById("lobby-screen").style.display = "none";
              document.getElementById("start-screen").style.display = "none";
              document.getElementById("multiplayer-setup-screen").style.display = "none";
              document.getElementById("game-container").style.display = "block";
              // Stop any start-screen music once game begins
              if (sounds.startScreen && sounds.startScreen.playing()) {
                sounds.startScreen.stop();
              }
              // Handle turn transitions: show turn modal only to the current player
              db.ref(`/games/${joinGameId}/state/currentPlayerIndex`).on("value", snap => {
                const index = snap.val();
                if (index === null) return;
                // Get current player's details
                db.ref(`/games/${joinGameId}/state/players`).once("value").then(playerSnap => {
                  const players = playerSnap.val() || {};
                  const playerArray = Object.values(players);
                  const currentPlayer = playerArray[index];
                  if (currentPlayer && currentPlayer.id === window.localPlayerId) {
                    // If this client is the current player, show turn transition modal
                    turnTransitionPlayerName.textContent = `${currentPlayer.name}'s Turn`;
                    turnTransitionMessage.textContent = "It's your turn!";
                    // Enable OK button and set up click to proceed with turn
                    turnTransitionOkButton.disabled = false;
                    turnTransitionOkButton.onclick = () => {
                      turnTransitionModal.style.display = 'none';
                      // Proceed with the turn for this player (unlocks controls, etc.)
                      proceedWithTurn(currentPlayer);
                    };
                    // Display the modal (blocking screen until acknowledged)
                    turnTransitionModal.style.display = 'block';
                  } else {
                    // Not this player's turn - ensure turn modal is hidden and controls are disabled
                    turnTransitionModal.style.display = 'none';
                    rollButton.disabled = true;
                  }
                });
              }, error => {
                console.error("Turn index read failed:", error);
                alert("Connection issue during turn update. Please refresh.");
              });
            }
          }, error => {
            console.error("Started flag read failed:", error);
            alert("Connection lost. The game may have ended.");
          });
        })
        .catch(err => {
          console.error("Failed to add player:", err);
          alert("Failed to join game. Please check your connection and try again.");
        });
    });
  };
}

// Host creating a new multiplayer game
document.getElementById("start-multiplayer-button").addEventListener("click", () => {
  isMultiplayer = true;
  // Hide main start screen, show the multiplayer setup modal
  document.getElementById("start-screen").style.display = "none";
  document.getElementById("multiplayer-setup-screen").style.display = "block";
});

// Handle player count selection for both modes (local or multiplayer)
document.querySelectorAll(".player-count-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    const playerCount = parseInt(btn.getAttribute("data-players"));
    if (!isMultiplayer) {
      // Hot-seat local game setup
      setupPlayers(playerCount);
    } else {
      // Multiplayer game setup (host flow)
      const gameId = generateGameId();
      const hostId = generateClientId();
      window.currentGameId = gameId;
      window.localPlayerId = hostId;
      const hostName = getPlayerName("Enter your name:");
      // Prepare initial game data in database
      const gameData = {
        hostId: hostId,
        playerCount: playerCount,
        state: {
          players: {},
          currentPlayerIndex: 0,
          board: [],
          started: false
        }
      };
      db.ref(`/games/${gameId}`).set(gameData).then(() => {
        // Add host player to the game state
        const colorList = ["red", "blue", "green", "orange", "magenta"];
        const hostPlayer = {
          id: hostId,
          name: hostName || "Host",  // default name if none entered
          tokenColor: colorList[0],
          inventory: [],
          position: 0,
          credits: 0,
          isAI: false
        };
        return db.ref(`/games/${gameId}/state/players/${hostId}`).set(hostPlayer);
      }).then(() => {
        console.log("Multiplayer game created:", gameId);
        // Show the lobby for the host
        document.getElementById("multiplayer-setup-screen").style.display = "none";
        document.getElementById("lobby-screen").style.display = "block";
        // Host sees the Start Game button (disabled until ready)
        const startGameBtn = document.getElementById("start-game-button");
        startGameBtn.style.display = "inline-block";
        startGameBtn.disabled = true;
        // Real-time update of lobby player list for the host
        const playerListDiv = document.getElementById("player-list");
        const lobbyCountText = document.getElementById("lobby-count");
        const totalPlayers = playerCount;
        db.ref(`/games/${gameId}/state/players`).on("value", snapshot => {
          const players = snapshot.val() || {};
          playerListDiv.innerHTML = "";
          let count = 0;
          Object.values(players).forEach(player => {
            count++;
            const entry = document.createElement("div");
            entry.innerHTML = `<span style="color:${player.tokenColor};">&#x25CF;</span> ${player.name} (${player.id})`;
            playerListDiv.appendChild(entry);
          });
          // Update count and enable Start Game when all players are present
          lobbyCountText.textContent = `${count}/${totalPlayers} players connected`;
          if (count >= totalPlayers) {
            startGameBtn.disabled = false;  // all players have joined, host can start
          } else {
            startGameBtn.disabled = true;
          }
        }, error => {
          console.error("Players list read failed:", error);
          alert("Connection lost. Please check your internet connection.");
        });
        // Listen for game start signal to transition everyone to game board
        db.ref(`/games/${gameId}/state/started`).on("value", snapshot => {
          if (snapshot.val() === true) {
            console.log("Game started signal received (host)!");
            document.getElementById("start-game-button").style.display = "none";
            document.getElementById("lobby-screen").style.display = "none";
            document.getElementById("start-screen").style.display = "none";
            document.getElementById("multiplayer-setup-screen").style.display = "none";
            document.getElementById("game-container").style.display = "block";
            // Stop menu music as the game begins
            if (sounds.startScreen && sounds.startScreen.playing()) {
              sounds.startScreen.stop();
            }
            // Turn management: show turn modal only to current player
            db.ref(`/games/${gameId}/state/currentPlayerIndex`).on("value", snap => {
              const index = snap.val();
              if (index === null) return;
              db.ref(`/games/${gameId}/state/players`).once("value").then(playerSnap => {
                const players = playerSnap.val() || {};
                const playerArray = Object.values(players);
                const currentPlayer = playerArray[index];
                if (currentPlayer && currentPlayer.id === window.localPlayerId) {
                  // Current player's turn on this device
                  turnTransitionPlayerName.textContent = `${currentPlayer.name}'s Turn`;
                  turnTransitionMessage.textContent = "It's your turn!";
                  turnTransitionOkButton.disabled = false;
                  turnTransitionOkButton.onclick = () => {
                    turnTransitionModal.style.display = 'none';
                    proceedWithTurn(currentPlayer);
                  };
                  turnTransitionModal.style.display = 'block';
                } else {
                  // Not this player's turn
                  turnTransitionModal.style.display = 'none';
                  rollButton.disabled = true;
                }
              });
            }, error => {
              console.error("Turn index read failed:", error);
              alert("Network error during turn update. Please refresh the game if issues persist.");
            });
          }
        }, error => {
          console.error("Started flag read failed:", error);
          alert("Game session error or disconnect.");
        });
        // Show shareable link for others to join (modal dialog)
        const joinLink = `${window.location.origin}?game=${gameId}`;
        const linkModal = document.createElement("div");
        linkModal.innerHTML = `
          <div style="position: fixed; top: 20%; left: 50%; transform: translateX(-50%); background: #222; color: white; padding: 20px; border: 2px solid #888; z-index: 1000; text-align: center; width: 300px; border-radius: 10px;">
            <p><strong>Multiplayer Game Ready!</strong><br>Share this link:</p>
            <input type="text" value="${joinLink}" readonly style="width: 100%; padding: 5px; margin-bottom: 10px;" id="game-link-input">
            <button id="copy-link-btn" style="padding: 5px 15px; margin-right: 10px;">Copy Link</button>
            <button id="close-link-modal" style="padding: 5px 15px;">Close</button>
          </div>
        `;
        document.body.appendChild(linkModal);
        document.getElementById("copy-link-btn").onclick = () => {
          const input = document.getElementById("game-link-input");
          input.select();
          input.setSelectionRange(0, 99999);
          navigator.clipboard.writeText(input.value);
          alert("Link copied to clipboard!");
        };
        document.getElementById("close-link-modal").onclick = () => {
          linkModal.remove();
        };
      }).catch(err => {
        console.error("Failed to create multiplayer game:", err);
        alert("Failed to start multiplayer game. Please check your connection and try again.");
      });
    }
  });
});

// Host clicks "Start Game" (begin game when all players are ready)
document.getElementById("start-game-button").addEventListener("click", () => {
  // Only allow if all players have joined (button is enabled)
  db.ref(`/games/${window.currentGameId}/state/started`).set(true).then(() => {
    console.log("Game started by host.");
  }).catch(err => {
    console.error("Failed to start game:", err);
    alert("Error starting the game. Please try again.");
  });
});

        const sounds = {
            evilEye: new Howl({
                src: ['https://firebasestorage.googleapis.com/v0/b/sticky-20bca.appspot.com/o/sgm-asset%2F8e83c21b-7e79-4db8-8885-ff3e3fb49a75%2F14669546-e921-49cd-be52-928f871d97db.mp3?alt=media&token=477c62ac-d2ed-4782-8621-c2a0cbe4bb09'],
                html5: true,
                loop: false,
                volume: 1.0
            }),
            suddenDeath: new Howl({
                src: ['https://firebasestorage.googleapis.com/v0/b/sticky-20bca.appspot.com/o/sgm-asset%2Fb4a0eef9-6f88-4588-b789-b6de17c843dc%2Fcode.mp3?alt=media&token=b7c60b10-f554-4cf5-8f29-d38bca993be8'],
                html5: true,
                loop: false,
                volume: 1.0
            }),
            twistOfFate: new Howl({
                src: ['https://firebasestorage.googleapis.com/v0/b/sticky-20bca.appspot.com/o/sgm-asset%2F0a6025d1-a19e-4d57-94c1-99642db8cc10%2F7b79f0c8-fd41-4041-ae4a-0b175cc4b6ce.mp3?alt=media&token=d4149beb-332c-44b8-a178-e3fa81d39a9f'],
                loop: true,
                html5: true,
                volume: 1.0
            }),
            interaction: new Howl({ // Used for Robbery, Barter, Vengeance
                src: ['https://firebasestorage.googleapis.com/v0/b/sticky-20bca.appspot.com/o/sgm-asset%2Fc3b08965-1496-4bdd-8f5b-115ac7b316b1%2F1f14cd1f-0091-4190-9d48-e46b9280185c.mp3?alt=media&token=55deef6f-ecbb-4f95-82be-07f5d2b4e370'],
                loop: false,
                html5: true,
                volume: 1.0
            }),
            startScreen: new Howl({
                src: ['https://firebasestorage.googleapis.com/v0/b/sticky-20bca.appspot.com/o/sgm-asset%2F5628a970-eb35-454a-af08-b8e77fc85ee3%2Faec37451-81b3-4e72-9852-3acc71f2be70.mp3?alt=media&token=ebcc486a-0f7b-40db-8ca1-d7180ed3b11f'],
                loop: true,
                volume: 0.7,
                html5: true,
                preload: true,
                autoplay: false
            }),
            nirvanaReached: new Howl({
                src: ['https://firebasestorage.googleapis.com/v0/b/sticky-20bca.appspot.com/o/sgm-asset%2Fe44fa3f6-509a-45ff-bb2b-1fd07c34aa7a%2F1224cdf4-ee0a-462d-88a3-5cb0606f94fb.mp3?alt=media&token=df760491-2c11-4400-a43c-59e1e3b7504f'],
                html5: true,
                loop: false,
                volume: 1.0
            }),
            timePortalEffect: new Howl({
                src: ['https://firebasestorage.googleapis.com/v0/b/sticky-20bca.appspot.com/o/sgm-asset%2Fd307dc86-16d9-4d6d-8f2c-6472e5685235%2F4188a5f7-79dc-4b1a-8c5e-e455af25c3bb.m4a?alt=media&token=2ca4b8f5-c2db-450d-b175-9c56f91999a2'],
                html5: true,
                loop: false,
                volume: 1.0
            }),
            gambleSquareEffect: new Howl({
                src: ['https://firebasestorage.googleapis.com/v0/b/sticky-20bca.appspot.com/o/sgm-asset%2F674e5ed4-a2a3-4280-9883-3dd4a9f53690%2Fcode.mp3?alt=media&token=8b1ccbe1-7af5-4881-94b6-644e024ca8ed'],
                html5: true,
                loop: false,
                volume: 1.0
            }),
            treasureChestOpen: new Howl({
                src: ['https://firebasestorage.googleapis.com/v0/b/sticky-20bca.appspot.com/o/sgm-asset%2F19a46de9-7d8d-47b5-bac3-75c203d4e9c8%2Fcode.mp3?alt=media&token=17a34363-77fb-4704-9acb-93cb84610f3a'],
                html5: true,
                loop: false,
                volume: 1.0
            })
        };
        
        const kingsSquareImageUrls = [
  "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2FF6D471E6-3DF0-4A1F-96A3-5AB7C32CCCA4.png?alt=media&token=84913055-2b35-4692-be2d-ec6b77976ab5",
  "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F774A17B9-D5FC-442E-8A83-199E4CCE6D27.png?alt=media&token=3481cd8a-2ed6-43ae-9103-a7eb90562075",
  "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F670DDDEB-0386-44F4-8252-E6A0D48D6F70.png?alt=media&token=264ca4c5-952f-4df0-8622-c52b709e9ad8",
  "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F2A6F2B11-3F70-4563-AB2A-3A91513C82E0.png?alt=media&token=9afbaec4-950a-40d8-a40b-ffbcba3a8ea1",
  "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F6D829420-B809-4132-9606-54D36CC67B6A.png?alt=media&token=f7798a36-66b9-4ca6-bafb-0a95828f00c3",
  "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2FA64A3743-862F-4F06-824D-456D8E54219C.png?alt=media&token=33c43197-f04d-426c-9fd9-7ae005c79918",
  "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2FC54103B7-DB43-4253-BFAC-528E2D9DAE26.png?alt=media&token=902a50f6-2def-487e-a981-d5cf05e39be5",
  "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2FE6E3CE0E-E2FB-406A-A32C-F3DF7ED2C6DA.png?alt=media&token=a20d9429-1b62-4810-959a-d7a04338a3c2",
  "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F23D068D5-D84F-407C-ADA3-2F92876F33DA.png?alt=media&token=5b11b266-ee31-433b-ab79-dc16c3cc4556",
  "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F19EA7EB4-79FD-40B2-9F62-5FEABAF7FF75.png?alt=media&token=6349e568-1d03-40ee-910d-15375b703671"
];

const ancientSquareImageUrls = [
  "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F1C642D67-530F-4D79-A62F-6299633EBE7C.png?alt=media&token=430ae458-ef68-4ad8-bdd0-61c334d01e48",
  "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F5880C903-6144-4DE6-8C25-0F10FFD69FEC.png?alt=media&token=37808477-ec43-4ac7-a058-a68fbeb68237",
  "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F20D0BBFE-731F-484F-B4C7-21D419520A04.png?alt=media&token=f83e4680-6878-42b6-a1b6-459e923eebf6",
  "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2FCE713D8C-95EE-411A-BB30-6CE61E4ECF3D.png?alt=media&token=0e6b51a0-86ab-4459-9983-1339e5271762",
  "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2FB9BAC745-79F4-4AF5-935D-1335A740CA78.png?alt=media&token=3f525011-0cd7-4735-877a-91e1968285b0",
  "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F642EE89F-A677-4638-9663-6BC1593F2971.png?alt=media&token=83daf73d-d179-4d70-90cf-db4298e950f1",
  "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2FCAE9C4C7-C8B0-4529-86E2-2E946F3F4E50.png?alt=media&token=c14b82a7-c482-4dd9-bf68-365214c6e45b",
  "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F9B869EF1-5A48-4F1C-B282-469C457E335B.png?alt=media&token=a3c00026-513f-41d8-be8b-f09998faaba8",
  "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2FA9B5253D-CA2A-477A-8FB9-E62690A4E4E4.png?alt=media&token=46ae1231-6a79-4fb8-8ed4-627993cb7392",
  "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2FE0172F49-A046-4F55-8B97-478A3EF8601F.png?alt=media&token=89c9962b-4d63-45be-ad02-d5c831ccc47d"
];

const industrialSquareImageUrls = [
  "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F9B30898B-440D-4468-A67B-4900845BF47B.png?alt=media&token=9c25bfe7-35c4-4ac4-a15c-afa48b3cf009",
  "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F0F4C3895-E834-42D7-A2E6-D977EC5B9D2F.png?alt=media&token=e636e8e6-fa4a-4867-9468-7dea1ab2d7e8",
  "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F030A0E50-7E80-4B1A-ABAB-6361C4509BFE.png?alt=media&token=aef8007a-755c-429a-9f8b-b4f72cbaf110",
  "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2FBA5BF42E-DBD1-4F87-AD6F-F15FF97284D1.png?alt=media&token=e18e3fb8-8187-47a5-9049-0464e5780e3c",
  "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2FE3218196-C0D8-4541-9C77-50F8B5C2A525.png?alt=media&token=3f3d843f-b0f1-4605-9a30-a25a9cfad858",
  "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F33076CD1-1A72-49AD-8AA2-51942AB911A3.png?alt=media&token=0a52a23c-324e-4e0b-b8fa-02b0bfbe51e6",
  "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F607839ED-6B85-41B2-94B0-F8583A28DF9A.png?alt=media&token=0b418125-cd81-471a-a96e-cb8b1811209b",
  "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F95A5058E-6A6D-463E-A28A-0F645F2E70F5.png?alt=media&token=aeb94331-48ad-41a7-aa6b-fab413631fdd",
  "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F7C352F11-832D-478E-8A10-732559D676FC.png?alt=media&token=073c2c29-3deb-4d06-973b-d44eab3a8d80",
  "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F06E6A93A-42B1-4502-9B4F-AD7813BC90B6.png?alt=media&token=46bd51f0-d2c0-4d29-b593-d8abeea83d35"
];

const industrialTitleImageUrl = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F3756E2FC-0B70-40D9-B93A-19B197F6074C.png?alt=media&token=6b0ec219-12ee-401e-bad5-91ded854be47";
const nirvanaSquareImageUrl = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2FEC7D8271-6693-443F-B991-BCF4FD3A3639.png?alt=media&token=b1614811-049f-4318-852d-2dfdd2f2441f";
const luckyDaySquareImageUrl = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F581C8991-B7A6-46A3-864A-CFD10DE1A86B.png?alt=media&token=2e25e376-4f60-40de-98ab-93f5a169f8ad";
const darkAgesTitleImageUrl = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F11525237-84FB-4CD9-9542-508D035D424A.png?alt=media&token=5d566250-df62-42b0-af29-4d1600f013b5";
const evilEyeSquareImageUrl = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F6E5FA42F-2D8B-4A86-A0D8-7B42BDE1A9FB.png?alt=media&token=05e3a8bb-c438-4478-857f-dd765bfa08a2";
const kingsTitleImageUrl = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F2D242C5A-0170-46F9-BACA-B04A5AD67F27.png?alt=media&token=3dd62193-131d-42ac-bc5c-b3aa98833aa8";
const ancientTitleImageUrl = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F0CE00382-435E-4D35-9A11-10DF9B8352A9.png?alt=media&token=defa6e7b-8b28-45a1-9b83-4c86d97d648a";
const charitySquareImageUrl = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F4BDB1074-EFDD-464A-808D-334D1CC17AE7.png?alt=media&token=e3e0be1c-865d-4a08-a3e9-86389b6ada6e";

const kingsSuddenDeathImageUrl_player = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2FC33B6D8F-C74E-4193-B970-FF0145AD0490.png?alt=media&token=c375ddbd-91cc-4d02-8f9c-49e37119c55d";
const kingsTwistImageUrl_player = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2FF67F2F4A-75D0-4642-974E-AB8CAC5196A4.png?alt=media&token=856efddf-9e40-4ae2-a1c4-caae936d5708";
const kingsMajorTreasureImageUrl_player = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2FF449FB23-5DAA-4F0B-AC02-3CB41A4F860F.png?alt=media&token=35d3dfb0-db2a-40a2-b21a-ed39778ead87";
const kingsBarterImageUrl_player = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2FA6D9DAE5-CC1F-46F5-9B31-C920D4EEBD0C.png?alt=media&token=677dec5d-5c01-42c0-b740-7532ee8d3299";
const kingsUniversalTreasureImageUrl_player = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F5D6E5D77-92FD-428D-913F-A37120D45DE6.png?alt=media&token=53d49585-3d33-495e-9b39-c59006eb5abc";

const kingsGambleImageUrl_player = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F86214281-1169-473C-96B2-265334E128EE.png?alt=media&token=985acfe5-ca5f-47ce-81a7-98fe3ce4550c";
const kingsHazardImageUrl_player = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F245DB096-6F4D-4E6E-AC9B-D8198D4FE228.png?alt=media&token=44348c75-388e-4234-b410-257d03db2eb9";
const kingsRobberyImageUrl_player = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2FCF1E8C8F-FDD2-424A-B34D-2FD350208F4E.png?alt=media&token=f4c3d410-46d2-4c93-8dcf-3bcb932fd081";
const kingsVengeanceImageUrl_player = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F761D5387-9393-4FF1-A89F-0D1D1CF1E012.png?alt=media&token=e17846aa-b358-4f0d-a634-0f8ffa4cee2f";
const kingsTimePortalImageUrl_player = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F5BCB17F1-2151-4B0F-8B4B-A912E1C51B72.png?alt=media&token=c014aced-e0f3-4431-a7b5-675b456c4a6a";

const industrialMajorTreasureImageUrl_player = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2FD56F10FB-F7C0-4B35-82AE-4786511951C7.png?alt=media&token=00268bf8-3c71-4e34-a81f-006f69b5b720";
const industrialTimePortalImageUrl_player = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F932493F0-B086-4E48-AFE2-75DFDAB13554.png?alt=media&token=d2517a10-43a4-44c8-b971-d563c2219552";
const industrialGambleImageUrl_player = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2FFE99369C-CA18-4377-AD11-D5EDA0208926.png?alt=media&token=20238852-8456-497e-bcb2-cdafd95ffd42";
const industrialRobberyImageUrl_player = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F7D9D6845-8FB1-4A5F-AA0E-D18DD2D3398C.png?alt=media&token=2976c662-60fa-4891-8927-a613d9020e4e";
const industrialBarterImageUrl_player = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F816D795C-3267-46B7-89C5-F81AC78C59D0.png?alt=media&token=7745cb61-09d6-47a9-83a2-1e64640940ee";
const industrialSuddenDeathImageUrl_player = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2FFE8EFFC0-C2B0-48AA-95E2-D448838C254F.png?alt=media&token=a455be55-bb33-41df-b30f-7997fb9c433a";
const industrialTwistImageUrl_player = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2FE2DDD3D1-B384-482E-9B3B-8809A6C7100B.png?alt=media&token=383e82e9-3e3a-4516-ad0a-7c14e5d4391a";
const industrialTreasureImageUrl_player = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2FB2C0C753-F5EA-4585-AA5D-AE80025E6341.png?alt=media&token=a574c6bd-6751-4bce-a53e-0e66384fd67a";
const industrialVengeanceImageUrl_player = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F0B4A5CBF-AAA5-411E-8B0E-7EB6632840A8.png?alt=media&token=01f6d2b1-f011-4450-93d1-3bc5859aa2d9";
const industrialHazardImageUrl_player = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F344ED3BB-DFBE-400F-9D3D-E66072F45115.png?alt=media&token=1060eb51-1e4b-4567-886e-1d14d4b1cf62";

const darkAgesVengeanceImageUrl_player = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2FB788FD39-B0BD-44E1-883C-DFDA3E1D954B.png?alt=media&token=3a3e0df8-8148-4efa-8c37-a8c4efa54cea";
const darkAgesRobberyImageUrl_player = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F0E02DD5B-FCF7-424A-B6A7-EB84BDF432D3.png?alt=media&token=4e18ba3d-07e4-4e95-bda2-8f0d40eed0bb";
const darkAgesHazardImageUrl_player = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F19BDAB87-2271-45ED-85E9-D67CA382FEDF.png?alt=media&token=861a96a8-336f-4491-bb6a-f5e72ba71fb5";
const darkAgesTimePortalImageUrl_player = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F17AF0DA5-BC19-4B6A-BB75-A87C026F1571.png?alt=media&token=89e56c7d-2bae-4ef7-bfb5-6f4aa4a8ba83";
const darkAgesGambleImageUrl_player = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F11EC5B89-8EE8-480C-AF87-4AAEFDAE66F3.png?alt=media&token=4cf66599-47be-4bc9-98ab-4d4d847a0339";
const darkAgesMajorTreasureImageUrl_player = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F08C268A9-16C3-4A48-AE02-2DA1F85AD8D7.png?alt=media&token=a83983be-ba0c-4a18-9025-4f66f9f77b7a";
const darkAgesBarterImageUrl_player = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2FF12691B3-4C08-4AFE-ABC5-E550D5A1BBBC.png?alt=media&token=595db7a0-94b1-40f1-9f09-0b118ec77b49";
const darkAgesSuddenDeathImageUrl_player = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F5CC6BD45-5691-44DD-B60C-09CE07905B64.png?alt=media&token=40648f71-ecef-41aa-aba4-65f6114e303e";
const darkAgesTreasureImageUrl_player = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2FF5953906-6777-4AA9-BD2B-EE8D44B48781.png?alt=media&token=8db92578-5702-4ea2-8ef0-e591afa494ce";
const darkAgesTwistImageUrl_player = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2FF52546E3-4898-463C-95DE-04A7045AA8EA.png?alt=media&token=17768ea2-1ef9-46d0-8de7-5ea5879bc7e8";

const ancientVengeanceImageUrl_player = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F1D626FA1-22F6-43AE-B56C-8F3745EFE836.png?alt=media&token=6bdb40e8-f4d7-489b-b3c8-69fa60ee05ce";
const ancientBarterImageUrl_player = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2FE1A089BA-3FF2-46E3-9C3B-EDB37B9C4093.png?alt=media&token=9fe782da-1082-4ef7-a608-a36d35b41f21";
const ancientGambleImageUrl_player = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F24742C55-E66D-49DE-8D68-542F89887B90.png?alt=media&token=6568ad95-efc0-4ebe-b775-2775023a7854";
const ancientRobberyImageUrl_player = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F8AB782B3-1CE1-4387-8604-453C2B01FBDE.png?alt=media&token=575a61fc-683d-42c6-b0b7-76cad2dbd59b";
const ancientTimePortalImageUrl_player = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F73983B85-BC05-46EC-ACBC-A72D193D3C66.png?alt=media&token=5181754c-d227-494c-ae4f-eaa68306f28d";
const ancientHazardImageUrl_player = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2FBA665170-B9ED-4384-AC29-BCACEC851A39.png?alt=media&token=5e663dcd-f5ed-49ca-926d-4bc92ebbe2eb";
const ancientSuddenDeathImageUrl_player = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2FB9C0BFFC-EBFC-4C3D-9746-E60063F5C3E3.png?alt=media&token=a9c3c969-03eb-4efd-9692-a27561de64d2";
const ancientTreasureImageUrl_player = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2FF8EB831E-4D5F-4614-A80F-4754B92423C6.png?alt=media&token=5904d6db-e247-4dbc-a2ed-5ef07438ce45";
const ancientTwistImageUrl_player = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F5968D414-AB63-40F2-BCDC-FA554587671B.png?alt=media&token=397620ac-8921-45fa-b8da-d9d7f374d566";
const ancientMajorTreasureImageUrl_player = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F45F94B82-1076-46CB-B01B-18C2F2066319.png?alt=media&token=2bc58fac-56b5-4203-aba7-d2e1adfb69fc";
const rollAgainSquareImageUrl_player = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F3DFC441A-9BAD-4693-8FE4-DE496AD6C58F.png?alt=media&token=2e5983f7-ca84-4af5-afe5-1b8f1db66afa";

const darkAgesSquareImageUrls = [
  "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2FBD5D22EE-F50F-488B-AD1F-2167B95D8A26.png?alt=media&token=557fb3b9-efd4-4147-9558-e87dab49dd95",
  "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2FC403E442-D1E1-4E71-86D1-0349D43B2ECE.png?alt=media&token=8c49fdf4-0b56-4fcf-bfbf-043b4e324736",
  "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F6FDB8880-40DE-4B84-BFD7-AC6751054FE1.png?alt=media&token=207281e2-9370-4cba-b706-f8c1353866c1",
  "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2FD656EAFB-1456-48A1-A724-FEC522CAF0B9.png?alt=media&token=4a945b7b-f9d0-4b71-9105-8e8b0e6834d9",
  "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2FD1BC0464-15D3-439F-B155-3EF8931D0F0D.png?alt=media&token=c04e32d6-2753-444a-bd8b-eba7a31af935",
  "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2FD1AFE7E0-38AA-480F-8C0C-68FF261B574F.png?alt=media&token=67583179-782e-4c55-ba45-83416b4c0197",
  "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2FEC9F2A02-FA5A-49EA-81EC-C0493941E291.png?alt=media&token=b7cfad21-0401-4912-8930-f73af0957ba8",
  "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2FD9BED784-6D7C-449E-A106-09CFF7F7CC68.png?alt=media&token=4299e668-c76e-422a-90fb-000af90336b3",
  "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2FDFB7D757-8EB9-47FD-9EEC-EF27D8D4D2F6.png?alt=media&token=85b7ca8f-e772-4248-b270-ba034d89bece",
  "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2FF469A27E-41BC-4E0D-88DA-0E613C0416B8.png?alt=media&token=456cfdbc-2921-4242-9cc6-1548b7386da5"
];

// Game state
        const gameState = {
            players: [],
            currentPlayerIndex: 0,
            board: [],
            currentEra: 'ancient',
            eras: ['industrial', 'kings', 'dark', 'ancient'],
            eraTileCounts: [46, 43, 48, 32], // Industrial (46), Kings (43), Dark (48), Ancient (32)
            eraTransitionCells: [46, 89, 137], // End indices of Industrial, Kings, Dark eras
            gameStarted: false,
            processingMove: false,
            charityPool: 0, // Pool for credits from Sudden Death and Charity squares
            turnCount: 0, // Track number of turns
            suddenDeathCount: 0, // Track number of Sudden Death squares placed
            // offeredInsuranceThisTurn: false, // This will be a player-specific property
            karmicLevels: [
                "Scum of the earth",
                "Commonplace and Vulgar",
                "Heroes and Heroines",
                "The Great and The Saintly"
            ],
            lifetimeCredits: [], // Track lifetime credits for each player
            originalTwistCards: { ancient: [], dark: [], kings: [], industrial: [] },
            twistCardDecks: { ancient: [], dark: [], kings: [], industrial: [] },
            originalTreasureCards: { ancient: [], dark: [], kings: [], industrial: [] } // For storing parsed treasure cards
        };
        
        let pastLifeTextsData = {}; // Initialize globally
        let currentPastLifePlayerIndex = 0;

        function parsePastLifeRawData(rawData) {
            const data = {};
            // These are the exact keys expected in the `data` object and used for lookup
            const karmicLevelKeys = [
                "THE SCUM OF THE EARTH",
                "THE COMMONPLACE AND THE VULGAR",
                "HEROES AND HEROINES",
                "THE GREAT AND THE SAINTLY"
            ];
            karmicLevelKeys.forEach(title => { data[title] = []; });

            const entries = rawData.trim().split(/\n\s*‚∏ª\s*\n/);
            let currentKarmicGroupTitleDeterminedForBlock = null;

            for (const entryBlock of entries) {
                const allLinesInBlock = entryBlock.trim().split('\n').map(l => l.trim()).filter(l => l !== "");
                if (allLinesInBlock.length === 0) continue;

                let linePointer = 0;
                // Check if the first line of the current block explicitly sets a new Karmic Group Title
                if (linePointer < allLinesInBlock.length && karmicLevelKeys.includes(allLinesInBlock[linePointer])) {
                    currentKarmicGroupTitleDeterminedForBlock = allLinesInBlock[linePointer];
                    // linePointer++; // Don't increment linePointer here, the score search loop will handle it.
                }

                if (!currentKarmicGroupTitleDeterminedForBlock) {
                    // This can happen if a block doesn't start with one of the main titles.
                    // Should rely on the *overall* structure where main titles precede their respective score blocks.
                    // console.warn("Karmic group title not determined at the start of this block:", entryBlock.substring(0,100));
                    continue; // Cannot process block without a Karmic Group context
                }

                let scoreLineText = null;
                let scoreLineActualIndex = -1;

                for (let i = 0; i < allLinesInBlock.length; i++) {
                    // Match 'IF YOUR score WAS' or 'IF YOUR SCORE WAS'
                    if (allLinesInBlock[i].match(/^IF YOUR S?score WAS (\d+) TO (\d+)(?:‚Ä¶|...)/i)) {
                        scoreLineText = allLinesInBlock[i];
                        scoreLineActualIndex = i; // Store the index of the score line within allLinesInBlock
                        break;
                    }
                }

                if (!scoreLineText) {
                    // console.warn("Score line not found in block for", currentKarmicGroupTitleDeterminedForBlock, ":", entryBlock.substring(0,100));
                    continue;
                }

                const scoreMatch = scoreLineText.match(/^IF YOUR S?score WAS (\d+) TO (\d+)(?:‚Ä¶|...)/i);
                if (!scoreMatch) continue; 

                const minScore = parseInt(scoreMatch[1]);
                const maxScore = parseInt(scoreMatch[2]);

                let pastLifeTitleFound = "TITLE NOT FOUND";
                let descriptionTextLines = [];
                let pastLifeTitleLineActualIndex = -1;

                // Search for the 'You were ' line starting from the end of the block, downwards, but only after the score line.
                for (let i = allLinesInBlock.length - 1; i > scoreLineActualIndex; i--) {
                    if (allLinesInBlock[i].startsWith("You were ")) {
                        pastLifeTitleLineActualIndex = i;
                        pastLifeTitleFound = allLinesInBlock[i];
                        break;
                    }
                }

                if (pastLifeTitleLineActualIndex !== -1) {
                    // Description is between score line and title line
                    descriptionTextLines = allLinesInBlock.slice(scoreLineActualIndex + 1, pastLifeTitleLineActualIndex);
                } else {
                    // Fallback: if 'You were' is not found, this is likely a data formatting issue for this specific dataset.
                    // For robustness, we can take all lines after score line as description and use a default title.
                    // console.warn(`'You were...' title line not found for score ${minScore}-${maxScore} in ${currentKarmicGroupTitleDeterminedForBlock}. Using fallback accumulation.`);
                    descriptionTextLines = allLinesInBlock.slice(scoreLineActualIndex + 1);
                    pastLifeTitleFound = "A Past Life from " + currentKarmicGroupTitleDeterminedForBlock; 
                }
                
                const assembledText = descriptionTextLines.map(l=>l.trim()).filter(line => line !== "").join('\n');

                if (data[currentKarmicGroupTitleDeterminedForBlock]) {
                     data[currentKarmicGroupTitleDeterminedForBlock].push({
                        minScore: minScore,
                        maxScore: maxScore,
                        title: pastLifeTitleFound,
                        text: assembledText
                    });
                } else {
                    // console.warn("Karmic group title not recognized for data push:", currentKarmicGroupTitleDeterminedForBlock);
                }
            }
            return data;
        }

        function getPastLifeText(karmicLevelNameKey, score) {
            const levelData = pastLifeTextsData[karmicLevelNameKey];
            if (!levelData) {
                console.warn(`No past life data found for Karmic Level: ${karmicLevelNameKey}`);
                return null;
            }

            let scoreForLookup = score;
            if (score > 3000) scoreForLookup = 3000;
            if (score < 0) scoreForLookup = 0;

            for (const entry of levelData) {
                if (scoreForLookup >= entry.minScore && scoreForLookup <= entry.maxScore) {
                    return entry;
                }
            }
            // Fallback for score 0 if no range explicitly covers it (e.g. if first range is 1-100)
            if (scoreForLookup === 0 && levelData[0] && levelData[0].minScore === 0) {
                 return levelData[0];
            }
            console.warn(`No specific past life entry found for score ${scoreForLookup} in ${karmicLevelNameKey}.`);
            return null; 
        }

        function showNextPastLife(playerScores) {
            const pastLifeModal = document.getElementById('past-life-modal');
            if (currentPastLifePlayerIndex >= playerScores.length) {
                pastLifeModal.style.display = 'none';
                showEvent("Past Lives Revealed", "All destinies have been shown. Would you like to play again?");
                const finalOkButton = document.getElementById('event-buttons').firstChild; 
                if (finalOkButton) {
                    finalOkButton.textContent = "Play Again";
                    finalOkButton.onclick = () => location.reload();
                }
                return;
            }

            const playerStats = playerScores[currentPastLifePlayerIndex];
            const karmicLevelDisplayName = gameState.karmicLevels[playerStats.karmicLevel];
            let karmicLevelKeyForLookup;

            // Map display names to the exact keys used in pastLifeTextsData
            switch (karmicLevelDisplayName) {
                case "Scum of the earth":
                    karmicLevelKeyForLookup = "THE SCUM OF THE EARTH";
                    break;
                case "Commonplace and Vulgar":
                    karmicLevelKeyForLookup = "THE COMMONPLACE AND THE VULGAR";
                    break;
                case "Heroes and Heroines":
                    karmicLevelKeyForLookup = "HEROES AND HEROINES";
                    break;
                case "The Great and The Saintly":
                    karmicLevelKeyForLookup = "THE GREAT AND THE SAINTLY";
                    break;
                default:
                    console.error("Unknown karmicLevelDisplayName for Past Life lookup:", karmicLevelDisplayName);
                    // Fallback to old logic just in case, or a more robust default
                    karmicLevelKeyForLookup = karmicLevelDisplayName.toUpperCase().startsWith("THE ") ? karmicLevelDisplayName.toUpperCase() : ("THE " + karmicLevelDisplayName.toUpperCase());
            }
            
            const totalFinalScore = playerStats.score;
            const pointsFromAscensions = playerStats.bankedPoints;
            const scoreRelevantToCurrentLevel = totalFinalScore - pointsFromAscensions;

            const pastLifeEntry = getPastLifeText(karmicLevelKeyForLookup, scoreRelevantToCurrentLevel);

            document.getElementById('past-life-player-name').textContent = `${playerStats.name}'s Past Life`;
            document.getElementById('past-life-karmic-level').textContent = `Karmic Level: ${karmicLevelDisplayName}`;
            document.getElementById('past-life-score-info').textContent = `Final Credits: ${totalFinalScore} (Life Credits: ${scoreRelevantToCurrentLevel})`;

            if (pastLifeEntry) {
                document.getElementById('past-life-title').textContent = pastLifeEntry.title;
                document.getElementById('past-life-text').textContent = pastLifeEntry.text;
            } else {
                document.getElementById('past-life-title').textContent = "A MYSTERIOUS PAST";
                document.getElementById('past-life-text').textContent = "Your past life is shrouded in mystery, an unwritten chapter in the akashic records. The archives for this score range may be incomplete.";
            }

            const nextButton = document.getElementById('next-past-life-button');
            if (currentPastLifePlayerIndex === playerScores.length - 1) {
                nextButton.textContent = "Finish & Play Again";
                 nextButton.onclick = () => { // Last player, finish and reload
                    pastLifeModal.style.display = 'none';
                    location.reload();
                };
            } else {
                nextButton.textContent = `Next Player (${playerScores[currentPastLifePlayerIndex + 1].name})`;
                nextButton.onclick = () => {
                    currentPastLifePlayerIndex++;
                    showNextPastLife(playerScores);
                };
            }
            pastLifeModal.style.display = 'block';
        }

        function startPastLifeReveal(playerScores) {
            hideEvent(); 
            currentPastLifePlayerIndex = 0;
            showNextPastLife(playerScores);
        }

        // Initialize the game when the page loads
        window.onload = function() {
            const pastLifeRawDataString = `THE SCUM OF THE EARTH\n\n(Scores 0‚Äì3000)\n\nTHE SCUM OF THE EARTH\n\nIF YOUR score WAS 0 TO 100‚Ä¶\n\nYou were no bigger than a freckle, but your impact was catastrophic. Hatched in the swamps, you hopped from rats to humans, never knowing‚Äîor caring‚Äîthat you carried the bacterium Yersinia pestis. By 1328, your bite set off a chain reaction that would wipe out a quarter of Europe‚Äôs population. Twenty-five million people died, and history shuddered in your wake.\n\nYou were THE FLEA THAT STARTED THE BLACK PLAGUE.\n\n‚∏ª\n\nTHE SCUM OF THE EARTH\n\nIF YOUR SCORE WAS 101 TO 200‚Ä¶\n\nIn 1519, you scurried aboard a Spanish galleon via a mooring rope, bound for the riches of the East. For three years you never left the ship, feasting on crumbs while empires changed around you. From South America to Southeast Asia, you voyaged without lifting a paw‚Äîuntil your last stop in the Philippines.\n\nYou were a RAT ON MAGELLAN‚ÄôS SHIP.\n\n‚∏ª\n\nTHE SCUM OF THE EARTH\n\nIF YOUR SCORE WAS 201 TO 300‚Ä¶\n\nBorn mangy and misshapen in 1526 Vienna, you prowled the outskirts of society, shunned and spat upon‚Äîuntil you found refuge with an old woman in the woods. She saw more in you. But when she was dragged to trial as a witch, you were named her Familiar‚Äîservant of Satan and enabler of her magic. You were burned in effigy alongside her.\n\nYou were the WITCH‚ÄôS DOG.\n\n‚∏ª\n\nTHE SCUM OF THE EARTH\n\nIF YOUR SCORE WAS 301 TO 400‚Ä¶\n\nTowering above your peers, you were chosen by French knight Gaspard de Poitou to carry him in the Second Crusade. You crossed the sea from Marseilles, braving the desert heat of the Holy Land. But before you could charge into battle, a Saracen ambush and a blinding sandstorm ended your dreams of valor.\n\nYou were GUILLAUME LE GRAND, the CRUSADER‚ÄôS HORSE.\n\n‚∏ª\n\nTHE SCUM OF THE EARTH\n\nIF YOUR SCORE WAS 401 TO 500‚Ä¶\n\nBred in captivity at Fontainebleau in 1613, you perched on the king‚Äôs arm with regal menace. So vicious was your temperament that Louis XIII had to muzzle you with a leather mask. You were calmed only by gusts of tobacco smoke and became the monarch‚Äôs favorite hunting companion. Upon your death, you were buried in a miniature coffin and sealed into a palace wall.\n\nYou were MINOUCHE, THE KING‚ÄôS FALCON.\n\n‚∏ª\n\nTHE SCUM OF THE EARTH\n\nIF YOUR SCORE WAS 501 TO 600‚Ä¶\n\nHe was a hermit, a healer, a sorcerer‚Äîand you, his constant companion. You perched on Merlin‚Äôs shoulder as he whispered to the winds and tended to a boy he called Wart. That boy would become Arthur, king of Britain. You watched history bend beneath magic.\n\nYou were MERLIN‚ÄôS OWL.\n\n‚∏ª\n\nTHE SCUM OF THE EARTH\n\nIF YOUR SCORE WAS 601 TO 700‚Ä¶\n\nBred in Carthage around 203 B.C., you were a marvel of military engineering. Trained under Elibakar, you learned formations like a dancer. Alongside Hannibal and 12,000 troops, you crossed the Alps in an audacious march toward Rome. But snow, starvation, and exhaustion claimed you before your hooves touched Italian soil.\n\nYou were AZISAN, HANNIBAL‚ÄôS ELEPHANT.\n\n‚∏ª\n\nTHE SCUM OF THE EARTH\n\nIF YOUR SCORE WAS 701 TO 800‚Ä¶\n\nFound in a trench by a U.S. soldier during World War I, you were rescued, trained, and transformed into a silver-screen sensation. With your handler Lee Duncan and writers like Darryl Zanuck, you went from battlefield stray to Hollywood royalty‚Äîlaunching a dynasty of canine stars.\n\nYou were RIN TIN TIN, THE DOG THAT SAVED HOLLYWOOD.\n\n‚∏ª\n\nTHE SCUM OF THE EARTH\n\nIF YOUR SCORE WAS 801 TO 900‚Ä¶\n\nCaptured in Abyssinia and raised in European zoos, you grew to eleven feet tall and weighed over six tons. You crossed oceans and headlined P.T. Barnum‚Äôs circus, pulling crowds across the United States. But in 1885, a train struck you as you crossed the tracks. The world mourned.\n\nYou were JUMBO THE ELEPHANT, now skeletonized in the Museum of Natural History.\n\n‚∏ª\n\nTHE SCUM OF THE EARTH\n\nIF YOUR SCORE WAS 901 TO 1000‚Ä¶\n\nDelivered to Cleopatra in a basket of figs, you were sacred‚Äîso deadly that your bite was believed to send souls directly to paradise. When Egypt‚Äôs last queen took her own life, it was your venom that sealed the legend. For your role in ending an empire, you were executed by order of Marcus Agrippa.\n\nYou were THE ASP THAT KILLED CLEOPATRA.\n\n‚∏ª\n\nTHE SCUM OF THE EARTH\n\nIF YOUR SCORE WAS 1001 TO 1100‚Ä¶\n\nThe Trurians slaughtered your pups, but you survived. Hunted and hungry, you fled into the forest‚Äîonly to stumble upon two crying infants, abandoned by fate and fortune. You didn‚Äôt know they‚Äôd one day found an empire. You just knew they were yours now.\n\nYou nursed them with your own milk. Statues remember you as a beast. Rome remembers you as a mother.\n\nYou were the SHE-WOLF OF ROME.\n\n‚∏ª\n\nTHE SCUM OF THE EARTH\n\nIF YOUR SCORE WAS 1101 TO 1200‚Ä¶\n\nThey called you charming‚Äîwhen they weren‚Äôt calling you a monster. Between 1962 and 1964, you strangled thirteen women in Boston, always with a bow tied neatly around the neck. You had a flair for presentation.\n\nThe one that got away ruined your fun. You were sentenced to life, but not for long. Another inmate ended your story with a shiv.\n\nYou were ALBERT DE SALVO, THE BOSTON STRANGLER.\n\n‚∏ª\n\nTHE SCUM OF THE EARTH\n\nIF YOUR SCORE WAS 1201 TO 1300‚Ä¶\n\nYour beard was a fireworks display. Literally. You tied sparklers to it. Born in Bristol in the 1700s, you roared across the seas as the terror of the Carolinas. Your name made sailors shake, and your ship was death with sails.\n\nYou were theatrics, brutality, and rum‚Äîall soaked in blood. Eventually, they had to cut off your head just to stop your mouth.\n\nYou were EDWARD TEACH, a.k.a. BLACKBEARD.\n\n‚∏ª\n\nTHE SCUM OF THE EARTH\n\nIF YOUR SCORE WAS 1301 TO 1400‚Ä¶\n\nJack didn‚Äôt like women. Or people. Or restraint. In 1888, you carved a legend into London‚Äôs East End. Scotland Yard suspected royalty, surgeons, madmen‚Äîbut you vanished before they could be sure.\n\nFive women, five messages, and one chilling signature: yours.\n\nYou were JACK THE RIPPER, terror of Whitechapel, and the first modern serial killer.\n\n‚∏ª\n\nTHE SCUM OF THE EARTH\n\nIF YOUR SCORE WAS 1401 TO 1500‚Ä¶\n\nIn the 11th century, you sat atop a mountain in Iran with a loyal cult of stoners. Literally‚Äîyou fed them hashish, then sent them out to assassinate emperors and kings. Your fortress at Alamut became the birthplace of a word still whispered today: assassin.\n\nYou were the OLD MAN OF THE MOUNTAIN, and your hitmen were high, devoted, and deadly.\n\n‚∏ª\n\nTHE SCUM OF THE EARTH\n\nIF YOUR SCORE WAS 1501 TO 1600‚Ä¶\n\nYou fought beside Joan of Arc‚Ä¶ then butchered children in your basement. Gilles de Rais, they called you‚ÄîFrance‚Äôs richest nobleman, turned serial killer. You believed blood could turn lead to gold. Spoiler: it didn‚Äôt.\n\nYou died by strangulation in 1440. Mothers wept. But not for you.\n\nYou were GILLES DE RAIS, knight, killer, and failed alchemist.\n\n‚∏ª\n\nTHE SCUM OF THE EARTH\n\nIF YOUR SCORE WAS 1601 TO 1700‚Ä¶\n\nForget pearls and prayer‚ÄîBaal threw a better party. You brought his rites to Israel with wine, ecstasy, and fire. The prophets were not amused. Your name became an eternal slur for dangerous women.\n\nWhen Jehu arrived, the dogs did the rest.\n\nYou were JEZEBEL, queen of indulgence, devourer of prophets.\n\n‚∏ª\n\nTHE SCUM OF THE EARTH\n\nIF YOUR SCORE WAS 1701 TO 1800‚Ä¶\n\nHistory remembers the incest, the gluttony, the dismemberment. Ptolemy VII, ‚ÄúThe Sausage,‚Äù they called you‚Äîbecause ‚Äúmonstrous‚Äù was too polite. You married your sister, raped your niece, married her, killed their son, and sent the pieces as a gift.\n\nEgypt gasped. You belched. Then you died‚Äîthankfully.\n\nYou were PTOLEMY VII, a family man‚Ä¶ in the worst way.\n\n‚∏ª\n\nTHE SCUM OF THE EARTH\n\nIF YOUR SCORE WAS 1801 TO 1900‚Ä¶\n\nAt sixteen, you stabbed a man for insulting your friend. At seventeen, you had eighteen kills. At twenty-two, you met a bullet with your name on it‚Äîfired by Pat Garrett on the Fourth of July.\n\nYou didn‚Äôt live long, but you died famous.\n\nYou were BILLY THE KID, the acne-scarred outlaw with a knife and a cause.\n\n‚∏ª\n\nTHE SCUM OF THE EARTH\n\nIF YOUR SCORE WAS 1901 TO 2000‚Ä¶\n\nYou were a Venetian noble‚Äôs golden-haired daughter, traded like coin between men of ambition. Your husband married you. The Duke of Florence kept you.\n\nYou kidnapped a street urchin to fake a royal heir. You poisoned dinner parties. You shrieked in the court, spittle flying. Eventually, the Florentines served your last supper‚Äîwith arsenic.\n\nYou were BIANCA CAPELLO, mistress turned martyr of Medici politics.\n\n‚∏ª\n\nTHE SCUM OF THE EARTH\n\nIF YOUR SCORE WAS 2001 TO 2100‚Ä¶\n\nYou were born rich and clever‚Äîdeadly combination. Richard Loeb: pampered, precocious, bored. So you tried murder. For fun. For art. For Nietzsche.\n\nYou and your ‚Äúclose friend‚Äù Leopold killed a boy just to prove you could. One mistake: Leopold left his glasses at the crime scene. Clarence Darrow couldn‚Äôt save your karma. A fellow inmate stabbed you 56 times.\n\nYou were RICHARD LOEB, philosopher of murder and cautionary tale.\n\n‚∏ª\n\nTHE SCUM OF THE EARTH\n\nIF YOUR SCORE WAS 2101 TO 2200‚Ä¶\n\nYou taught Sunday school. You smiled sweetly. And then you picked up an axe.\n\nOn August 4, 1892, your father was found slumped in a chair. Your stepmother looked like a pi√±ata made of spite and bone. The police botched the case, and the jury adored your petticoats. You walked free‚Äîand into legend.\n\nYou were LIZZIE BORDEN, darling of American true crime.\n\n‚∏ª\n\nTHE SCUM OF THE EARTH\n\nIF YOUR SCORE WAS 2201 TO 2300‚Ä¶\n\nBlue eyes. Scarred lips. Gum under your hat brim. You smiled at the judge like he was boring you.\n\nAt twelve, you stole coal. At twenty-five, you were Public Enemy Number One. You robbed banks with the flair of a matinee idol. You died outside the Biograph Theater, betrayed by a woman in red.\n\nYou were JOHN DILLINGER, gangster, legend, and rebel without a plan.\n\n‚∏ª\n\nTHE SCUM OF THE EARTH\n\nIF YOUR SCORE WAS 2301 TO 2400‚Ä¶\n\nYou married Emperor Claudius, seduced half of Rome, and declared open season on anyone who said no. When your husband drunkenly signed your death warrant, you tore it up in the morning. Too late. The assassins were already in the room.\n\nYou were MESSALINA, Rome‚Äôs royal wrecking ball.\n\n‚∏ª\n\nTHE SCUM OF THE EARTH\n\nIF YOUR SCORE WAS 2401 TO 2500‚Ä¶\n\nYou believed blood was the fountain of youth. Specifically: virgin blood. So you hunted, drained, and bathed in it.\n\nIn 17th-century Hungary, you were nobility with a necromancer‚Äôs skincare routine. Eventually, even the aristocracy said, ‚ÄúEnough.‚Äù They bricked you into your own castle.\n\nYou were COUNTESS ELIZABETH BATHORY, Hungary‚Äôs queen of horror.\n\n‚∏ª\n\nTHE SCUM OF THE EARTH\n\nIF YOUR SCORE WAS 2501 TO 2600‚Ä¶\n\nYou ruled through terror. The Turks feared you. The peasants feared you. The forests of Transylvania grew forests of impaled corpses‚Äîyour calling card.\n\nYou didn‚Äôt just kill. You arranged death like an art installation. Some say you drank blood. Some say you laughed while they screamed. Either way, Dracula was your PR makeover.\n\nYou were VLAD THE IMPALER, scourge of the stake.\n\n‚∏ª\n\nTHE SCUM OF THE EARTH\n\nIF YOUR SCORE WAS 2601 TO 2700‚Ä¶\n\nYou swaggered out of Siberia wearing nothing but charisma and stink. You healed the Tsarevich, seduced the Tsarina, and plunged imperial Russia into chaos‚Äîall while claiming to serve God.\n\nThey poisoned you. You lived. They shot you. You twitched. They drowned you. You finally took the hint.\n\nYou were GRIGORI RASPUTIN, the mad monk with more lives than Russia could afford.\n\n‚∏ª\n\nTHE SCUM OF THE EARTH\n\nIF YOUR SCORE WAS 2701 TO 2800‚Ä¶\n\nKing of Judea, puppet of Rome. You were paranoid, brilliant, and terminally violent. You built palaces of marble‚Äîand family trees soaked in blood.\n\nYou slaughtered your wife, your sons, and‚Äîif Christian lore is right‚Äîevery infant in Bethlehem. Nothing says festive like a massacre.\n\nYou were HEROD THE GREAT, ruler of ruins.\n\n‚∏ª\n\nTHE SCUM OF THE EARTH\n\nIF YOUR SCORE WAS 2801 TO 2900‚Ä¶\n\nYour disciples followed you from dusty villages to the very gates of Jerusalem. You turned the other cheek, walked on water, and fed crowds with a wink.\n\nThen came betrayal. Torture. Crucifixion. And resurrection‚Äîif you believe the story. Either way, your message shaped two millennia.\n\nYou were JESUS OF NAZARETH, martyr, messiah, and cosmic disruptor.\n\n‚∏ª\n\nTHE SCUM OF THE EARTH\n\nIF YOUR SCORE WAS 2901 TO 3000‚Ä¶\n\nYou could‚Äôve been great. For five years, you were golden. Then came the fires‚Äîliteral and metaphorical.\n\nYou fiddled while Rome burned. You murdered your mother, kicked your pregnant wife to death, and married a man who looked like her. Poets adored you. Citizens sharpened their knives. When it ended, you stabbed yourself and said: ‚ÄúWhat an artist dies in me!‚Äù\n\nYou were NERO CLAUDIUS CAESAR, Emperor, egotist, eternal meme.\n\n‚∏ª\n\nTHE COMMONPLACE AND THE VULGAR\n(After 3000 credits banked)\n\nIF YOUR SCORE WAS 0 TO 100‚Ä¶\n\nBorn in 938 as the twelfth child of a Flemish farmer, you were married off at thirteen and popped out fifteen children‚Äîmost of whom did not return the favor of survival. When your husband died from a cow kick, you entered the kitchens of nobility‚Ä¶ as a human dishcloth.\n\nYou were the COUNTESS‚ÄôS DRUDGE, proof that reincarnation sometimes just resets to ‚ÄúHard Mode.‚Äù\n\n‚∏ª\n\nTHE COMMONPLACE AND THE VULGAR\n(After 3000 credits banked)\n\nIF YOUR SCORE WAS 101 TO 200‚Ä¶\n\nYou were born into olives and died in irony. With a Sicilian inheritance, you turned Delos into a human Costco. You specialized in Greek dancing girls and sold 10,000 souls in a single day. Unfortunately, you mistook your kitchen slave for a nobody‚Äîuntil she served you arsenic in place of parsley.\n\nYou were LENTULLUS PISCUS, THE SLAVE DEALER, and Titia the Deliverer says hi.\n\n‚∏ª\n\nTHE COMMONPLACE AND THE VULGAR\n(After 3000 credits banked)\n\nIF YOUR SCORE WAS 201 TO 300‚Ä¶\n\nSeville, 1453. Born Jewish. Wrong place, wrong century. By 1485, a jealous neighbor whispered to the Inquisition, and your life turned to screams. They didn‚Äôt even wait for trial. The rack got answers you didn‚Äôt have.\n\nYou were LEAH, THE HERETIC, another soul burned for being inconvenient.\n\n‚∏ª\n\nTHE COMMONPLACE AND THE VULGAR\n(After 3000 credits banked)\n\nIF YOUR SCORE WAS 301 TO 400‚Ä¶\n\nYou were a loser, even by Egyptian standards. Caught robbing a tomb, you did eight years in the salt mines. When you got out, the only gig available was corpse-washing. You worked your way up‚Äîfrom cleaning to gutting. Eventually, you handled the boy king himself.\n\nYou were RAMOSE, THE EMBALMER, master of posthumous makeovers.\n\n‚∏ª\n\nTHE COMMONPLACE AND THE VULGAR\n(After 3000 credits banked)\n\nIF YOUR SCORE WAS 401 TO 500‚Ä¶\n\nYou were warned not to peek. You peeked. In 1364, Lady Godiva rode through town, and you just had to sneak a look. Blinded by either God or poetic justice, you ended your days hawking treasure maps drawn from memory.\n\nYou were PEEPING TOM, patron saint of horny regrets.\n\n‚∏ª\n\nTHE COMMONPLACE AND THE VULGAR\n(After 3000 credits banked)\n\nIF YOUR SCORE WAS 501 TO 600‚Ä¶\n\nThey bought you in the Caribbean and brought you to Salem. Your tales spooked the Puritans, and your ‚Äúconfession‚Äù helped kick off one of the most paranoid periods in colonial history. They let you rot in jail for a while, then sold you again.\n\nYou were TITUBA, unwitting muse of the witch hunt.\n\n‚∏ª\n\nTHE COMMONPLACE AND THE VULGAR\n(After 3000 credits banked)\n\nIF YOUR SCORE WAS 601 TO 700‚Ä¶\n\nYou thought you were marrying a hunk. Surprise‚Äîit was his brother in a mask. One noble house, one bad arranged marriage, and one forbidden affair later, your husband stabbed you both. Dante immortalized your tragedy in the second circle of Hell.\n\nYou were FRANCESCA DA RIMINI, literary romantic and eternal sob story.\n\n‚∏ª\n\nTHE COMMONPLACE AND THE VULGAR\n(After 3000 credits banked)\n\nIF YOUR SCORE WAS 701 TO 800‚Ä¶\n\nYou were the bawdiest thing onstage and off in 17th-century London. Actress, mistress, and mother to the King‚Äôs bastard, you lived scandalously and died beloved. When a Protestant mob stopped your coach, you flashed a grin and said, ‚ÄúBe civil‚ÄîI‚Äôm the Protestant whore!‚Äù\n\nYou were NELL GWYNNE, England‚Äôs favorite rascal.\n\n‚∏ª\n\nTHE COMMONPLACE AND THE VULGAR\n(After 3000 credits banked)\n\nIF YOUR SCORE WAS 801 TO 900‚Ä¶\n\nBrilliant, beautiful, and born to entertain, you mingled with Athens‚Äô elite in 470 B.C. Pericles adored you. The philosophers admired you. The women? Not so much. They called you a courtesan‚Äîyou called yourself a muse.\n\nYou were ASPASIA OF ATHENS, and the Parthenon remembers your name.\n\n‚∏ª\n\nTHE COMMONPLACE AND THE VULGAR\n(After 3000 credits banked)\n\nIF YOUR SCORE WAS 901 TO 1000‚Ä¶\n\nYou danced for a head‚Äîand got it. Herod‚Äôs court adored your Seven Veils. Then you asked for the head of John the Baptist, served on silver. Later, legend says you watched another execution: one on a hill outside Jerusalem. It made you weep.\n\nYou were SALOME, biblical temptress and posthumous convert.\n\n‚∏ª\n\nTHE COMMONPLACE AND THE VULGAR\n(After 3000 credits banked)\n\nIF YOUR SCORE WAS 1001 TO 1100‚Ä¶\n\nYou looked presidential. That was the problem. Behind your baritone voice and chiseled chin was a love of poker, whiskey, and corruption. Your friends looted the Treasury, your mistress blackmailed you, and your wife may have poisoned you just to spare your reputation.\n\nYou were WARREN G. HARDING, a cautionary tale in a three-piece suit.\n\n‚∏ª\n\nTHE COMMONPLACE AND THE VULGAR\n(After 3000 credits banked)\n\nIF YOUR SCORE WAS 1101 TO 1200‚Ä¶\n\nYou were born a peasant in the Caucasus and ended up running the Ottoman Empire‚Äîfrom the shadows. Captured by slavers, you entered the Sultan‚Äôs harem, seduced him, and eliminated everyone who blocked your ascent.\n\nYou were ROXELANA, queenmaker, schemer, and imperial poison enthusiast.\n\n‚∏ª\n\nTHE COMMONPLACE AND THE VULGAR\n(After 3000 credits banked)\n\nIF YOUR SCORE WAS 1201 TO 1300‚Ä¶\n\nHollywood didn‚Äôt want you‚Äîso you built your own pulpit. Glamorous, dramatic, and utterly sincere, you founded the Four Square Gospel Church and baptized thousands. Then you faked your own kidnapping for a fling with your radio manager.\n\nYou were AIMEE SEMPLE MCPHERSON, evangelist with a flare for both salvation and scandal.\n\n‚∏ª\n\nTHE COMMONPLACE AND THE VULGAR\n(After 3000 credits banked)\n\nIF YOUR SCORE WAS 1301 TO 1400‚Ä¶\n\nThey called you ‚ÄúFatty,‚Äù but your agility made you Hollywood‚Äôs first million-dollar clown. One wild party, a mysterious death, and a media frenzy later‚Äîyour career was over. You were acquitted, but America had already made up its mind.\n\nYou were ROSCOE ‚ÄúFATTY‚Äù ARBUCKLE, a fallen star with a sad punchline.\n\n‚∏ª\n\nTHE COMMONPLACE AND THE VULGAR\n(After 3000 credits banked)\n\nIF YOUR SCORE WAS 1401 TO 1500‚Ä¶\n\nYou were the most photographed woman of your century and the loneliest. Born Norma Jeane, you transformed into Marilyn‚Äîan icon, a fantasy, a tragedy. Men wanted you. Studios used you. The public adored you. The woman underneath disappeared.\n\nYou were MARILYN MONROE, goddess of the golden screen, ghost of her own fame.\n\n‚∏ª\n\nTHE COMMONPLACE AND THE VULGAR\n(After 3000 credits banked)\n\nIF YOUR SCORE WAS 1501 TO 1600‚Ä¶\n\nBorn poor, you became the First Lady of Argentina‚Äîand the most glamorous populist the world had ever seen. You fed the hungry, seduced the powerful, and left a trail of offshore accounts.\n\nYou were EVA PER√ìN, saint to the masses, scandal to the historians.\n\n‚∏ª\n\nTHE COMMONPLACE AND THE VULGAR\n(After 3000 credits banked)\n\nIF YOUR SCORE WAS 1601 TO 1700‚Ä¶\n\nBorn to bird catchers, you caught a pharaoh. Your boldness and beauty won Amenhotep III‚Äôs heart. Later, you married your own son to keep power in the family. The priests erased your name‚Äîbut not your legacy.\n\nYou were QUEEN TIY, mother of Akhenaten, matriarch of upheaval.\n\n‚∏ª\n\nTHE COMMONPLACE AND THE VULGAR\n(After 3000 credits banked)\n\nIF YOUR SCORE WAS 1701 TO 1800‚Ä¶\n\nYou whispered to snakes and raised a conqueror. Olympias, mother of Alexander the Great, wielder of poison and prophecy. You played the long game‚Äîand lost. Eventually, your enemies stoned you to death, which, by Macedonian standards, was practically a retirement party.\n\nYou were OLYMPIAS, the original tiger mom.\n\n‚∏ª\n\nTHE COMMONPLACE AND THE VULGAR\n(After 3000 credits banked)\n\nIF YOUR SCORE WAS 1801 TO 1900‚Ä¶\n\nNot a looker, but power made you stunning. You married Russia‚Äôs mad heir, had a string of lovers, rewrote the law, and may have rewritten your husband‚Äôs will‚Äîwith a pillow. ‚ÄúIn the saddle‚Äù is not how you died‚Äîbut it‚Äôs how everyone remembers you.\n\nYou were CATHERINE THE GREAT, enlightened despot, empress, and historical exaggeration.\n\n‚∏ª\n\nTHE COMMONPLACE AND THE VULGAR\n(After 3000 credits banked)\n\nIF YOUR SCORE WAS 1901 TO 2000‚Ä¶\n\nEveryone remembers Cleopatra. Few remember you. But you were just as ruthless. You cooked. You spun. You married Augustus while carrying another man‚Äôs baby‚Äîand nobody dared complain. You ruled through men and outlived them all.\n\nYou were LIVIA, the mother of Rome and its most dangerous dinner hostess.\n\n‚∏ª\n\nTHE COMMONPLACE AND THE VULGAR\n(After 3000 credits banked)\n\nIF YOUR SCORE WAS 2001 TO 2100‚Ä¶\n\nYour uncle was emperor. Your empire, vast. Your courage? Negotiable. You mistook steel for prophecy and Cortez for a god. By the time you realized otherwise, the Aztecs were burning and you were being stoned by your own people.\n\nYou were MONTEZUMA, ruler of gold, victim of gullibility.\n\n‚∏ª\n\nTHE COMMONPLACE AND THE VULGAR\n(After 3000 credits banked)\n\nIF YOUR SCORE WAS 2101 TO 2200‚Ä¶\n\nYou made a king weep sonnets. Diane de Poitiers, mistress of Henry II, sculpted in silver by Cellini, immortalized in verse. You aged like fine wine‚Äîuntil the queen tossed you out like spoiled milk.\n\nYou were DIANE DE POITIERS, France‚Äôs most expensive distraction.\n\n‚∏ª\n\nTHE COMMONPLACE AND THE VULGAR\n(After 3000 credits banked)\n\nIF YOUR SCORE WAS 2201 TO 2300‚Ä¶\n\nBorn a Medici, married into French royalty, and hated ever since. You birthed ten children, may have orchestrated a massacre, and never, ever let your enemies die of natural causes.\n\nYou were CATHERINE DE MEDICI, mother of kings, widow of peace.\n\n‚∏ª\n\nTHE COMMONPLACE AND THE VULGAR\n(After 3000 credits banked)\n\nIF YOUR SCORE WAS 2301 TO 2400‚Ä¶\n\nYou came from the circus. You conquered Constantinople. Theodora, striptease legend turned empress, you rewrote laws, saved an empire, and stood your ground during a riot. ‚ÄúPurple makes a fine shroud,‚Äù you said. You weren‚Äôt wrong.\n\nYou were THEODORA, dancer, diva, defender of Byzantium.\n\n‚∏ª\n\nTHE COMMONPLACE AND THE VULGAR\n(After 3000 credits banked)\n\nIF YOUR SCORE WAS 2401 TO 2500‚Ä¶\n\nYou looked like a monster. Spoke like a gentleman. Victorian London couldn‚Äôt decide whether to pity or parade you. Dr. Treves saw the man inside the mask. You died trying to sleep like a human.\n\nYou were JOHN MERRICK, THE ELEPHANT MAN, dignity in a misshapen frame.\n\n‚∏ª\n\nTHE COMMONPLACE AND THE VULGAR\n(After 3000 credits banked)\n\nIF YOUR SCORE WAS 2501 TO 2600‚Ä¶\n\nYou earned the nickname ‚ÄúDesert Fox‚Äù with tactics that made generals sweat. Erwin Rommel, brilliant, honorable, doomed. You joined a plot to kill Hitler. When it failed, he gave you a choice: disgrace or suicide. You chose Roman exit.\n\nYou were ERWIN ROMMEL, Germany‚Äôs reluctant hero.\n\n‚∏ª\n\nTHE COMMONPLACE AND THE VULGAR\n(After 3000 credits banked)\n\nIF YOUR SCORE WAS 2601 TO 2700‚Ä¶\n\nRaised in pagan magic and Christian contradiction, you married King Arthur and brought Camelot to its knees. Whether it was love or lust or prophecy, your name became synonymous with betrayal.\n\nYou were GUINEVERE, queen, sinner, and saint in equal measure.\n\n‚∏ª\n\nTHE COMMONPLACE AND THE VULGAR\n(After 3000 credits banked)\n\nIF YOUR SCORE WAS 2701 TO 2800‚Ä¶\n\nYou wrote pamphlets, got shot, and ignited feminism decades early. Your husband tried to murder you, then defended himself by blaming your face. The jury agreed. France cheered your pain.\n\nYou were FLORA TRISTAN, revolutionary, firebrand, grandmother of Gauguin.\n\n‚∏ª\n\nTHE COMMONPLACE AND THE VULGAR\n(After 3000 credits banked)\n\nIF YOUR SCORE WAS 2801 TO 2900‚Ä¶\n\nYou painted saints who looked like criminals, and criminals who looked like saints. You brawled, you fled, you murdered, and you made light bleed from canvas. The Pope forgave your sins too late. Death found you on a beach, watching your pardon sail away.\n\nYou were CARAVAGGIO, art‚Äôs darkest flame.\n\n‚∏ª\n\nTHE COMMONPLACE AND THE VULGAR\n(After 3000 credits banked)\n\nIF YOUR SCORE WAS 2901 TO 3000‚Ä¶\n\nBorn to rule, married to revolution. Marie Antoinette, Versailles‚Äô queen of couture and catastrophic PR. You never said ‚ÄúLet them eat cake,‚Äù but by the time the guillotine came for you, it didn‚Äôt matter.\n\nYou were MARIE ANTOINETTE, misunderstood, misquoted, magnificently doomed.\n\n\n‚∏ª\n\nHEROES AND HEROINES\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 0 TO 100‚Ä¶\n\nYou were an ascetic, a hermit, and‚Äîmuch to your dismay‚Äîa pope. Born in 1209, you lived in seclusion in the Abruzzi Mountains, founding an order of monks devoted to solitude and prayer. But in 1294, after a two-year deadlock, desperate cardinals plucked your name from obscurity and made you Pope Celestine V.\n\nYou were ill-suited to power. After just five chaotic months, you abdicated‚Äîheeding, you said, the voice of God. In reality, it may have been Cardinal Benedetto Caetani using a clever speaking tube to persuade you to step down. Dante condemned your act as ‚ÄúThe Great Refusal.‚Äù You died in 1296, likely murdered on the orders of your successor‚ÄîPope Boniface VIII.\n\nThe Church later made amends by canonizing you.\nYou were ST. CELESTINE V, the pope who quit.\n\n‚∏ª\n\nHEROES AND HEROINES\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 101 TO 200‚Ä¶\n\nBorn into Maryland aristocracy in 1815, you were expected to remain quiet and well-mannered. You did neither. After hearing Abraham Lincoln speak, you devoted your life to the Union cause.\n\nYou authored influential pamphlets defending Lincoln and became his informal policy advisor. When war broke out, you devised a military strategy‚Äîthe Tennessee Plan‚Äîthat split the Confederacy in two. It was adopted, succeeded, and credited to Ulysses S. Grant. You never married, never protested the theft, and died quietly in 1893.\n\nYou were ANNA ELLA CARROLL, strategist of victory and footnote of history.\n\n‚∏ª\n\nHEROES AND HEROINES\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 201 TO 300‚Ä¶\n\nYou were America‚Äôs first true movie star. Born in Toronto in 1892, you rose to fame in silent films with D.W. Griffith, earning a staggering $10,000 per week. You helped found United Artists alongside Charlie Chaplin, Douglas Fairbanks (your husband), and Griffith‚Äîshocking Hollywood‚Äôs establishment. One executive scoffed, ‚ÄúThe inmates have taken over the asylum.‚Äù\n\nYou created the celebrity home ‚ÄúPickfair,‚Äù ruled over Hollywood society, and became the first female mogul of film. When sound arrived, you stepped away gracefully. You died in 1979, still known as MARY PICKFORD, ‚ÄúAmerica‚Äôs Sweetheart.‚Äù\n\n‚∏ª\n\nHEROES AND HEROINES\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 301 TO 400‚Ä¶\n\nBorn in 1776, you towered over your dainty peers‚Äîathletic, brash, and wildly eccentric. English high society bored you. So, in 1810, after inheriting a modest fortune from your uncle (Prime Minister William Pitt), you set out for the East. You dressed as a man, traveled alone through the Levant, and shocked Damascus by appearing unveiled.\n\nArab leaders called you ‚ÄúQueen of the Desert.‚Äù You dined with sheikhs, explored ruins, and eventually founded a monastery in Lebanon open to all‚Äîexcept Europeans. You died in 1839, mad and penniless.\n\nYou were LADY HESTER STANHOPE, a legend in lace and defiance.\n\n‚∏ª\n\nHEROES AND HEROINES\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 401 TO 500‚Ä¶\n\nCrowned at eighteen, you ruled Sweden not as a queen, but as a sovereign in your own right. Born in 1626, you were fiercely intellectual, inviting Descartes and other great minds to your court. But the crown was a cage. You scandalized Europe by abdicating, dressing as a man, and converting to Catholicism‚Äîan act that sent shudders through Protestant Europe.\n\nYou died in Rome in 1689, beloved by artists and scholars, and remembered for your wit, will, and wild unpredictability.\n\nYou were CHRISTINA, QUEEN OF SWEDEN, monarch turned mystic.\n\n‚∏ª\n\nHEROES AND HEROINES\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 501 TO 600‚Ä¶\n\nBorn around 1040 to minor English nobility, you were known for your grace, humility, and deep compassion for the poor. When you married Leofric, Earl of Mercia, you gained influence‚Äîand used it to protest his oppressive taxation of Coventry‚Äôs citizens.\n\nAs legend tells it, he challenged you: ride naked through the town, and he would lift the taxes. You accepted. Clad in nothing but your long golden hair, you rode in silence. Out of respect, the townspeople shut their windows‚Äîsave for one man, later dubbed ‚ÄúPeeping Tom,‚Äù who was struck blind.\n\nLeofric honored his word. Coventry never forgot.\nYou were LADY GODIVA, protester on horseback.\n\n‚∏ª\n\nHEROES AND HEROINES\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 601 TO 700‚Ä¶\n\nThe face that launched a thousand ships, they said. Around 1200 B.C., you married Menelaus, king of Sparta. But love‚Äîor something like it‚Äîdrew you to Paris of Troy, who spirited you away across the sea.\n\nThe Greeks used you as a pretext to lay siege to Troy for ten brutal years. Your beauty was blamed for the bloodshed, though your voice was rarely heard. Homer cast you in legend; later poets painted you tragic, treacherous, or divine.\n\nYou were HELEN OF TROY, the myth made woman.\n\n‚∏ª\n\nHEROES AND HEROINES\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 701 TO 800‚Ä¶\n\nYour name meant ‚ÄúThe Beautiful One Has Come.‚Äù You were born around 1380 B.C., possibly of foreign nobility‚ÄîMitanni, some say‚Äîand became Great Royal Wife to the heretic pharaoh Akhenaten.\n\nYou ruled beside him during a revolution of religion, as temples closed and sun-worship rose. You bore six daughters, vanished from public record after year 14 of his reign, and may have ruled briefly in your own right.\n\nYour image‚Äîgraceful, elegant, haunting‚Äîsurvives in painted limestone.\nYou were NEFERTITI, beauty, queen, and enigma.\n\n‚∏ª\n\nHEROES AND HEROINES\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 801 TO 900‚Ä¶\n\nBorn in 1797 to Mary Wollstonecraft, pioneer feminist, and William Godwin, radical philosopher, you were brilliance raised in grief. Your mother died days after your birth. At sixteen, you ran off with the married poet Percy Shelley.\n\nOne stormy night in Geneva in 1816, challenged to write a ghost story, you gave the world Frankenstein. You were nineteen. The novel launched modern science fiction‚Äîand a career dogged by scandal, loss, and intellect.\n\nYou were MARY WOLLSTONECRAFT SHELLEY, mother of the monster and the modern Gothic.\n\n‚∏ª\n\nHEROES AND HEROINES\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 901 TO 1000‚Ä¶\n\nYou were born in 1157, second son of Henry II and Eleanor of Aquitaine. You never expected a crown, but destiny had other plans. Tall, dashing, and fiercely brave, you led the Third Crusade, battled Saladin, and earned the admiration of both Christians and Muslims.\n\nThough crowned King of England in 1189, you spent most of your reign abroad, leaving the kingdom to his scheming brother, John. You were captured, ransomed, and killed in a skirmish in 1199.\n\nYou were RICHARD I, THE LIONHEARTED, king of courage, but absentee ruler.\n\n\n‚∏ª\n\nHEROES AND HEROINES\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 1001 TO 1100‚Ä¶\n\nYou lived among courtiers in Japan‚Äôs imperial palace during the Heian period, around 1000 A.D. Behind screens and silk, you observed the court‚Äôs whispers and passions‚Äîand turned them into literature.\n\nWith poetic grace and emotional insight, you penned The Tale of Genji, the world‚Äôs first psychological novel and arguably the first full-length novel ever written. Though your true name was forgotten, your creation shaped Japanese prose for centuries.\n\nYou were LADY MURASAKI SHIKIBU, mother of the novel.\n\n‚∏ª\n\nHEROES AND HEROINES\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 1101 TO 1200‚Ä¶\n\nYou were born in Dublin in 1854 to a surgeon father and a trailblazing mother. By youth, you were already an icon of flamboyance‚Äîblue china, lilies, velvet suits. At Oxford, you dazzled. In London, you conquered. Your plays were as clever as your conversation, and your novel The Picture of Dorian Gray was both praised and scandalized.\n\nBut love and tragedy came in one form: Lord Alfred Douglas. You were arrested in 1895 for ‚Äúgross indecency,‚Äù imprisoned for two years, and emerged broken. You died in exile in 1900, still witty, still brilliant.\n\nYou were OSCAR WILDE, wit of the ages, martyr of elegance.\n\n‚∏ª\n\nHEROES AND HEROINES\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 1201 TO 1300‚Ä¶\n\nBorn around 630 B.C. on the island of Lesbos, you wrote with a voice unmatched in clarity, sensuality, and lyricism. You composed songs of love, longing, and the divine feminine.\n\nYou founded a community of women dedicated to poetry, music, and beauty‚Äîindependent of men. Your poems sparked admiration and censorship alike. Later centuries erased you, but your words endured.\n\nYou were SAPPHO, the Tenth Muse, and the soul of ancient lyricism.\n\n‚∏ª\n\nHEROES AND HEROINES\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 1301 TO 1400‚Ä¶\n\nBorn in 701 A.D. in China‚Äôs Sichuan province, you lived as if the world were a poem‚Äîand you its windblown verse. A court favorite and Taoist wanderer, you turned drunkenness into philosophy and moonlight into metaphor.\n\nYou rejected wealth and status in favor of rivers and dreams. Your verses praised immortals and mocked officials, and your death was as poetic as your life: you drowned trying to embrace the moon‚Äôs reflection in a lake.\n\nYou were LI PO, the Banished Immortal, China‚Äôs lyrical spirit.\n\n‚∏ª\n\nHEROES AND HEROINES\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 1401 TO 1500‚Ä¶\n\nYou were born in Boston in 1809, a child of actors and a life of abandonment. Adopted by a wealthy merchant, you found little love‚Äîand less stability. Your wife Virginia died young; grief never left your pen.\n\nYou created the detective story, redefined American criticism, and turned terror into poetry. From The Raven to The Tell-Tale Heart, your work haunts literature.\n\nYou died alone and delirious in 1849, claiming the wallpaper was winning.\nYou were EDGAR ALLAN POE, prophet of shadows and sorrow.\n\n‚∏ª\n\nHEROES AND HEROINES\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 1501 TO 1600‚Ä¶\n\nYou ruled as an empress‚Äîbut not by birthright. Born in 1835 to a minor Manchu family, you became a low-ranking concubine in the Forbidden City. Yet you bore the emperor his only surviving son, and with that, seized power.\n\nYou outmaneuvered your rivals with brilliance and ruthlessness, becoming de facto ruler of China for nearly five decades. You crushed reformers, later embraced reform, fled invading armies, and returned in glory. Your critics saw decadence and corruption. Your admirers saw survival against impossible odds.\n\nYou were T‚ÄôZU HSI, the Dragon Empress who held a crumbling empire together.\n\n‚∏ª\n\nHEROES AND HEROINES\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 1601 TO 1700‚Ä¶\n\nBorn in 1452 during England‚Äôs Wars of the Roses, you were crowned king in turbulent times. You ruled justly‚Äîbut your enemies painted you in poison. William Shakespeare turned you into a deformed villain, a murderer of nephews, and a tyrant.\n\nIn truth, you enacted progressive reforms, championed justice, and died honorably at the Battle of Bosworth Field‚Äîfighting against the rising Tudor tide. Centuries later, your body was found beneath a parking lot.\n\nYou were RICHARD III, England‚Äôs most misunderstood monarch.\n\n‚∏ª\n\nHEROES AND HEROINES\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 1701 TO 1800‚Ä¶\n\nYou were brilliant, fiercely educated, and destined for heartbreak. Born in 1101, niece to a high-ranking church official, you met Peter Abelard‚Äîphilosopher, teacher, and flame. Your love affair with him scandalized medieval France.\n\nAfter bearing his child in secret, your uncle had him castrated. You entered a convent; he entered a monastery. The two of you never met again, but your letters‚Äîpassionate, aching, philosophical‚Äîstill echo through time.\n\nYou were H√âLO√èSE, lover, scholar, and soul immortalized in ink.\n\n‚∏ª\n\nHEROES AND HEROINES\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 1801 TO 1900‚Ä¶\n\nBorn in 1897 in Atchison, Kansas, you defied gravity and convention. You were the first woman to fly solo across the Atlantic. You set records, thrilled crowds, and became America‚Äôs airborne sweetheart.\n\nYou were also disorganized, chronically late, and occasionally reckless. In 1937, attempting to circumnavigate the globe, you vanished over the Pacific with navigator Fred Noonan. No wreckage, no remains‚Äîonly legend.\n\nYou were AMELIA EARHART, the sky‚Äôs most enduring mystery.\n\n‚∏ª\n\nHEROES AND HEROINES\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 1901 TO 2000‚Ä¶\n\nBorn in 1503 in France, you trained as a physician but became history‚Äôs most famous prophet. You treated plague victims, dabbled in astrology, and published The Centuries‚Äîa cryptic book of poetic quatrains.\n\nMany claim you predicted everything from the rise of Napoleon to 9/11. Skeptics call it coincidence; believers see the divine. Either way, your name became shorthand for ominous prophecy.\n\nYou were NOSTRADAMUS, the oracle of ages.\n\n‚∏ª\n\nHEROES AND HEROINES\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 2001 TO 2100‚Ä¶\n\nYou were born to legend and wrapped in mystery. A 6th-century British warlord, perhaps, who led warriors against the invading Saxons. But it was not your sword that made you immortal‚Äîit was the myth that grew around you.\n\nA sword in stone. A round table. A queen, a betrayal, and a dream of Camelot. Merlin guided you, Excalibur crowned you, and Avalon took you in death. Whether real or imagined, you became the standard for noble kingship.\n\nYou were KING ARTHUR, the Once and Future King.\n\n‚∏ª\n\nHEROES AND HEROINES\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 2101 TO 2200‚Ä¶\n\nYou were the son of Erik the Red, born in the late 10th century in Greenland. Bold, curious, and bound for the unknown, you crossed the sea and landed on the shores of North America‚Äînearly 500 years before Columbus.\n\nYou named it Vinland, likely Nova Scotia, and traded with native peoples. But your colony was short-lived, and your discovery faded into saga. Still, your legend outlived you.\n\nYou were LEIF ERIKSON, first European to reach the New World.\n\n‚∏ª\n\nHEROES AND HEROINES\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 2201 TO 2300‚Ä¶\n\nYou were born Araminta Ross around 1822, enslaved in Maryland and whipped before you were ten. But your spirit couldn‚Äôt be chained. You escaped north‚Äîthen returned, again and again, risking death to guide others to freedom.\n\nYou never lost a passenger on your Underground Railroad. You became a spy, a nurse, and a Union scout during the Civil War. Later, you fought for women‚Äôs suffrage with the same fire you used to fight slavery.\n\nYou were HARRIET TUBMAN, the conductor of liberation.\n\n‚∏ª\n\nHEROES AND HEROINES\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 2301 TO 2400‚Ä¶\n\nYou were born in 1897 in Kansas, a girl with wind in her veins. You broke barriers with your courage, not your skill. You flew solo across the Atlantic, smiled for cameras, and made the world believe women could do anything.\n\nYou also crashed frequently, lost your navigation charts mid-flight, and insisted on a final journey around the globe. In 1937, somewhere over the Pacific, you vanished into myth.\n\nYou were AMELIA EARHART, fearless flier and eternal mystery.\n\n‚∏ª\n\nHEROES AND HEROINES\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 2401 TO 2500‚Ä¶\n\nYou were born in 1503 in France. A healer by trade, a visionary by reputation. You treated plague victims without fear and studied the stars with a scholar‚Äôs mind. In 1555, you published The Centuries, a cryptic book of quatrains that the world still tries to decode.\n\nYou predicted disaster and empire. Or maybe you just made it sound poetic enough to fit any future. You died in 1566, already a legend.\n\nYou were NOSTRADAMUS, the prophet of riddles and shadows.\n\n‚∏ª\n\nHEROES AND HEROINES\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 2501 TO 2600‚Ä¶\n\nWhether myth or man, you became the soul of a kingdom that never quite was. A Welsh war leader in the 6th or 7th century, you stood between a crumbling Roman Britain and the advancing Saxons‚Äîunifying fractured tribes into a fragile hope.\n\nLater tales draped you in magic: Merlin at your side, Excalibur in your hand, Camelot in your heart. But even dreams break. Your queen betrayed you. Your best knight broke your trust. Your kingdom fell, but your legend did not.\n\nYou were KING ARTHUR, ruler of the Once and Future Kingdom.\n\n‚∏ª\n\nHEROES AND HEROINES\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 2601 TO 2700‚Ä¶\n\nHistory didn‚Äôt crown you, but saga did. Born around 970 AD, son of Erik the Red, you left Greenland behind to sail west‚Äîinto fog, ice, and the unknown. You reached a land of timber and wild grapes, which you called Vinland. Today, we call it North America.\n\nYou didn‚Äôt conquer. You didn‚Äôt colonize. You explored, then returned home, content with proof rather than empire. Columbus may have gotten the parades, but you got there first.\n\nYou were LEIF ERIKSON, the Norse navigator of new worlds.\n\n‚∏ª\n\nHEROES AND HEROINES\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 2701 TO 2800‚Ä¶\n\nYou were born Araminta Ross around 1822, into chains in Maryland. Beaten, hunted, and denied your humanity, you escaped captivity‚Äîthen chose to return, again and again, leading others through the darkness toward freedom.\n\nYou never lost a soul on your Underground Railroad. You spied for the Union, led raids, nursed the wounded, and later marched for women‚Äôs rights with the same quiet fire. When they offered to name a monument after you, you said, ‚ÄúGive me a home.‚Äù\n\nYou were HARRIET TUBMAN, the conductor of liberation.\n\n‚∏ª\n\nHEROES AND HEROINES\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 2801 TO 2900‚Ä¶\n\nAs Emperor Shah Jahan, you ruled the Mughal Empire with opulence and power. But your true legacy was love. You married Mumtaz Mahal‚Äîwife, confidante, and soulmate. She bore you fourteen children, then died in childbirth. You were undone.\n\nTo honor her, you built the Taj Mahal: a perfect white marble mausoleum, unmatched in beauty. You planned a twin in black stone for yourself across the river‚Äîbut your son imprisoned you before it could rise. You spent your final years gazing at her tomb from a tower.\n\nYou were SHAH JAHAN, lover turned legend, builder of the world‚Äôs greatest monument to grief.\n\n‚∏ª\n\nHEROES AND HEROINES\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 2901 TO 3000‚Ä¶\n\nBorn in 1711, you became the Qianlong Emperor‚Äîruler of Qing China and architect of its golden age. You expanded borders, suppressed uprisings, welcomed Jesuit scientists, and assembled the greatest literary collection in Chinese history.\n\nYou wrote 40,000 poems, shaped culture, and voluntarily abdicated‚Äîrefusing to reign longer than your grandfather. But your twilight years dimmed under corruption, as your favorite, Heshen, bled the empire dry.\n\nStill, you are remembered not for how your reign ended‚Äîbut for how magnificently it soared.\n\nYou were CH‚ÄôIEN LUNG, China‚Äôs philosopher-king.\n\n‚∏ª\n\nTHE GREAT AND THE SAINTLY\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 0 TO 100‚Ä¶\n\nBorn in 287 A.D. in Asia Minor, you were a soldier in the Roman army who refused to kill for the empire. When Diocletian ordered Christians to be purged, you laid down your sword and embraced your fate.\n\nStripped, tied to a tree, and shot full of arrows, you miraculously survived. Nursed back to health, you returned to publicly condemn the emperor‚Äîwho had you beaten to death.\n\nYou were SAINT SEBASTIAN, martyr twice over.\n\n‚∏ª\n\nTHE GREAT AND THE SAINTLY\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 101 TO 200‚Ä¶\n\nYou were born to Persian nobility but gave it up for a monk‚Äôs robes. Traveling to the Indian subcontinent, you built schools, healed the sick, and translated sacred texts.\n\nThough legend clouded your story, your message transcended borders: compassion, service, and universal love.\n\nYou were BODHISATTVA PADMASAMBHAVA, the lotus-born, bringer of the Dharma to Tibet.\n\n‚∏ª\n\nTHE GREAT AND THE SAINTLY\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 201 TO 300‚Ä¶\n\nYou were born in the slums of Calcutta and touched by something larger than life. You walked barefoot into the alleys and stayed there, bathing the dying, comforting the unwanted, and reminding the world that dignity begins with care.\n\nCritics called you a saint. Others called you dangerous. You ignored them all and kept working.\n\nYou were MOTHER TERESA, the hands of mercy.\n\n‚∏ª\n\nTHE GREAT AND THE SAINTLY\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 301 TO 400‚Ä¶\n\nThey called you the Enlightened One. Born Siddhartha Gautama, a prince of luxury, you renounced it all in search of truth. You meditated beneath a Bodhi tree until desire dissolved and the path was revealed.\n\nYou taught no gods, no violence‚Äîjust the end of suffering.\n\nYou were THE BUDDHA, the awakened teacher of peace.\n\n‚∏ª\n\nTHE GREAT AND THE SAINTLY\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 401 TO 500‚Ä¶\n\nYou were born to a poor family in Assisi in the 12th century. After a lavish youth, you heard God speak through the ruins of a church. You cast off your wealth, donned a simple robe, and walked barefoot into history.\n\nYou preached to birds, made peace with wolves, and embraced the lepers no one else would touch. You changed the Church from within‚Äînot with force, but with humility.\n\nYou were SAINT FRANCIS OF ASSISI, lover of all creation.\n\n‚∏ª\n\nTHE GREAT AND THE SAINTLY\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 501 TO 600‚Ä¶\n\nBorn in 354 A.D. in North Africa, you chased every pleasure‚Äîwine, women, and worldly fame. But the deeper you drank, the more hollow you felt. One day, in a garden, you heard a voice: ‚ÄúTake and read.‚Äù You opened the Bible and found your soul.\n\nYou became a bishop, a philosopher, and the first great psychologist of the West. You gave Western thought its conscience.\n\nYou were SAINT AUGUSTINE, sinner turned sage.\n\n‚∏ª\n\nTHE GREAT AND THE SAINTLY\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 601 TO 700‚Ä¶\n\nYou were a queen in name, but a mystic by nature. Born in 1098, you composed music that rang through cloisters and cathedrals, saw visions that terrified even popes, and wrote with a clarity few could match.\n\nThey called you Sibyl of the Rhine. You called yourself a feather on the breath of God.\n\nYou were HILDEGARD OF BINGEN, seer, composer, and spiritual firebrand.\n\n‚∏ª\n\nTHE GREAT AND THE SAINTLY\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 701 TO 800‚Ä¶\n\nBorn to a poor Corsican family in 1805, you became a quiet seamstress, a caretaker‚Äîand then, a saint. In a small grotto near Lourdes, you saw a vision of a lady in white. The Church doubted. The doctors scoffed. The crowds grew.\n\nWhen the spring appeared, and the healings began, no one scoffed anymore.\n\nYou were BERNADETTE SOUBIROUS, the humble witness to the Immaculate Conception.\n\n‚∏ª\n\nTHE GREAT AND THE SAINTLY\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 801 TO 900‚Ä¶\n\nYou were born in Mecca, orphaned young, and entrusted with trade caravans by those who admired your honesty. One night in a cave, an angel brought you a revelation. You returned to your people with a message: surrender to one God, treat others justly, and live with purpose.\n\nYou founded a religion, led armies, brokered peace, and recited verses that still shape a quarter of humanity.\n\nYou were THE PROPHET MUHAMMAD, the final messenger.\n\n‚∏ª\n\nTHE GREAT AND THE SAINTLY\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 901 TO 1000‚Ä¶\n\nYou were born around 4 B.C. in Bethlehem, raised by a carpenter, and baptized in the Jordan. You healed the sick, turned the other cheek, and taught the meek would inherit the Earth.\n\nYou defied Rome with no sword, only love‚Äîand paid for it with your life. And somehow, your death became the cornerstone of a global faith.\n\nYou were JESUS OF NAZARETH, teacher, redeemer, and revolutionary.\n\n‚∏ª\n\nTHE GREAT AND THE SAINTLY\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 1001 TO 1100‚Ä¶\n\nYou were born in Bethlehem‚Äîbut this time, to feed the world. In the 13th century, while most monks prayed behind stone walls, you walked into battlefields and begged for peace.\n\nYou didn‚Äôt preach God from a throne‚Äîyou found him in the poor. You asked nothing but faith, offered nothing but love.\n\nYou were ST. FRANCIS OF ASSISI, again‚Äîfor some souls are twice blessed.\n\n‚∏ª\n\nTHE GREAT AND THE SAINTLY\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 1101 TO 1200‚Ä¶\n\nYou were born into luxury in 6th-century India. But as Prince Siddhartha, you saw suffering and left it all behind. Through silence and insight, you transcended pain‚Äîand taught the world that peace lies not in desire, but in its release.\n\nYou were THE BUDDHA, and your journey became the path.\n\n‚∏ª\n\nTHE GREAT AND THE SAINTLY\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 1201 TO 1300‚Ä¶\n\nBorn into chaos and crowned by fire, you led your people through plagues and wars not with armies, but with wisdom. You taught that salvation comes not through dominance, but through compassion.\n\nYour name lives in whispered prayer, etched in candlelight, painted in gold leaf, and written on the wind.\n\nYou were THE DALAI LAMA, the reincarnation of peace.\n\n‚∏ª\n\nTHE GREAT AND THE SAINTLY\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 1301 TO 1400‚Ä¶\n\nYou didn‚Äôt build churches. You fed the hungry, washed the sick, held the dying, and loved without judgment.\n\nYou were never canonized, but heaven knew your name. You were the neighbor, the stranger, the parent, the stranger who stayed behind to help.\n\nYou were UNKNOWN, but not unloved.\n\n‚∏ª\n\nTHE GREAT AND THE SAINTLY\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 1401 TO 1500‚Ä¶\n\nYou gave birth in a refugee tent, pulled children from rubble, stitched wounds with torn cloth. You taught in prisons, nursed plague victims, gave your last coin to someone with less.\n\nYou prayed not with words, but with action. The world didn‚Äôt know your story. But the world was better because of it.\n\nYou were EVERYDAY SAINT, whose halo was hidden in sweat and kindness.\n\n‚∏ª\n\nTHE GREAT AND THE SAINTLY\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 1501 TO 1600‚Ä¶\n\nYou never led a nation. You never spoke on a stage. But your son changed the world, and it was your patience that shaped him.\n\nYou were the hand behind the miracle, the breath behind the prophet, the stillness behind the voice.\n\nYou were MARY, mother of sorrows, vessel of hope.\n\n‚∏ª\n\nTHE GREAT AND THE SAINTLY\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 1601 TO 1700‚Ä¶\n\nYou wrote no scripture. You fought no war. But when everyone else turned away, you stepped forward.\n\nYou took the leper‚Äôs hand. You sat beside the condemned. You forgave when no one asked you to. You loved where others judged.\n\nYou were COMPASSION, walking in human form.\n\n‚∏ª\n\nTHE GREAT AND THE SAINTLY\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 1701 TO 1800‚Ä¶\n\nBorn into violence, you ended it. Faced with hatred, you answered with soul. You preached from steps, marched on Washington, and dreamed of a world your killers couldn‚Äôt stop.\n\nYou were jailed, beaten, and finally gunned down‚Äîbut you never raised a fist.\n\nYou were MARTIN LUTHER KING JR., prophet of justice.\n\n‚∏ª\n\nTHE GREAT AND THE SAINTLY\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 1801 TO 1900‚Ä¶\n\nYou never left your village. But you gave bread to strangers, named stars for your children, and taught your neighbors to read.\n\nThe angels watched your life unfold and said: ‚ÄúThis, too, is grace.‚Äù\n\nYou were THE SAINT WITH NO STATUE, and you are everywhere.\n\n‚∏ª\n\nTHE GREAT AND THE SAINTLY\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 1901 TO 2000‚Ä¶\n\nYou never spoke‚Äîbut you listened. You never moved‚Äîbut you were held. Your life was short‚Äîbut your touch changed others. You were born with pain, lived with silence, and taught the world that every soul has value.\n\nYou were THE CHILD WHO SUFFERED, and through you, others became human.\n\n‚∏ª\n\nTHE GREAT AND THE SAINTLY\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 2001 TO 2100‚Ä¶\n\nBorn around 1452 in Vinci, Italy, you saw the world not as it was‚Äîbut as it could be. Painter, engineer, anatomist, dreamer, you left behind notebooks bursting with machines, anatomy, and ideas too advanced for your time.\n\nYou painted The Last Supper and The Mona Lisa. You imagined helicopters and submarines. And through it all, you asked questions no one else dared.\n\nYou were LEONARDO DA VINCI, the mind that bridged heaven and earth.\n\n‚∏ª\n\nTHE GREAT AND THE SAINTLY\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 2101 TO 2200‚Ä¶\n\nBorn in 384 B.C. in Macedon, you studied under Plato and taught a boy who would conquer the world‚ÄîAlexander the Great. But your own conquest was of the mind.\n\nYou categorized plants, animals, ethics, logic, and politics. You didn‚Äôt invent philosophy‚Äîbut you gave it structure. You made curiosity a discipline.\n\nYou were ARISTOTLE, tutor of kings, father of knowledge.\n\n‚∏ª\n\nTHE GREAT AND THE SAINTLY\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 2201 TO 2300‚Ä¶\n\nBorn in 551 B.C. in the Lu state of ancient China, you wandered war-torn lands teaching respect, duty, and the harmony of the human heart.\n\nYou never led an army. You never ruled a kingdom. Yet emperors bowed to your ideas for two millennia. You believed order began in the family‚Äîand radiated outward to the world.\n\nYou were CONFUCIUS, the quiet compass of civilization.\n\n‚∏ª\n\nTHE GREAT AND THE SAINTLY\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 2301 TO 2400‚Ä¶\n\nYou were born in Stratford-upon-Avon in 1564 and vanished into history with barely a signature. But your words never left. You shaped language, thought, and the very soul of theater.\n\nYou held a mirror to kings and clowns alike. You showed us ambition, madness, mercy, and love. Your pen made the human condition art.\n\nYou were WILLIAM SHAKESPEARE, the bard of every soul.\n\n‚∏ª\n\nTHE GREAT AND THE SAINTLY\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 2401 TO 2500‚Ä¶\n\nBorn in 356 B.C. in Macedon, you were a king by 20, a god to some by 30. You never lost a battle. You crossed the known world with speed, strategy, and charisma. You named cities after yourself‚Äîand one after your horse.\n\nBut you weren‚Äôt just a conqueror. You spread culture, blended worlds, and dreamed of unifying mankind. You died young, but your legend outlived every empire.\n\nYou were ALEXANDER THE GREAT, thunderbolt of the ancient world.\n\n‚∏ª\n\nTHE GREAT AND THE SAINTLY\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 2501 TO 2600‚Ä¶\n\nYou were worshipped in ancient Egypt not as a queen‚Äîbut as a goddess. Your tears were said to form the Nile. Your magic revived the dead. You brought your husband Osiris back from death, conceived Horus, and shaped the mythic structure of rebirth.\n\nYou were protector, healer, mother, and queen of heaven.\n\nYou were ISIS, The Lady of a Thousand Names.\n\n‚∏ª\n\nTHE GREAT AND THE SAINTLY\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 2601 TO 2700‚Ä¶\n\nBorn in 1879, you redefined reality. You saw that time bent, space curved, and energy and matter were the same dance. You worked in a patent office‚Äîthen changed the world.\n\nYour theories birthed modern physics. But when your genius was used to split the atom, you mourned. You spoke for peace, for Zion, for humility.\n\nYou were ALBERT EINSTEIN, the reluctant prophet of the atomic age.\n\n‚∏ª\n\nTHE GREAT AND THE SAINTLY\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 2701 TO 2800‚Ä¶\n\nYou wore homespun cloth and walked barefoot. You led a nation not with guns, but with salt. You fought empire with silence, injustice with dignity. You were jailed, beaten, mocked‚Äîand never lifted a fist.\n\nWhen India broke free, you refused power. And when bullets found you, your last word was ‚ÄúRam.‚Äù\n\nYou were MOHANDAS GANDHI, the soul-force of a nation.\n\n‚∏ª\n\nTHE GREAT AND THE SAINTLY\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 2801 TO 2900‚Ä¶\n\nYou were born in Georgia in 1929, with a voice like thunder and a dream that shook marble columns. You preached love, while surrounded by hate. You marched through fire, faced bombs and bullets, and never wavered.\n\nYou lifted the conscience of a nation‚Äîand paid for it with your life.\n\nYou were MARTIN LUTHER KING JR., the dreamer who made justice speak.\n\n‚∏ª\n\nTHE GREAT AND THE SAINTLY\n(After 6000 credits banked)\n\nIF YOUR SCORE WAS 2901 TO 3000‚Ä¶\n\nYou were never crowned, never canonized, and never recorded in any book. But your love lit a village. Your sacrifice saved a stranger. Your gentleness turned away wrath.\n\nYou were a parent who fed the hungry. A child who forgave cruelty. A nameless soul who lifted another from despair.\n\nYou were THE UNKNOWN SAINT, the light no history could dim.\n\n‚∏ª\n\n`;
            pastLifeTextsData = parsePastLifeRawData(pastLifeRawDataString);
            initGame();
            // Start screen music will now attempt to play when the menu loads.
        };
        
        // Generate board path to end at (15,0) (top-right) for Nirvana
        // Path uses top 11 rows (y=0 to y=10), blank squares at bottom (y=11 to y=15)
        function generateBoardPath() {
            const path = new Array(170); // Path has 170 elements
            const totalSquares = 170;
            const numCols = 16;

            let currentX = numCols - 1; // Start filling from (15,0) for path[169] (Nirvana)
            let currentY = 0;           // Start at y=0 (top row)
            let direction = -1; // Fill this row (y=0) from Right to Left (for the generation process)
                                // So, player path on y=0 will be L->R, ending at (15,0)

            for (let i = totalSquares - 1; i >= 0; i--) { // Iterate from index 169 down to 0
                path[i] = { x: currentX, y: currentY };

                if (i > 0) { // Don't calculate next position if we just placed path[0]
                    currentX += direction;

                    if (direction === -1 && currentX < 0) { // Moved past left edge (e.g., path[154] placed at (0,0), currentX becomes -1)
                        currentY++; // Move to the next row "down" (for generation process, e.g., y=1)
                        direction = 1; // Change fill direction to L->R for this new row (y=1)
                        currentX = 0; // Set X to the leftmost column (0)
                    } else if (direction === 1 && currentX >= numCols) { // Moved past right edge (e.g., path[138] placed at (15,1), currentX becomes 16)
                        currentY++; // Move to the next row "down" (e.g., y=2)
                        direction = -1; // Change fill direction to R->L for this new row (y=2)
                        currentX = numCols - 1; // Set X to the rightmost column (15)
                    }
                }
            }
            return path;
        }
        
        const boardPath = generateBoardPath();
        
        // Cell types and their effects
        const cellTypes = [
            { name: 'Start', effect: 'Begin your journey', color: '#4CAF50', probability: 0 },
            { name: 'Title', effect: 'Gain 200 credits and option to buy insurance', color: '#3F51B5', probability: 0 },
            { name: 'Treasure', effect: 'Pay 100 credits to draw a treasure card', color: '#4CAF50', probability: 0 },
            { name: 'Twist of Fate', effect: 'Draw a twist of fate card', color: '#2196F3', probability: 0 },
            { name: 'Robbery', effect: 'Steal one hidden treasure from another player', color: '#F44336', probability: 0 },
            { name: 'Vengeance', effect: 'Steal 200 credits from another player', color: '#FF5722', probability: 0 },
            { name: 'Time Portal', effect: 'Jump forward or backward in time', color: '#00BCD4', probability: 0 },
            { name: 'Sudden Death', effect: 'Lose all unless insured', color: '#9C27B0', probability: 0 },
            { name: 'Gamble', effect: 'Risk credits for a reward or loss', color: '#795548', probability: 0 },
            { name: 'Major Treasure', effect: 'Collect high-value treasure', color: '#FFC107', probability: 0 },
            { name: 'Hazard', effect: 'Lose a turn', color: '#607D8B', probability: 0 },
            { name: 'Lucky Day', effect: 'Roll again. Move forward or backward, your choice. Gain 100 credits.', color: '#8BC34A', probability: 0 },
            { name: 'Evil Eye', effect: 'Duel another player for a treasure', color: '#673AB7', probability: 0 },
            { name: 'Charity', effect: 'Collect forfeited cards and credits', color: '#FFEB3B', probability: 0 },
            { name: 'Nirvana', effect: 'First player to reach ends the game', color: '#E91E63', probability: 0 },
            { name: 'Roll Again', effect: 'Roll the dice again', color: '#009688', probability: 0 },
            { name: 'Barter', effect: 'Trade one treasure for another random one', color: '#FF9800', probability: 0 },
            { name: 'Blank', effect: 'Transition Space', color: '#BDBDBD', probability: 0 }
        ];
        
        // Raw Twist Card Data (to be parsed)
        const twistCardDataRaw_Player = `Ancient Times\tLose a turn\t\tYou‚Äôre trapped in a philosophical debate. Lose one turn.\nAncient Times\tCollect\t25\tYour harvest pleases the gods. Collect 25.\nAncient Times\tCollect\t150\tJulius Caesar sponsors your poetry. Collect 150.\nAncient Times\tPay\t100\tYou lose a bet on chariot racing. Pay 100.\nAncient Times\tPay\t200\tYou are fined for pyramid graffiti. Pay 200.\nAncient Times\tPay\t25\tBarbarian toll collectors mug you. Pay 25.\nAncient Times\tRoll again\t\tZeus blesses your sandals ‚Äì move swiftly. Roll again.\nAncient Times\tCollect\t25\tYou discover a long-lost scroll of value. Collect 25.\nAncient Times\tLose a turn\t\tBitten by a sacred ibis ‚Äì you must rest. Lose one turn.\nAncient Times\tCollect\t200\tJulius Caesar sponsors your poetry. Collect 200.\nAncient Times\tPay\t50\tThe Pharaoh taxes your tomb plans. Pay 50.\nAncient Times\tCollect\t200\tYou win the Olympic 'Debate Sprint'. Collect 200.\nAncient Times\tCollect\t150\tYour harvest pleases the gods. Collect 150.\nAncient Times\tCollect\t100\tYour mosaics win the Colosseum art contest. Collect 100.\nAncient Times\tCollect\t25\tYou win the Olympic 'Debate Sprint'. Collect 25.\nAncient Times\tPay\t25\tYou are fined for pyramid graffiti. Pay 25.\nAncient Times\tPay\t100\tYou must bribe a Roman senator. Pay 100.\nAncient Times\tCollect\t50\tYour mosaics win the Colosseum art contest. Collect 50.\nAncient Times\tCollect\t50\tYou win the Olympic 'Debate Sprint'. Collect 50.\nAncient Times\tPay\t150\tYou are fined for pyramid graffiti. Pay 150.\nAncient Times\tCollect\t100\tJulius Caesar sponsors your poetry. Collect 100.\nAncient Times\tPay\t200\tYou must bribe a Roman senator. Pay 200.\nAncient Times\tCollect\t150\tYou win the Olympic 'Debate Sprint'. Collect 150.\nAncient Times\tPay\t150\tThe Pharaoh taxes your tomb plans. Pay 150.\nAncient Times\tPay\t100\tBarbarian toll collectors mug you. Pay 100.\nAncient Times\tCollect\t50\tJulius Caesar sponsors your poetry. Collect 50.\nAncient Times\tPay\t50\tYou must bribe a Roman senator. Pay 50.\nAncient Times\tPay\t50\tBarbarian toll collectors mug you. Pay 50.\nAncient Times\tPay\t200\tYou lose a bet on chariot racing. Pay 200.\nAncient Times\tCollect\t50\tYou discover a long-lost scroll of value. Collect 50.\nAncient Times\tPay\t150\tYou lose a bet on chariot racing. Pay 150.\nAncient Times\tPay\t25\tYou must bribe a Roman senator. Pay 25.\nAncient Times\tPay\t150\tYou must bribe a Roman senator. Pay 150.\nAncient Times\tPay\t50\tYou lose a bet on chariot racing. Pay 50.\nAncient Times\tPay\t50\tYou are fined for pyramid graffiti. Pay 50.\nAncient Times\tCollect\t25\tJulius Caesar sponsors your poetry. Collect 25.\nAncient Times\tPay\t150\tBarbarian toll collectors mug you. Pay 150.\nAncient Times\tPay\t200\tBarbarian toll collectors mug you. Pay 200.\nAncient Times\tCollect\t100\tYou discover a long-lost scroll of value. Collect 100.\nAncient Times\tCollect\t200\tYour mosaics win the Colosseum art contest. Collect 200.\nAncient Times\tCollect\t150\tYour mosaics win the Colosseum art contest. Collect 150.\nAncient Times\tCollect\t100\tYou win the Olympic 'Debate Sprint'. Collect 100.\nAncient Times\tPay\t100\tThe Pharaoh taxes your tomb plans. Pay 100.\nAncient Times\tPay\t25\tThe Pharaoh taxes your tomb plans. Pay 25.\nAncient Times\tPay\t100\tYou are fined for pyramid graffiti. Pay 100.\nAncient Times\tCollect\t150\tYou discover a long-lost scroll of value. Collect 150.\nAncient Times\tCollect\t50\tYour harvest pleases the gods. Collect 50.\nAncient Times\tCollect\t200\tYour harvest pleases the gods. Collect 200.\nAncient Times\tCollect\t200\tYou discover a long-lost scroll of value. Collect 200.\nAncient Times\tPay\t200\tThe Pharaoh taxes your tomb plans. Pay 200.\nDark Ages\tCollect\t150\tYou win a joust in the mud pit. Collect 150.\nDark Ages\tLose a turn\t\tStuck in castle moat traffic ‚Äì miss a turn. Lose one turn.\nDark Ages\tPay\t100\tYou donate to the Brotherhood of Slightly Itchy Robes. Pay 100.\nDark Ages\tLose a turn\t\tYou catch the plague at a renaissance fair. Lose one turn.\nDark Ages\tCollect\t50\tYou survive tax season ‚Äì barely. Collect 50.\nDark Ages\tPay\t100\tInquisition taxes your imagination. Pay 100.\nDark Ages\tPay\t200\tYou donate to the Brotherhood of Slightly Itchy Robes. Pay 200.\nDark Ages\tCollect\t25\tThe Bishop loves your stained glass art. Collect 25.\nDark Ages\tPay\t50\tLeeches treatment isn‚Äôt covered by medieval insurance. Pay 50.\nDark Ages\tPay\t25\tLeeches treatment isn‚Äôt covered by medieval insurance. Pay 25.\nDark Ages\tRoll again\t\tYou find a secret passage in the dungeon! Roll again.\nDark Ages\tCollect\t100\tYour pig wins best in show! Collect 100.\nDark Ages\tPay\t200\tLeeches treatment isn‚Äôt covered by medieval insurance. Pay 200.\nDark Ages\tCollect\t150\tYour pig wins best in show! Collect 150.\nDark Ages\tCollect\t100\tYou win a joust in the mud pit. Collect 100.\nDark Ages\tPay\t50\tInquisition taxes your imagination. Pay 50.\nDark Ages\tPay\t200\tYou‚Äôre fined for playing forbidden lute music. Pay 200.\nDark Ages\tPay\t150\tYou‚Äôre fined for playing forbidden lute music. Pay 150.\nDark Ages\tCollect\t50\tYour pig wins best in show! Collect 50.\nDark Ages\tRoll again\t\tWizard blesses your dice ‚Äì go again. Roll again.\nDark Ages\tCollect\t150\tYour ale wins the pub fair prize. Collect 150.\nDark Ages\tPay\t100\tYou‚Äôre fined for playing forbidden lute music. Pay 100.\nDark Ages\tCollect\t50\tYou win a joust in the mud pit. Collect 50.\nDark Ages\tCollect\t200\tYou win a joust in the mud pit. Collect 200.\nDark Ages\tCollect\t100\tYou survive tax season ‚Äì barely. Collect 100.\nDark Ages\tPay\t50\tYou donate to the Brotherhood of Slightly Itchy Robes. Pay 50.\nDark Ages\tPay\t150\tYou must pay a scribe to fake your family tree. Pay 150.\nDark Ages\tCollect\t200\tThe Bishop loves your stained glass art. Collect 200.\nDark Ages\tPay\t150\tYou donate to the Brotherhood of Slightly Itchy Robes. Pay 150.\nDark Ages\tCollect\t25\tYou win a joust in the mud pit. Collect 25.\nDark Ages\tPay\t25\tYou must pay a scribe to fake your family tree. Pay 25.\nDark Ages\tPay\t150\tLeeches treatment isn‚Äôt covered by medieval insurance. Pay 150.\nDark Ages\tCollect\t50\tThe Bishop loves your stained glass art. Collect 50.\nDark Ages\tPay\t200\tInquisition taxes your imagination. Pay 200.\nDark Ages\tCollect\t200\tYour pig wins best in show! Collect 200.\nDark Ages\tPay\t25\tInquisition taxes your imagination. Pay 25.\nDark Ages\tPay\t50\tYou must pay a scribe to fake your family tree. Pay 50.\nDark Ages\tPay\t100\tLeeches treatment isn‚Äôt covered by medieval insurance. Pay 100.\nDark Ages\tPay\t25\tYou donate to the Brotherhood of Slightly Itchy Robes. Pay 25.\nDark Ages\tCollect\t25\tYour pig wins best in show! Collect 25.\nDark Ages\tCollect\t150\tYou survive tax season ‚Äì barely. Collect 150.\nDark Ages\tPay\t150\tInquisition taxes your imagination. Pay 150.\nDark Ages\tPay\t25\tYou‚Äôre fined for playing forbidden lute music. Pay 25.\nDark Ages\tPay\t200\tYou must pay a scribe to fake your family tree. Pay 200.\nDark Ages\tCollect\t50\tYour ale wins the pub fair prize. Collect 50.\nDark Ages\tPay\t100\tYou must pay a scribe to fake your family tree. Pay 100.\nDark Ages\tCollect\t25\tYou survive tax season ‚Äì barely. Collect 25.\nDark Ages\tCollect\t100\tYour ale wins the pub fair prize. Collect 100.\nDark Ages\tCollect\t200\tYour ale wins the pub fair prize. Collect 200.\nDark Ages\tCollect\t100\tThe Bishop loves your stained glass art. Collect 100.\nAge of Kings\tPay\t200\tYou must pay a fine for satirizing the king‚Äôs nose. Pay 200.\nAge of Kings\tLose a turn\t\tOverly fancy wardrobe causes you to trip. Lose one turn.\nAge of Kings\tCollect\t200\tThe Queen tips you for your lute solo. Collect 200.\nAge of Kings\tPay\t25\tYour wig explodes during fireworks rehearsal. Pay 25.\nAge of Kings\tCollect\t25\tNoble patron funds your new corset design. Collect 25.\nAge of Kings\tCollect\t50\tYou win at court chess tournament. Collect 50.\nAge of Kings\tPay\t150\tYour wig explodes during fireworks rehearsal. Pay 150.\nAge of Kings\tRoll again\t\tKing invites you to royal bowling night. Roll again.\nAge of Kings\tCollect\t100\tNoble patron funds your new corset design. Collect 100.\nAge of Kings\tCollect\t200\tYour royal painting is accepted ‚Äì upside down. Collect 200.\nAge of Kings\tCollect\t50\tYour royal painting is accepted ‚Äì upside down. Collect 50.\nAge of Kings\tCollect\t25\tYou win at court chess tournament. Collect 25.\nAge of Kings\tPay\t50\tYou must pay a fine for satirizing the king‚Äôs nose. Pay 50.\nAge of Kings\tPay\t150\tRoyal postage fees increase mid-letter. Pay 150.\nAge of Kings\tCollect\t100\tYour royal painting is accepted ‚Äì upside down. Collect 100.\nAge of Kings\tCollect\t50\tThe Queen tips you for your lute solo. Collect 50.\nAge of Kings\tPay\t100\tYou must pay a fine for satirizing the king‚Äôs nose. Pay 100.\nAge of Kings\tPay\t50\tHorse tax collectors take your last carrot. Pay 50.\nAge of Kings\tCollect\t150\tYou sell a fake relic to a bishop. Collect 150.\nAge of Kings\tCollect\t200\tNoble patron funds your new corset design. Collect 200.\nAge of Kings\tRoll again\t\tYou win a court lottery ‚Äì go again. Roll again.\nAge of Kings\tLose a turn\t\tLocked in the tower for witty sarcasm. Lose one turn.\nAge of Kings\tPay\t100\tYou spill wine on the Magna Carta. Pay 100.\nAge of Kings\tCollect\t100\tYou win at court chess tournament. Collect 100.\nAge of Kings\tCollect\t50\tNoble patron funds your new corset design. Collect 50.\nAge of Kings\tPay\t150\tYou must pay a fine for satirizing the king‚Äôs nose. Pay 150.\nAge of Kings\tCollect\t25\tYour royal painting is accepted ‚Äì upside down. Collect 25.\nAge of Kings\tPay\t200\tHorse tax collectors take your last carrot. Pay 200.\nAge of Kings\tPay\t200\tYou spill wine on the Magna Carta. Pay 200.\nAge of Kings\tPay\t100\tYour wig explodes during fireworks rehearsal. Pay 100.\nAge of Kings\tPay\t150\tHorse tax collectors take your last carrot. Pay 150.\nAge of Kings\tCollect\t100\tYou sell a fake relic to a bishop. Collect 100.\nAge of Kings\tPay\t50\tYour wig explodes during fireworks rehearsal. Pay 50.\nAge of Kings\tCollect\t150\tNoble patron funds your new corset design. Collect 150.\nAge of Kings\tCollect\t150\tThe Queen tips you for your lute solo. Collect 150.\nAge of Kings\tCollect\t25\tYou sell a fake relic to a bishop. Collect 25.\nAge of Kings\tPay\t25\tRoyal postage fees increase mid-letter. Pay 25.\nAge of Kings\tCollect\t200\tYou win at court chess tournament. Collect 200.\nAge of Kings\tPay\t25\tHorse tax collectors take your last carrot. Pay 25.\nAge of Kings\tPay\t50\tYou spill wine on the Magna Carta. Pay 50.\nAge of Kings\tCollect\t25\tThe Queen tips you for your lute solo. Collect 25.\nAge of Kings\tPay\t25\tYou must pay a fine for satirizing the king‚Äôs nose. Pay 25.\nAge of Kings\tPay\t100\tHorse tax collectors take your last carrot. Pay 100.\nAge of Kings\tPay\t200\tRoyal postage fees increase mid-letter. Pay 200.\nAge of Kings\tCollect\t150\tYour royal painting is accepted ‚Äì upside down. Collect 150.\nAge of Kings\tPay\t150\tYou spill wine on the Magna Carta. Pay 150.\nAge of Kings\tPay\t50\tRoyal postage fees increase mid-letter. Pay 50.\nAge of Kings\tCollect\t150\tYou win at court chess tournament. Collect 150.\nAge of Kings\tCollect\t50\tYou sell a fake relic to a bishop. Collect 50.\nAge of Kings\tCollect\t200\tYou sell a fake relic to a bishop. Collect 200.\nIndustrial Age\tCollect\t50\tYour steam-powered blender is a hit. Collect 50.\nIndustrial Age\tPay\t200\tBoiler explosion insurance not included. Pay 200.\nIndustrial Age\tPay\t200\tYou fund Edison‚Äôs latest patent mess. Pay 200.\nIndustrial Age\tCollect\t50\tYou win best-dressed worker at the factory. Collect 50.\nIndustrial Age\tCollect\t100\tYour mustache oil gets royal endorsement. Collect 100.\nIndustrial Age\tRoll again\t\tYou channel Nikola Tesla‚Äôs dice-luck. Roll again.\nIndustrial Age\tPay\t100\tYour monocle breaks during opera. Pay 100.\nIndustrial Age\tPay\t50\tYou fund Edison‚Äôs latest patent mess. Pay 50.\nIndustrial Age\tPay\t200\tYou get fined for tophat overuse. Pay 200.\nIndustrial Age\tCollect\t100\tYour steam-powered blender is a hit. Collect 100.\nIndustrial Age\tPay\t150\tTelegraph fees ruin your savings. Pay 150.\nIndustrial Age\tCollect\t150\tYou win best-dressed worker at the factory. Collect 150.\nIndustrial Age\tRoll again\t\tSteam train arrives early ‚Äì go again. Roll again.\nIndustrial Age\tPay\t25\tBoiler explosion insurance not included. Pay 25.\nIndustrial Age\tPay\t100\tYou fund Edison‚Äôs latest patent mess. Pay 100.\nIndustrial Age\tCollect\t50\tYour mustache oil gets royal endorsement. Collect 50.\nIndustrial Age\tCollect\t200\tYour steam-powered blender is a hit. Collect 200.\nIndustrial Age\tPay\t100\tBoiler explosion insurance not included. Pay 100.\nIndustrial Age\tCollect\t150\tYou win a Nobel Prize in Sock Efficiency. Collect 150.\nIndustrial Age\tLose a turn\t\tLocked in the observatory overnight. Lose one turn.\nIndustrial Age\tPay\t150\tYour monocle breaks during opera. Pay 150.\nIndustrial Age\tCollect\t25\tYou win a Nobel Prize in Sock Efficiency. Collect 25.\nIndustrial Age\tCollect\t25\tYou win best-dressed worker at the factory. Collect 25.\nIndustrial Age\tCollect\t25\tYour steam-powered blender is a hit. Collect 25.\nIndustrial Age\tCollect\t200\tYou win best-dressed worker at the factory. Collect 200.\nIndustrial Age\tCollect\t50\tYou win a Nobel Prize in Sock Efficiency. Collect 50.\nIndustrial Age\tCollect\t150\tYour steam-powered blender is a hit. Collect 150.\nIndustrial Age\tLose a turn\t\tDelayed by an angry horseless carriage. Lose one turn.\nIndustrial Age\tCollect\t200\tYour mustache oil gets royal endorsement. Collect 200.\nIndustrial Age\tCollect\t100\tStock in 'Butter Balloon Co.' triples. Collect 100.\nIndustrial Age\tPay\t200\tTelegraph fees ruin your savings. Pay 200.\nIndustrial Age\tPay\t25\tYour monocle breaks during opera. Pay 25.\nIndustrial Age\tPay\t50\tBoiler explosion insurance not included. Pay 50.\nIndustrial Age\tCollect\t100\tYou win a Nobel Prize in Sock Efficiency. Collect 100.\nIndustrial Age\tPay\t200\tYour monocle breaks during opera. Pay 200.\nIndustrial Age\tPay\t150\tYou get fined for tophat overuse. Pay 150.\nIndustrial Age\tPay\t50\tYour monocle breaks during opera. Pay 50.\nIndustrial Age\tPay\t150\tBoiler explosion insurance not included. Pay 150.\nIndustrial Age\tCollect\t25\tStock in 'Butter Balloon Co.' triples. Collect 25.\nIndustrial Age\tPay\t25\tYou get fined for tophat overuse. Pay 25.\nIndustrial Age\tPay\t25\tYou fund Edison‚Äôs latest patent mess. Pay 25.\nIndustrial Age\tCollect\t25\tYour mustache oil gets royal endorsement. Collect 25.\nIndustrial Age\tPay\t25\tTelegraph fees ruin your savings. Pay 25.\nIndustrial Age\tCollect\t200\tStock in 'Butter Balloon Co.' triples. Collect 200.\nIndustrial Age\tCollect\t150\tYour mustache oil gets royal endorsement. Collect 150.\nIndustrial Age\tCollect\t200\tYou win a Nobel Prize in Sock Efficiency. Collect 200.\nIndustrial Age\tPay\t50\tYou get fined for tophat overuse. Pay 50.\nIndustrial Age\tPay\t150\tYou fund Edison‚Äôs latest patent mess. Pay 150.\nIndustrial Age\tPay\t50\tTelegraph fees ruin your savings. Pay 50.\nIndustrial Age\tCollect\t150\tStock in 'Butter Balloon Co.' triples. Collect 150.`;

        // Raw Treasure Card Data (to be parsed)
        const treasureCardDataRaw_Player = `Ancient Times\tLeftover Olive Pit from Plato's Symposium\t0
Ancient Times\tAuthentic Sand from the Sphinx's Armpit\t0
Ancient Times\tBroken Chisel Used Once on a Pyramid\t0
Ancient Times\tThe Original Recipe for Roman Kale Chips\t0
Ancient Times\tRejected Scroll of Horoscopes\t0
Ancient Times\tThe Brazen Bull\t25
Ancient Times\tAztec Obsidian Sacrificial Knife\t25
Ancient Times\tRoman Scorpion Whip\t25
Ancient Times\tPersian ‚ÄúEar Nailer‚Äù\t25
Ancient Times\tEtruscan Death Mask of Disgrace\t25
Ancient Times\tCeltic Skull Trophy Hooks\t250
Ancient Times\tAntikythera Mechanism\t250
Ancient Times\tRoman Concrete\t250
Ancient Times\tGreek Fire\t250
Ancient Times\tHebrew Mezuzah Scrolls\t250
Ancient Times\tBactrian Astrological Coins\t250
Ancient Times\tMayan Astronomical Observatories\t250
Ancient Times\tThe Mask of Tutankhamun\t500
Ancient Times\tThe Cyrus Cylinder\t500
Ancient Times\tThe Rosetta Stone\t500
Ancient Times\tNero‚Äôs Emerald Eyeglass\t500
Ancient Times\tLost Lyre of Doom\t500
Ancient Times\tThe Library of Alexandria Scrolls\t500
Ancient Times\tCleopatra‚Äôs Perfume Vessels\t350
Ancient Times\tEmperor Qin‚Äôs Jade Burial Suit\t350
Ancient Times\tFamous Gem of Steam\t350
Ancient Times\tSanskrit Surgical Tool\t100
Ancient Times\tBabylonian Star Charts\t100
Ancient Times\tSumerian Beer Brewing Tools\t100
Ancient Times\tHindu Decimal Place System\t100
Ancient Times\tThe Phaistos Disk\t100
Ancient Times\tSpear of Longinus\t100
Ancient Times\tRoman Imperial Diadems\t100
Ancient Times\tByzantine Empress‚Äôs Pearl Veil\t100
Ancient Times\tThe Cauldron of Dagda\t100
Ancient Times\tThe Rod of Asclepius\t200
Ancient Times\tDraupnir ‚Äì Odin‚Äôs Ring\t200
Ancient Times\tThe Book of Thoth\t200
Ancient Times\tThe Jade Emperor‚Äôs Table\t200
Ancient Times\tThe Crystal Skulls\t200
Ancient Times\tHan Dynasty Terracotta Cavalry\t300
Ancient Times\tThe Colossus of Rhodes\t300
Ancient Times\tThe Stone of Destiny (Scotland/Ireland)\t300
Ancient Times\tThe Seal of Solomon\t300
Ancient Times\tThe Olmec Colossal Heads\t300
Ancient Times\tHermes‚Äô Caduceus\t400
Ancient Times\tMjolnir ‚Äì Thor‚Äôs Hammer\t400
Ancient Times\tThe Tablet of Destinies\t400
Ancient Times\tThe Emerald Tablet\t500
Ancient Times\tAlexander‚Äôs Golden Sarcophagus\t500
Dark Ages\tYe Olde Toenail Clippings\t0
Dark Ages\tRusty Goblet of Mild Ale\t0
Dark Ages\tUnwashed Knight‚Äôs Sock\t0
Dark Ages\tScroll of Unreadable Latin Memes\t0
Dark Ages\tPlague-Era ‚ÄúFart Mask‚Äù\t0
Dark Ages\tBloodletting Horn\t25
Dark Ages\tToad Stone Amulet\t25
Dark Ages\tDevil Repellent Soup Spoon\t25
Dark Ages\tSinner‚Äôs Iron Crown\t25
Dark Ages\tSaint‚Äôs Bone Soup Stirrer\t25
Dark Ages\tLeper Rattle\t25
Dark Ages\tDragon‚Äôs Breath Candle\t25
Dark Ages\tSnake Charm Vellum\t25
Dark Ages\tThe Blinding Iron\t25
Dark Ages\tThe Piss Table\t25
Dark Ages\tThe Scapegoat Saddle\t50
Dark Ages\tA Privy Seal\t50
Dark Ages\tThe Royal Chicken\t50
Dark Ages\tThe Dukes toe nails\t50
Dark Ages\tViking Longship plans\t50
Dark Ages\tSoap\t50
Dark Ages\tCrossbow\t50
Dark Ages\tReading Stones\t50
Dark Ages\tMath\t50
Dark Ages\tDistillation Techniques\t50
Dark Ages\tThe Water Mill\t100
Dark Ages\tNimue‚Äôs Tear Vial\t100
Dark Ages\tThe Sword of Avalon\t100
Dark Ages\tThe Sword in the Stone (Caliburn)\t100
Dark Ages\tMorgan le Fay‚Äôs Mirror of the Moors\t100
Dark Ages\tCloak of Avalon Mist\t100
Dark Ages\tLancelot‚Äôs Shattered Shield\t100
Dark Ages\tGuinevere‚Äôs Crown of Roses\t100
Dark Ages\tMerlin‚Äôs Dragon Bone Staff\t100
Dark Ages\tThe Siege Perilous\t100
Dark Ages\tOrnate Viking Drinking Horn with Silver Rim\t200
Dark Ages\tByzantine Emperor‚Äôs Parade Armor\t200
Dark Ages\tMerovingian Crystal Amulet\t200
Dark Ages\tCharlemagne‚Äôs Horn Chalice\t200
Dark Ages\tPapal Ring of Power\t200
Dark Ages\tViking Arm Ring of Oaths\t300
Dark Ages\tThe Book of Kells (Illuminated Gospel)\t300
Dark Ages\tRunestone Throne Slab\t300
Dark Ages\tGilded Processional Cross with Emerald Core\t300
Dark Ages\tFamous Crown of Doom\t300
Dark Ages\tThe Sapphire of Pope Leo III\t400
Dark Ages\tThe True Cross\t400
Dark Ages\tThe Aachen Cathedral Treasury\t400
Dark Ages\tThe Golden Madonna of Essen\t500
Dark Ages\tThe Crown of Saint Stephen\t500
Age of Kings\tQueen‚Äôs Slightly Used Handkerchief\t0
Age of Kings\tChipped Chamber Pot of Henry VIII\t0
Age of Kings\tJester‚Äôs Expired Laugh License\t0
Age of Kings\tRoyal Wax Seal for a Spam Letter\t0
Age of Kings\tUnofficial Crown of the Court Cat\t0
Age of Kings\tLouse Comb with Built-In Mirror\t25
Age of Kings\tPuritan Sin Chart Spinner\t25
Age of Kings\tSun-Dial Belt Buckle\t25
Age of Kings\tRoyal Nose Shaper of Louis XIV\t25
Age of Kings\tBlunderbuss\t25
Age of Kings\tCursed Crown\t25
Age of Kings\tBeheading Viewer Spectacles\t25
Age of Kings\tOpera Nose Amplifier\t25
Age of Kings\tSelf-Milking Cow Harness\t25
Age of Kings\tCatherine Wheel (of entertainment)\t25
Age of Kings\tPowdered Wig Cooler Fan\t50
Age of Kings\tPhilosopher‚Äôs Chamber Pot\t50
Age of Kings\tNapoleon-Shaped Cologne Dispenser\t50
Age of Kings\tAristocratic Bubble Pipe\t50
Age of Kings\tCravat Straightener\t50
Age of Kings\tElectrified Corset\t50
Age of Kings\tCombustion-Powered Hair Curler\t50
Age of Kings\tSelf-Writing Diary Pen (secretary not included)\t50
Age of Kings\tMonkey Butlers for Hire (Yes, Really)\t50
Age of Kings\tVampire Detection Kit\t50
Age of Kings\tThermal-Leg Parasol\t100
Age of Kings\tMechanical Leech\t100
Age of Kings\tDickens-Quoting Typewriter\t100
Age of Kings\tQueen Victoria Mourning Brooch (with hair)\t100
Age of Kings\tLord Byron‚Äôs Boxing Gloves\t100
Age of Kings\tOscar Wilde‚Äôs Green Carnation Lapel Pin\t100
Age of Kings\tEmily Bront√´‚Äôs Walking Stick\t100
Age of Kings\tLewis Carroll‚Äôs Sketchpad\t100
Age of Kings\tThe Duke of Wellington‚Äôs Hair-Lined Snuff Box\t100
Age of Kings\tRobert Louis Stevenson‚Äôs Travel Compass\t100
Age of Kings\tFlorence Nightingale‚Äôs Crimean War Lantern\t200
Age of Kings\tDavid Livingstone‚Äôs Map Sketches\t200
Age of Kings\tMary Shelley‚Äôs Personal Letter Collection\t200
Age of Kings\tMichael Faraday‚Äôs Experimental Apparatus\t200
Age of Kings\tRichard Owen‚Äôs Dinosaur Reconstruction Models\t200
Age of Kings\tJames Watt‚Äôs Steam Engine Miniature Model\t300
Age of Kings\tGeorge Washington‚Äôs Diamond-Handled Sword\t300
Age of Kings\tBeethoven‚Äôs Grand Piano\t300
Age of Kings\tAlexander Hamilton‚Äôs Duel Pistols\t300
Age of Kings\tBuffalo Bill Cody‚Äôs Embroidered Wild West Jacket\t300
Age of Kings\tSusan B. Anthony‚Äôs Satin Sash\t400
Age of Kings\tBenjamin Franklin‚Äôs Bifocals\t400
Age of Kings\tHarriet Tubman‚Äôs Personal Bible and Shawl\t400
Age of Kings\tJane Austen‚Äôs Writing Desk\t500
Age of Kings\tIsaac Newton‚Äôs Stolen Alchemical Manuscripts\t500
Industrial Age\tOppenheimer's Conscience\t0
Industrial Age\tFlat Bottle of Cola\t0
Industrial Age\tUsed Lint from Tesla‚Äôs Pocket\t0
Industrial Age\tHitlers mustache\t0
Industrial Age\tArchduke Franz Ferdinand ‚ÄúBullet-Proof‚Äù Waistcoat\t0
Industrial Age\tMadam Rowley‚Äôs Toilet Mask\t25
Industrial Age\tDoughnut Dunker\t25
Industrial Age\tRasputin‚Äôs Beard Comb\t25
Industrial Age\tZeppelin Air Freshener\t25
Industrial Age\tLeague of Nations Peace Alarm Clock\t25
Industrial Age\tUsed Sock Garter (just one)\t25
Industrial Age\tJazz Age Elbow Shaker\t25
Industrial Age\tBlack Sox Cheater Bat\t25
Industrial Age\tHoover‚Äôs ‚ÄòGood Times‚Äô Broom\t25
Industrial Age\tMarie Curie‚Äôs Radioactive Notebook\t25
Industrial Age\tAl Capone‚Äôs Hidden Booze Cane\t50
Industrial Age\tGandhi‚Äôs Home-Spun Crotch Watch\t50
Industrial Age\tChurchill‚Äôs Cigar Ashtray Hat\t50
Industrial Age\tDali‚Äôs Lobster Phone\t50
Industrial Age\tFreud‚Äôs Dream Analyzer Dice\t50
Industrial Age\tWar Bonds Piggy Bank in a Tank\t50
Industrial Age\tVersailles Peace Treaty Crackers\t50
Industrial Age\tHemingway‚Äôs Big Game Typing Gloves\t50
Industrial Age\t‚ÄúRadium Health‚Äù Devices\t50
Industrial Age\tSinclairs Canned Meats\t50
Industrial Age\tRoyal Steam Engine of Truth\t100
Industrial Age\tAntique Telegraph of Empire\t100
Industrial Age\tAntique Boot of Myths\t100
Industrial Age\tCharlie Parker's Saxophone\t100
Industrial Age\tHoudini Escape Tools\t100
Industrial Age\tEinstein‚Äôs Thought Bubble Generator\t100
Industrial Age\tTheodore Roosevelt‚Äôs Bear Puncher Cane\t100
Industrial Age\tUmbrella-equipped Cigarette Holder\t100
Industrial Age\tPicasso's Abstract Mirror\t100
Industrial Age\tHeated Butterknife\t100
Industrial Age\tRevolver Camera\t200
Industrial Age\tBell's Telegraph\t200
Industrial Age\tHedy Lamarr's Patents\t200
Industrial Age\tAntique Ticket to the World's Fair\t200
Industrial Age\tFred Astaire's Shoes\t200
Industrial Age\tRelated to the Windsors\t300
Industrial Age\tThe Last Steam Engine\t300
Industrial Age\tStolen Tesla Journals\t300
Industrial Age\tBathtub Gin Still\t300
Industrial Age\tMafia ties\t300
Industrial Age\tChaplin's Derby\t400
Industrial Age\tCarnegie Steel Stock\t400
Industrial Age\tGolden Monocle of Yeats\t400
Industrial Age\tWar profiteering\t500
Industrial Age\tFuture steam punk gear\t500`;

        // Treasure and Twist content for each era
        const eraContent = {
            ancient: {
                treasures: [], // Will be populated by parseRawTreasureCardData
                majorTreasures: [], // No longer used - major treasures are selected from top value treasures
                twists: [] // Populated by parseRawTwistCardData
            },
            dark: {
                treasures: [], // Will be populated by parseRawTreasureCardData
                majorTreasures: [], // No longer used - major treasures are selected from top value treasures
                twists: [] // Populated by parseRawTwistCardData
            },
            kings: {
                treasures: [], // Will be populated by parseRawTreasureCardData
                majorTreasures: [], // No longer used - major treasures are selected from top value treasures
                twists: [] // Populated by parseRawTwistCardData
            },
            industrial: {
                treasures: [], // Will be populated by parseRawTreasureCardData
                majorTreasures: [], // No longer used - major treasures are selected from top value treasures
                twists: [] // Populated by parseRawTwistCardData
            }
        };

        // Helper function to shuffle an array (Fisher-Yates)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // Function to parse the raw string data for twist cards
        function parseRawTwistCardData(rawData) {
            const cardsByEra = { ancient: [], dark: [], kings: [], industrial: [] };
            const eraMapping = {
                "Ancient Times": "ancient",
                "Dark Ages": "dark",
                "Age of Kings": "kings",
                "Industrial Age": "industrial"
            };
            const lines = rawData.trim().split('\n');

            lines.forEach(line => {
                const parts = line.split('\t');
                if (parts.length < 4) { 
                    console.warn("Skipping malformed twist card line (less than 4 parts):", line);
                    return;
                }

                const rawEra = parts[0].trim();
                const type = parts[1].trim(); // "Collect", "Pay", "Lose a turn", "Roll again"
                const amountStr = parts[2].trim();
                const description = parts[3].trim();

                let amount = null;
                if ((type === "Collect" || type === "Pay") && amountStr !== "" && !isNaN(parseInt(amountStr))) {
                    amount = parseInt(amountStr);
                }

                const mappedEra = eraMapping[rawEra];
                if (mappedEra) {
                    cardsByEra[mappedEra].push({
                        type: type,
                        amount: amount,
                        description: description,
                        originalEra: rawEra // For display purposes
                    });
                } else {
                    console.warn("Unknown era in twist card data: ", rawEra);
                }
            });
            return cardsByEra;
        }

        // Function to initialize and populate twist card decks
        function populateTwistCardData() {
            const parsedCards = parseRawTwistCardData(twistCardDataRaw_Player);
            gameState.originalTwistCards.ancient = parsedCards.ancient || [];
            gameState.originalTwistCards.dark = parsedCards.dark || [];
            gameState.originalTwistCards.kings = parsedCards.kings || [];
            gameState.originalTwistCards.industrial = parsedCards.industrial || [];

            initializeTwistDeck('ancient');
            initializeTwistDeck('dark');
            initializeTwistDeck('kings');
            initializeTwistDeck('industrial');
        }

        // Function to parse the raw string data for treasure cards
        function parseRawTreasureCardData(rawData) {
            const eraMapping = {
                "Ancient Times": "ancient",
                "Dark Ages": "dark",
                "Age of Kings": "kings",
                "Industrial Age": "industrial"
            };
            const lines = rawData.trim().split('\n');

            // Clear existing treasures before adding new ones
            Object.keys(eraContent).forEach(era => {
                eraContent[era].treasures = [];
            });

            lines.forEach(line => {
                const parts = line.split('\t');
                if (parts.length < 3) { 
                    console.warn("Skipping malformed treasure card line:", line);
                    return;
                }

                const rawEra = parts[0].trim();
                const title = parts[1].trim();
                let value = parseInt(parts[2].trim());

                // No longer adding 100 to values over 25 - using exact values from data
                // if (value > 25) {
                //     value += 100;
                // }

                const mappedEra = eraMapping[rawEra];
                if (mappedEra && eraContent[mappedEra]) {
                    eraContent[mappedEra].treasures.push({
                        title: title,
                        value: value,
                        description: `${title}. Worth ${value} credits.`
                    });
                } else {
                    console.warn("Unknown era or uninitialized eraContent for treasure card: ", rawEra);
                }
            });
            Object.keys(eraContent).forEach(era => {
                if (eraContent[era] && eraContent[era].treasures) {
                    const uniqueTreasures = [];
                    const seenTitles = new Set();
                    eraContent[era].treasures.forEach(treasure => {
                        if (!seenTitles.has(treasure.title)) {
                            seenTitles.add(treasure.title);
                            uniqueTreasures.push(treasure);
                        }
                    });
                    eraContent[era].treasures = uniqueTreasures;
                }
            });
             Object.keys(eraContent).forEach(era => shuffleArray(eraContent[era].treasures));
        }

        // Function to populate all card data (Twist and Treasure)
        function populateAllCardData() {
            populateTwistCardData(); // Populates gameState.originalTwistCards and gameState.twistCardDecks
            parseRawTreasureCardData(treasureCardDataRaw_Player); // Populates eraContent[era].treasures
        }

        // Function to initialize or reset a specific era's twist deck
        function initializeTwistDeck(era) {
            if (gameState.originalTwistCards[era] && gameState.originalTwistCards[era].length > 0) {
                gameState.twistCardDecks[era] = [...gameState.originalTwistCards[era]]; // Create a copy
                shuffleArray(gameState.twistCardDecks[era]);
            } else {
                gameState.twistCardDecks[era] = []; // Ensure it's an empty array if no cards
            }
        }

        // Function to draw a twist card from the specified era's deck
        function drawTwistCard(era) {
            if (!gameState.twistCardDecks[era] || gameState.twistCardDecks[era].length === 0) {
                if (gameState.originalTwistCards[era] && gameState.originalTwistCards[era].length > 0) {
                    toast(`The ${era} Twist of Fate deck is empty and has been reshuffled!`);
                    initializeTwistDeck(era); // Reshuffle if deck is empty
                } else {
                    toast(`No Twist of Fate cards available for the ${era} era.`);
                    return null; // No cards to draw or reshuffle
                }
            }
            // This check is needed again in case originalTwistCards[era] was empty
            if (gameState.twistCardDecks[era].length > 0) { 
                const card = gameState.twistCardDecks[era].shift(); // Draw from the top and remove it from the current deck cycle
                return card;
            }
            return null; // Should ideally not be reached if reshuffling works and cards exist
        }
        
        // Items that can be found or purchased
        const items = [
            { name: 'Karma Shield', effect: 'Protects against credit loss once', price: 300 },
            { name: 'Credit Doubler', effect: 'Doubles credit gains for 3 turns', price: 500 },
            { name: 'Time Anchor', effect: 'Prevents involuntary time jumps once', price: 400 },
            { name: 'Karma Booster', effect: 'Increases credit gain by 50% for 3 turns', price: 600 },
            { name: 'Lucky Dice', effect: 'Allows rerolling dice once', price: 200 },
            { name: 'Time Machine', effect: 'Allows choosing which era to jump to', price: 1000 }
        ];
        
        // DOM elements
        const startScreen = document.getElementById('start-screen');
        const gameBoard = document.getElementById('game-board');
        const playerInfo = document.getElementById('player-info');
        const rollButton = document.getElementById('roll-button');
        const diceDisplay = document.getElementById('dice');
        const inventoryButton = document.getElementById('inventory-button');
        const inventoryPanel = document.getElementById('inventory');
        const inventoryItems = document.getElementById('inventory-items');
        const closeInventoryButton = document.getElementById('close-inventory');
        const eventDisplay = document.getElementById('event-display');
        const eventTitle = document.getElementById('event-title');
        const eventDescription = document.getElementById('event-description');
        const eventButton = document.getElementById('event-button');
        const selectInventoryModal = document.getElementById('select-inventory-modal');
        const closeSelectInventoryModalButton = document.getElementById('close-select-inventory-modal-button');
        const toastElement = document.getElementById('toast');
        const rulesButton = document.getElementById('rules-button');
        const rulesModal = document.getElementById('rules-modal');
        const closeRulesButton = document.getElementById('close-rules');
        const turnTransitionModal = document.getElementById('turn-transition-modal');
        const turnTransitionPlayerName = document.getElementById('turn-transition-player-name');
        const turnTransitionMessage = document.getElementById('turn-transition-message');
        const turnTransitionOkButton = document.getElementById('turn-transition-ok-button');

        // Helper function to roll two dice
        function rollTwoDice() {
            const die1 = Math.floor(Math.random() * 6) + 1;
            const die2 = Math.floor(Math.random() * 6) + 1;
            return { die1, die2, total: die1 + die2, isDoubles: die1 === die2 };
        }
        
        // Function to animate dice roll
        function animateDiceRoll(diceResult) {
            const dice1 = document.getElementById('dice1');
            const dice2 = document.getElementById('dice2');
            const diceTotal = document.getElementById('dice-total');
            
            // Random rotations for animation
            const getRandomRotation = () => {
                return `rotateX(${Math.floor(Math.random() * 360)}deg) rotateY(${Math.floor(Math.random() * 360)}deg) rotateZ(${Math.floor(Math.random() * 360)}deg)`;
            };
            
            // Set initial random rotation
            dice1.style.transform = getRandomRotation();
            dice2.style.transform = getRandomRotation();
            diceTotal.textContent = '';
            
            // After a short delay, set the final rotation to show the correct face
            setTimeout(() => {
                // Map die value to the correct rotation
                const getFaceRotation = (value) => {
                    switch(value) {
                        case 1: return 'rotateX(0deg) rotateY(0deg)';
                        case 2: return 'rotateX(0deg) rotateY(180deg)';
                        case 3: return 'rotateX(-90deg) rotateY(0deg)';
                        case 4: return 'rotateX(90deg) rotateY(0deg)';
                        case 5: return 'rotateX(0deg) rotateY(-90deg)';
                        case 6: return 'rotateX(0deg) rotateY(90deg)';
                        default: return 'rotateX(0deg) rotateY(0deg)';
                    }
                };
                
                // Set final rotation
                dice1.style.transform = getFaceRotation(diceResult.die1);
                dice2.style.transform = getFaceRotation(diceResult.die2);
                
                // Show total after dice stop
                setTimeout(() => {
                    diceTotal.textContent = `= ${diceResult.total}`;
                    if (diceResult.isDoubles) {
                        diceTotal.textContent += ' (Doubles!)';
                    }
                }, 500);
            }, 1000);
            
            return diceResult;
        }
        
        // Initialize zoom and camera controls
        let zoomLevel = 2.5; // Start with slightly less zoom to see more of the board
        let panX = 0;
        let panY = 0;
        let isDragging = false;
        let startX, startY;
        let lastPanX = 0;
        let lastPanY = 0;
        let autoFollowEnabled = true; // Auto-follow is always enabled by default
        let followPlayer = true; // Only follow the active player
        let maxPanLimit = 300; // Increased pan limit to ensure we can reach all edges of the board
        let cameraUpdateInterval; // For continuous camera updates to keep player centered
        
        function initZoomControls() {
            const boardContainer = document.getElementById('board-container');
            const boardWrapper = document.getElementById('board-wrapper');
            const zoomInBtn = document.getElementById('zoom-in');
            const zoomOutBtn = document.getElementById('zoom-out');
            const zoomResetBtn = document.getElementById('zoom-reset');
            
            // Zoom in button
            zoomInBtn.addEventListener('click', () => {
                zoomLevel = Math.min(zoomLevel + 0.25, 3);
                updateBoardTransform();
                // Always center on current player when zooming in
                centerOnPlayer(gameState.currentPlayerIndex);
            });
            
            // Zoom out button
            zoomOutBtn.addEventListener('click', () => {
                zoomLevel = Math.max(zoomLevel - 0.25, 1);
                updateBoardTransform();
                if (zoomLevel === 1) {
                    resetPan();
                } else {
                    // Even when zooming out, keep centered on current player
                    centerOnPlayer(gameState.currentPlayerIndex);
                }
            });
            
            // Reset zoom button
            zoomResetBtn.addEventListener('click', () => {
                zoomLevel = 3; // Reset to the initial fully zoomed-in state
                resetPan();
                updateBoardTransform();
                // Center on current player after reset, instantly
                setTimeout(() => centerOnPlayer(gameState.currentPlayerIndex, true), 50);
            });
            
            // Mouse wheel zoom
            boardContainer.addEventListener('wheel', (e) => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? -0.1 : 0.1;
                const oldZoom = zoomLevel;
                zoomLevel = Math.max(1, Math.min(3, zoomLevel + delta));
                updateBoardTransform();
                
                if (zoomLevel === 1) {
                    resetPan();
                } else if (zoomLevel !== oldZoom) {
                    // Center on current player when zoom level changes
                    centerOnPlayer(gameState.currentPlayerIndex);
                }
            });
            
            // Touch and mouse drag for panning - kept for manual adjustments if needed
            boardContainer.addEventListener('mousedown', startDrag);
            boardContainer.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1) {
                    startDrag(e.touches[0]);
                }
            }, { passive: false });
            
            boardContainer.addEventListener('mousemove', drag);
            boardContainer.addEventListener('touchmove', (e) => {
                if (e.touches.length === 1) {
                    e.preventDefault();
                    drag(e.touches[0]);
                }
            }, { passive: false });
            
            boardContainer.addEventListener('mouseup', endDrag);
            boardContainer.addEventListener('mouseleave', endDrag);
            boardContainer.addEventListener('touchend', endDrag);
            boardContainer.addEventListener('touchcancel', endDrag);
            
            // Pinch to zoom for touch devices
            let initialDistance = 0;
            let initialZoom = 1;
            
            boardContainer.addEventListener('touchstart', (e) => {
                if (e.touches.length === 2) {
                    initialDistance = Math.hypot(
                        e.touches[0].clientX - e.touches[1].clientX,
                        e.touches[0].clientY - e.touches[1].clientY
                    );
                    initialZoom = zoomLevel;
                }
            }, { passive: false });
            
            boardContainer.addEventListener('touchmove', (e) => {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    const currentDistance = Math.hypot(
                        e.touches[0].clientX - e.touches[1].clientX,
                        e.touches[0].clientY - e.touches[1].clientY
                    );
                    const ratio = currentDistance / initialDistance;
                    const oldZoom = zoomLevel;
                    zoomLevel = Math.max(1, Math.min(3, initialZoom * ratio));
                    updateBoardTransform();
                    
                    // Center on player after pinch zoom
                    if (Math.abs(zoomLevel - oldZoom) > 0.1) {
                        centerOnPlayer(gameState.currentPlayerIndex);
                    }
                }
            }, { passive: false });
            
            // Hide the toggle follow button since we're making auto-follow mandatory
            const toggleFollowBtn = document.getElementById('toggle-follow');
            if (toggleFollowBtn) {
                toggleFollowBtn.style.display = 'none';
            }
            
            // Set up a continuous camera update interval to ensure the current player
            // stays centered throughout their turn, even during animations or effects
            if (cameraUpdateInterval) {
                clearInterval(cameraUpdateInterval);
            }
            cameraUpdateInterval = setInterval(() => {
                if (autoFollowEnabled && followPlayer && gameState.gameStarted && !isDragging) {
                    // Only apply gentle centering (not instant) to avoid jarring camera movements
                    centerOnPlayer(gameState.currentPlayerIndex, false);
                }
            }, 500); // Check every 500ms - frequent enough for smooth following but not too CPU intensive
        }
        
        function startDrag(e) {
            if (zoomLevel > 1) {
                isDragging = true;
                startX = e.clientX || e.pageX;
                startY = e.clientY || e.pageY;
                lastPanX = panX;
                lastPanY = panY;
                
                // Temporarily pause auto-follow during manual dragging
                const wasAutoFollowEnabled = autoFollowEnabled;
                autoFollowEnabled = false;
                
                // Re-enable auto-follow after a short period (2 seconds)
                clearTimeout(window.autoFollowTimer);
                window.autoFollowTimer = setTimeout(() => {
                    if (wasAutoFollowEnabled) {
                        autoFollowEnabled = true;
                        // Re-center on current player when auto-follow is re-enabled, instantly
                        centerOnPlayer(gameState.currentPlayerIndex, true);
                    }
                }, 2000);
            }
        }
        
        function drag(e) {
            if (!isDragging) return;
            const x = e.clientX || e.pageX;
            const y = e.clientY || e.pageY;
            const dx = (x - startX) / zoomLevel;
            const dy = (y - startY) / zoomLevel;
            
            panX = lastPanX + dx;
            panY = lastPanY + dy;
            
            // Increased pan limits to ensure we can reach all edges of the board
            const maxPan = maxPanLimit * (zoomLevel - 1) / zoomLevel;
            panX = Math.max(-maxPan, Math.min(maxPan, panX));
            panY = Math.max(-maxPan, Math.min(maxPan, panY));
            
            updateBoardTransform();
        }
        
        function endDrag() {
            isDragging = false;
            // After manual drag ends, re-center on current player after a short delay
            if (autoFollowEnabled) {
                setTimeout(() => centerOnPlayer(gameState.currentPlayerIndex), 500);
            }
        }
        
        function resetPan() {
            panX = 0;
            panY = 0;
        }
        
        function updateBoardTransform() {
            const boardWrapper = document.getElementById('board-wrapper');
            boardWrapper.style.transform = `scale(${zoomLevel}) translate(${panX}px, ${panY}px)`;
            
            // Use requestAnimationFrame for smoother updates
            requestAnimationFrame(() => {
                // Update any player tokens that might need repositioning after transform
                // This ensures tokens stay properly aligned with their cells
                const tokens = document.querySelectorAll('.player-token');
                tokens.forEach(token => {
                    // Instead of forcing a reflow with display:none, use a more efficient approach
                    // Apply a small transform adjustment and then reset it
                    // This triggers a repaint without causing a full reflow
                    const currentTransform = token.style.transform;
                    token.style.transform = currentTransform + ' translateZ(0)';
                    
                    // Reset to original transform on next frame
                    requestAnimationFrame(() => {
                        token.style.transform = currentTransform;
                    });
                });
            });
        }
        
        function centerOnPlayer(playerIndex, instant = false) {
            // Always center on player regardless of zoom level
            const player = gameState.players[playerIndex];
            const position = boardPath[player.position];
            if (!position) return;
            
            // Calculate the center position of the cell in the grid
            // Adjust for the padding in the game board
            const paddingPixels = 8; // Matches the padding in #game-board
            const gapPixels = 8; // Matches the gap in #game-board
            
            // Calculate the effective dimensions accounting for padding and gaps
            const boardWrapper = document.getElementById('board-wrapper');
            const boardWidth = boardWrapper.offsetWidth;
            const boardHeight = boardWrapper.offsetHeight;
            
            // Calculate cell dimensions including gaps
            const cellWidth = (boardWidth - (paddingPixels * 2) - (gapPixels * 15)) / 16;
            const cellHeight = (boardHeight - (paddingPixels * 2) - (gapPixels * 15)) / 16;
            
            // Calculate the absolute position of the cell center
            const centerX = paddingPixels + (position.x * (cellWidth + gapPixels)) + (cellWidth / 2);
            const centerY = paddingPixels + (position.y * (cellHeight + gapPixels)) + (cellHeight / 2);
            
            // Convert to pan values (centered = 0,0)
            const targetPanX = -(centerX - boardWidth/2) / zoomLevel;
            const targetPanY = -(centerY - boardHeight/2) / zoomLevel;
            
            // For smoother camera movement, use interpolation instead of direct assignment
            // This creates a more natural camera follow effect
            if (!instant && panX !== 0 && panY !== 0) {
                // Calculate distance to target
                const distX = targetPanX - panX;
                const distY = targetPanY - panY;
                const distance = Math.sqrt(distX * distX + distY * distY);
                
                // If we're very close to the target, just snap to it
                if (distance < 5 / zoomLevel) {
                    panX = targetPanX;
                    panY = targetPanY;
                } else {
                    // Otherwise, move a percentage of the way there for smoother motion
                    // The interpolation factor controls how quickly the camera catches up
                    // Using a higher factor for current player to ensure they stay centered
                    const interpolationFactor = playerIndex === gameState.currentPlayerIndex ? 0.92 : 0.85;
                    panX += distX * interpolationFactor;
                    panY += distY * interpolationFactor;
                }
            } else {
                // For instant centering or initial positioning, directly set values
                panX = targetPanX;
                panY = targetPanY;
            }
            
            // For edge positions, ensure we can see the full token by adjusting pan if needed
            // This is especially important for tokens at the very edges of the board
            if (position.x === 0 || position.x === 15 || position.y === 0 || position.y === 15) {
                // Add a small offset to ensure the token is fully visible
                const edgeOffset = 12 / zoomLevel; // Slightly increased offset for better visibility
                
                if (position.x === 0) panX += edgeOffset; // Left edge
                if (position.x === 15) panX -= edgeOffset; // Right edge
                if (position.y === 0) panY += edgeOffset; // Top edge
                if (position.y === 15) panY -= edgeOffset; // Bottom edge
            }
            
            // Apply transition (or not if instant)
            if (instant) {
                boardWrapper.style.transition = 'none';
                updateBoardTransform();
                // Force reflow to ensure the transition is applied
                void boardWrapper.offsetWidth;
                boardWrapper.style.transition = 'transform 0.3s ease';
            } else {
                // Apply smooth transition with improved easing for more natural camera movement
                // Use faster transition for current player to keep them centered more responsively
                const transitionTime = playerIndex === gameState.currentPlayerIndex ? '0.4s' : '0.5s';
                boardWrapper.style.transition = `transform ${transitionTime} cubic-bezier(0.2, 0.8, 0.2, 1)`;
                updateBoardTransform();
                
                // Reset transition after animation completes
                setTimeout(() => {
                    boardWrapper.style.transition = 'transform 0.3s ease';
                }, 500);
            }
        }
        
        // Initialize the game
        function initGame() {
            console.log('Initializing game');

            // Initialize zoom controls
            initZoomControls();
            
            // Auto-follow is now always enabled but only for the active player
            // We'll center on each player when their turn begins instead of using an interval
            // This way the camera only follows the active player's token

            // Set up event listeners for player selection buttons
            document.querySelectorAll('.player-count-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // Start screen music when a player count is selected
                    if (sounds.startScreen && typeof sounds.startScreen.play === 'function') {
                        if (!sounds.startScreen.playing()) { // Play only if not already playing
                            sounds.startScreen.play();
                        }
                    }
                    const playerCount = parseInt(this.getAttribute('data-players'));
                    setupPlayers(playerCount);
                });
            });
            
            // Set up rules button
            rulesButton.addEventListener('click', function() {
                rulesModal.style.display = 'block';
            });
            
            closeRulesButton.addEventListener('click', function() {
                rulesModal.style.display = 'none';
            });
        }
        
        // Create the game board with 159 specified squares
        function createBoard() {
            gameBoard.innerHTML = '';
            gameState.suddenDeathCount = 0; // Reset sudden death counter
            gameState.board = []; // Clear the board array
            let kingsSquareImageIndex = 0; // Initialize index for Kings era images
            let industrialSquareImageIndex = 0; // Initialize index for Industrial era images
            let ancientSquareImageIndex = 0; // Initialize index for Ancient era images
            let darkAgesSquareImageIndex = 0; // Initialize index for Dark Ages era images
            
            // Removed the stone texture empty squares (rows 11-15)
            
            // Remove bottom image since we're not using the stone texture rows anymore
            const bottomImage = document.getElementById('bottom-image');
            if (bottomImage) {
                bottomImage.style.display = 'none';
            }
            
            // Define the specific squares in order based on the provided sequence
            const squareTypes = [
                // INDUSTRIAL ERA (1-46) - Indices 0-45
                'Start', 'Title', 'Sudden Death', 'Treasure', 'Twist of Fate', 'Twist of Fate', 'Treasure', 'Twist of Fate', 'Gamble', 'Barter', // Index 2 changed to Sudden Death
                'Vengeance', 'Time Portal', 'Treasure', 'Treasure', 'Twist of Fate', 'Robbery', 'Treasure', 'Twist of Fate', 'Treasure', 'Treasure',
                'Roll Again', 'Twist of Fate', 'Gamble', 'Treasure', 'Gamble', 'Evil Eye', 'Twist of Fate', 'Twist of Fate', 'Treasure', 'Roll Again',
                'Treasure', 'Robbery', 'Twist of Fate', 'Robbery', 'Time Portal', 'Gamble', 'Hazard', 'Major Treasure', 'Hazard', 'Treasure',
                'Treasure', 'Gamble', 'Twist of Fate', 'Robbery', 'Treasure', 'Treasure',
                // KINGS ERA (47-89) - Indices 46-88
                'Title', 'Sudden Death', 'Treasure', 'Twist of Fate', 'Gamble', 'Robbery', 'Twist of Fate', 'Lucky Day', 'Treasure', 'Roll Again', // Index 47 changed to Sudden Death
                'Evil Eye', 'Twist of Fate', 'Treasure', 'Gamble', 'Time Portal', 'Robbery', 'Twist of Fate', 'Treasure', 'Vengeance', 'Treasure',
                'Twist of Fate', 'Gamble', 'Barter', 'Robbery', 'Twist of Fate', 'Treasure', 'Treasure', 'Hazard', 'Major Treasure', 'Hazard',
                'Time Portal', 'Roll Again', 'Treasure', 'Treasure', 'Twist of Fate', 'Robbery', 'Gamble', 'Twist of Fate', 'Vengeance', 'Robbery',
                'Twist of Fate', 'Twist of Fate', 'Treasure',
                // DARK AGES ERA (90-137) - Indices 89-136
                'Title', 'Twist of Fate', 'Sudden Death', 'Treasure', 'Charity', 'Evil Eye', 'Lucky Day', 'Time Portal', 'Treasure', 'Robbery', // Index 91 changed to Sudden Death, Index 92 changed to Charity
                'Twist of Fate', 'Treasure', 'Gamble', 'Twist of Fate', 'Barter', 'Treasure', 'Roll Again', 'Time Portal', 'Treasure', 'Twist of Fate',
                'Hazard', 'Major Treasure', 'Hazard', 'Twist of Fate', 'Robbery', 'Treasure', 'Twist of Fate', 'Vengeance', 'Twist of Fate', 'Evil Eye',
                'Treasure', 'Gamble', 'Twist of Fate', 'Roll Again', 'Time Portal', 'Robbery', 'Treasure', 'Barter', 'Twist of Fate', 'Treasure',
                'Robbery', 'Gamble', 'Sudden Death', 'Twist of Fate', 'Vengeance', 'Lucky Day', 'Twist of Fate', 'Treasure', // Original Sudden Death at index 132
                // ANCIENT TIMES ERA (138-169) - Indices 137-168
                'Title', 'Twist of Fate', 'Sudden Death', 'Treasure', 'Roll Again', 'Evil Eye', 'Lucky Day', 'Time Portal', 'Treasure', 'Robbery', // Index 139 changed to Sudden Death
                'Twist of Fate', 'Treasure', 'Gamble', 'Treasure', 'Twist of Fate', 'Hazard', 'Major Treasure', 'Hazard', 'Barter', 'Robbery',
                'Twist of Fate', 'Treasure', 'Gamble', 'Twist of Fate', 'Treasure', 'Robbery', 'Time Portal', 'Vengeance', 'Treasure', 'Roll Again',
                'Lucky Day', 'Charity',
                // NIRVANA (170) - Index 169
                'Nirvana'
            ];
            
            const titleNames = {
                1: 'Industrial Age',    // Square 2 (Index 1)
                46: 'Age of Kings',   // Square 47 (Index 46)
                89: 'Dark Ages',      // Square 90 (Index 89)
                137: 'Ancient Times' // Square 138 (Index 137)
            };
            
            const hazardNames = {
                36: 'Factory Fire',     // Square 37 (Index 36)
                38: 'Spanish Flu',      // Square 39 (Index 38)
                73: 'Peasant Revolt',   // Square 74 (Index 73)
                75: 'Great Famine',     // Square 76 (Index 75)
                109: 'Inquisition',      // Square 110 (Index 109)
                111: 'Black Plague',     // Square 112 (Index 111)
                152: 'Temple Collapse',  // Square 153 (Index 152)
                154: 'Cholera Outbreak'  // Square 155 (Index 154)
            };
            
            for (let i = 0; i < boardPath.length; i++) {
                const position = boardPath[i];
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.dataset.x = position.x;
                cell.dataset.y = position.y;
                cell.style.gridColumn = position.x + 1;
                cell.style.gridRow = position.y + 1;
                
                let era = 'industrial';
                // Determine era based on the linear index 'i'
                // Indices: Industrial 0-45 (Sq 1-46), Kings 46-88 (Sq 47-89), Dark 89-136 (Sq 90-137), Ancient 137-168 (Sq 138-169), Nirvana 169 (Sq 170)
                if (i === 169) era = 'nirvana';      // Index 169 (Square 170)
                else if (i >= 137) era = 'ancient'; // Indices 137-168 (Squares 138-169)
                else if (i >= 89) era = 'dark';    // Indices 89-136  (Squares 90-137)
                else if (i >= 46) era = 'kings';   // Indices 46-88   (Squares 47-89)
                else era = 'industrial';        // Indices 0-45    (Squares 1-46)

                const cellTypeName = squareTypes[i];
                const cellType = cellTypes.find(type => type.name === cellTypeName);

                if (!cellType) {
                    console.error(`Cell type not found: ${cellTypeName} for index ${i}`);
                    continue;
                }

                imageSourceToUse = null;

                // Determine image source based on correct index 'i' and cell type
                // Title squares are at indices 1 (Industrial), 46 (Kings), 85 (Dark Ages), 130 (Ancient)
                // Nirvana is at index 158. Charity is at index 157.
                // For Start Square (index 0), use the provided asset
                if (cellType.name === 'Start' && i === 0) {
                    imageSourceToUse = "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F3198C5FA-7AA8-4B9F-BBA7-1CBB17286D21.png?alt=media&token=05ccfa5f-7c74-4de0-96c2-1f04ec3bea9e";
                } else {
                    if (cellType.name === 'Title' && i === 1 && industrialTitleImageUrl) { // Sq 2: Industrial Age Title
                    imageSourceToUse = industrialTitleImageUrl;
                } else if (cellType.name === 'Title' && i === 46 && kingsTitleImageUrl) { // Sq 47: Age of Kings Title
                    imageSourceToUse = kingsTitleImageUrl;
                } else if (cellType.name === 'Title' && i === 89 && darkAgesTitleImageUrl) { // Sq 90: Dark Ages Title
                    imageSourceToUse = darkAgesTitleImageUrl;
                } else if (cellType.name === 'Title' && i === 137 && ancientTitleImageUrl) { // Sq 138: Ancient Times Title
                    imageSourceToUse = ancientTitleImageUrl;
                } else if (cellType.name === 'Nirvana' && i === 169 && nirvanaSquareImageUrl) { // Sq 170: Nirvana
                    imageSourceToUse = nirvanaSquareImageUrl;
                } else if (cellType.name === 'Roll Again' && rollAgainSquareImageUrl_player) { // All Roll Again squares (player asset)
                    imageSourceToUse = rollAgainSquareImageUrl_player;
                } else if (cellType.name === 'Lucky Day' && luckyDaySquareImageUrl) { // All Lucky Day squares
                    imageSourceToUse = luckyDaySquareImageUrl;
                } else if (cellType.name === 'Evil Eye' && evilEyeSquareImageUrl) { // All Evil Eye squares
                    imageSourceToUse = evilEyeSquareImageUrl;
                } else if (cellType.name === 'Charity' && i === 168 && charitySquareImageUrl) { // Sq 169: Charity (Ancient Era)
                    imageSourceToUse = charitySquareImageUrl;
                } else if (cellType.name === 'Charity' && i === 93 && charitySquareImageUrl) { // Sq 94: Charity (Dark Ages Era)
                    imageSourceToUse = charitySquareImageUrl;
                }
                // Player-provided Kings Era asset overrides
                else if (era === 'kings') {
                    if (cellType.name === 'Treasure' && kingsUniversalTreasureImageUrl_player) { imageSourceToUse = kingsUniversalTreasureImageUrl_player; }
                    else if (cellType.name === 'Twist of Fate' && kingsTwistImageUrl_player) { imageSourceToUse = kingsTwistImageUrl_player; }
                    else if (cellType.name === 'Gamble' && kingsGambleImageUrl_player) { imageSourceToUse = kingsGambleImageUrl_player; }
                    else if (cellType.name === 'Robbery' && kingsRobberyImageUrl_player) { imageSourceToUse = kingsRobberyImageUrl_player; }
                    else if (cellType.name === 'Barter' && kingsBarterImageUrl_player) { imageSourceToUse = kingsBarterImageUrl_player; }
                    else if (cellType.name === 'Time Portal' && kingsTimePortalImageUrl_player) { imageSourceToUse = kingsTimePortalImageUrl_player; }
                    else if (cellType.name === 'Vengeance' && kingsVengeanceImageUrl_player) { imageSourceToUse = kingsVengeanceImageUrl_player; }
                    else if (cellType.name === 'Hazard' && kingsHazardImageUrl_player) { imageSourceToUse = kingsHazardImageUrl_player; }
                    else if (cellType.name === 'Major Treasure' && kingsMajorTreasureImageUrl_player) { imageSourceToUse = kingsMajorTreasureImageUrl_player; }
                    else if (cellType.name === 'Sudden Death' && kingsSuddenDeathImageUrl_player) { imageSourceToUse = kingsSuddenDeathImageUrl_player; }
                    // Fallback for Kings era squares that don't match a specific type above or if the specific image var is null
                    else if (kingsSquareImageUrls.length > 0) {
                        imageSourceToUse = kingsSquareImageUrls[kingsSquareImageIndex % kingsSquareImageUrls.length];
                        kingsSquareImageIndex++;
                    }
                }
                // End of Player-provided Kings Era asset overrides
                // Player-provided Industrial Era asset overrides
                else if (era === 'industrial') {
                    if (cellType.name === 'Major Treasure' && industrialMajorTreasureImageUrl_player) { imageSourceToUse = industrialMajorTreasureImageUrl_player; }
                    else if (cellType.name === 'Time Portal' && industrialTimePortalImageUrl_player) { imageSourceToUse = industrialTimePortalImageUrl_player; }
                    else if (cellType.name === 'Gamble' && industrialGambleImageUrl_player) { imageSourceToUse = industrialGambleImageUrl_player; }
                    else if (cellType.name === 'Robbery' && industrialRobberyImageUrl_player) { imageSourceToUse = industrialRobberyImageUrl_player; }
                    else if (cellType.name === 'Barter' && industrialBarterImageUrl_player) { imageSourceToUse = industrialBarterImageUrl_player; }
                    else if (cellType.name === 'Sudden Death' && industrialSuddenDeathImageUrl_player) { imageSourceToUse = industrialSuddenDeathImageUrl_player; }
                    else if (cellType.name === 'Twist of Fate' && industrialTwistImageUrl_player) { imageSourceToUse = industrialTwistImageUrl_player; }
                    else if (cellType.name === 'Treasure' && industrialTreasureImageUrl_player) { imageSourceToUse = industrialTreasureImageUrl_player; }
                    else if (cellType.name === 'Vengeance' && industrialVengeanceImageUrl_player) { imageSourceToUse = industrialVengeanceImageUrl_player; }
                    else if (cellType.name === 'Hazard' && industrialHazardImageUrl_player) { imageSourceToUse = industrialHazardImageUrl_player; }
                }
                // End of Player-provided Industrial Era asset overrides
                // Player-provided Dark Ages Era asset overrides
                else if (era === 'dark') {
                    if (cellType.name === 'Vengeance' && darkAgesVengeanceImageUrl_player) { imageSourceToUse = darkAgesVengeanceImageUrl_player; }
                    else if (cellType.name === 'Robbery' && darkAgesRobberyImageUrl_player) { imageSourceToUse = darkAgesRobberyImageUrl_player; }
                    else if (cellType.name === 'Hazard' && darkAgesHazardImageUrl_player) { imageSourceToUse = darkAgesHazardImageUrl_player; }
                    else if (cellType.name === 'Time Portal' && darkAgesTimePortalImageUrl_player) { imageSourceToUse = darkAgesTimePortalImageUrl_player; }
                    else if (cellType.name === 'Gamble' && darkAgesGambleImageUrl_player) { imageSourceToUse = darkAgesGambleImageUrl_player; }
                    else if (cellType.name === 'Major Treasure' && darkAgesMajorTreasureImageUrl_player) { imageSourceToUse = darkAgesMajorTreasureImageUrl_player; }
                    else if (cellType.name === 'Barter' && darkAgesBarterImageUrl_player) { imageSourceToUse = darkAgesBarterImageUrl_player; }
                    else if (cellType.name === 'Sudden Death' && darkAgesSuddenDeathImageUrl_player) { imageSourceToUse = darkAgesSuddenDeathImageUrl_player; }
                    else if (cellType.name === 'Treasure' && darkAgesTreasureImageUrl_player) { imageSourceToUse = darkAgesTreasureImageUrl_player; }
                    else if (cellType.name === 'Twist of Fate' && darkAgesTwistImageUrl_player) { imageSourceToUse = darkAgesTwistImageUrl_player; }
                }
                // End of Player-provided Dark Ages Era asset overrides
                // Player-provided Ancient Era asset overrides
                else if (era === 'ancient') {
                    if (cellType.name === 'Vengeance' && ancientVengeanceImageUrl_player) { imageSourceToUse = ancientVengeanceImageUrl_player; }
                    else if (cellType.name === 'Barter' && ancientBarterImageUrl_player) { imageSourceToUse = ancientBarterImageUrl_player; }
                    else if (cellType.name === 'Gamble' && ancientGambleImageUrl_player) { imageSourceToUse = ancientGambleImageUrl_player; }
                    else if (cellType.name === 'Robbery' && ancientRobberyImageUrl_player) { imageSourceToUse = ancientRobberyImageUrl_player; }
                    else if (cellType.name === 'Time Portal' && ancientTimePortalImageUrl_player) { imageSourceToUse = ancientTimePortalImageUrl_player; }
                    else if (cellType.name === 'Hazard' && ancientHazardImageUrl_player) { imageSourceToUse = ancientHazardImageUrl_player; }
                    else if (cellType.name === 'Sudden Death' && ancientSuddenDeathImageUrl_player) { imageSourceToUse = ancientSuddenDeathImageUrl_player; }
                    else if (cellType.name === 'Treasure' && ancientTreasureImageUrl_player) { imageSourceToUse = ancientTreasureImageUrl_player; }
                    else if (cellType.name === 'Twist of Fate' && ancientTwistImageUrl_player) { imageSourceToUse = ancientTwistImageUrl_player; }
                    else if (cellType.name === 'Major Treasure' && ancientMajorTreasureImageUrl_player) { imageSourceToUse = ancientMajorTreasureImageUrl_player; }
                }
                // End of Player-provided Ancient Era asset overrides
                else {
                    // If no specific image, try generic era images
                    if (era === 'kings' && kingsSquareImageUrls.length > 0) {
                        imageSourceToUse = kingsSquareImageUrls[kingsSquareImageIndex % kingsSquareImageUrls.length];
                        kingsSquareImageIndex++;
                    } else if (era === 'industrial' && !imageSourceToUse && industrialSquareImageUrls.length > 0) { // Check !imageSourceToUse to not overwrite specific assets
                        imageSourceToUse = industrialSquareImageUrls[industrialSquareImageIndex % industrialSquareImageUrls.length];
                        industrialSquareImageIndex++;
                    } else if (era === 'ancient' && ancientSquareImageUrls.length > 0) {
                        imageSourceToUse = ancientSquareImageUrls[ancientSquareImageIndex % ancientSquareImageUrls.length];
                        ancientSquareImageIndex++;
                    } else if (era === 'dark' && darkAgesSquareImageUrls.length > 0) {
                        imageSourceToUse = darkAgesSquareImageUrls[darkAgesSquareImageIndex % darkAgesSquareImageUrls.length];
                        darkAgesSquareImageIndex++;
                    }
                }
                }

                // Create and add text overlay (will be at z-index 1, behind images)
                const textOverlay = document.createElement('div');
                textOverlay.style.position = 'absolute';
                textOverlay.style.top = '0';
                textOverlay.style.left = '0';
                textOverlay.style.width = '100%';
                textOverlay.style.height = '100%';
                textOverlay.style.display = 'flex';
                textOverlay.style.flexDirection = 'column';
                textOverlay.style.justifyContent = 'center';
                textOverlay.style.alignItems = 'center';
                textOverlay.style.textAlign = 'center';
                textOverlay.style.padding = '3px';
                textOverlay.style.zIndex = '1'; // Lower z-index to ensure text is behind images
                textOverlay.style.textShadow = '0 0 2px black, 0 0 2px black, 0 0 2px black';
                textOverlay.style.backgroundColor = 'rgba(0, 0, 0, 0.2)'; // Semi-transparent background for better readability
                textOverlay.style.pointerEvents = 'none'; // Ensure text doesn't block clicks
                
                // Determine text content for the overlay (existing logic is fine here)
                let textContent = '';
                if (cellType.name === 'Hazard' && hazardNames[i]) {
                    textContent = `<div style="font-weight:bold;font-size:8px;">${cellType.name}</div><div style="font-size:7px;">${hazardNames[i]}</div>`;
                    cell.dataset.hazardName = hazardNames[i];
                } else if (cellType.name === 'Title' && titleNames[i]) {
                    textContent = `<div style="font-weight:bold;color:#3F51B5;font-size:8px;">${titleNames[i].split(' ')[0]}</div><div style="font-size:7px;">üëë</div>`;
                    cell.dataset.titleName = titleNames[i];
                } else if (cellType.name === 'Major Treasure') {
                    textContent = `<div style="font-weight:bold;color:#FFD700;font-size:8px;">Major</div><div style="font-size:7px;">üíé</div>`;
                } else if (cellType.name === 'Treasure') {
                    textContent = `<div style="font-weight:bold;color:#4CAF50;font-size:8px;">Treasure</div><div style="font-size:7px;">üèÜ</div>`;
                } else if (cellType.name === 'Twist of Fate') {
                    textContent = `<div style="font-weight:bold;color:#2196F3;font-size:8px;">Twist</div><div style="font-size:7px;">üîÑ</div>`;
                } else if (cellType.name === 'Nirvana') {
                    textContent = `<div style="font-weight:bold;color:#E91E63;font-size:8px;">${cellType.name}</div><div style="font-size:7px;">‚ú®</div>`;
                } else if (cellType.name === 'Roll Again') {
                    textContent = `<div style="font-weight:bold;color:#009688;font-size:8px;">Roll</div><div style="font-size:7px;">üé≤</div>`;
                } else if (cellType.name === 'Barter') {
                    textContent = `<div style="font-weight:bold;color:#FF9800;font-size:8px;">${cellType.name}</div><div style="font-size:7px;">üîÑ</div>`;
                } else if (cellType.name === 'Lucky Day') {
                    textContent = `<div style="font-weight:bold;color:#8BC34A;font-size:8px;">Lucky</div><div style="font-size:7px;">üçÄ</div>`;
                } else if (cellType.name === 'Charity') {
                    textContent = `<div style="font-weight:bold;color:#FFEB3B;font-size:8px;">${cellType.name}</div><div style="font-size:7px;">üí∞</div>`;
                } else if (cellType.name === 'Evil Eye') {
                    textContent = `<div style="font-weight:bold;color:#673AB7;font-size:8px;">Evil</div><div style="font-size:7px;">üëÅÔ∏è</div>`;
                } else if (cellType.name === 'Gamble') {
                    textContent = `<div style="font-weight:bold;color:#795548;font-size:8px;">${cellType.name}</div><div style="font-size:7px;">üéØ</div>`;
                } else if (cellType.name === 'Vengeance') {
                    textContent = `<div style="font-weight:bold;color:#FF5722;font-size:8px;">Revenge</div><div style="font-size:7px;">‚öîÔ∏è</div>`;
                } else if (cellType.name === 'Time Portal') {
                    textContent = `<div style="font-weight:bold;color:#00BCD4;font-size:8px;">Portal</div><div style="font-size:7px;">‚è≥</div>`;
                } else if (cellType.name === 'Sudden Death') {
                    textContent = `<div style="font-weight:bold;color:#9C27B0;font-size:8px;">Death</div><div style="font-size:7px;">üíÄ</div>`;
                } else if (cellType.name === 'Robbery') {
                    textContent = `<div style="font-weight:bold;color:#F44336;font-size:8px;">${cellType.name}</div><div style="font-size:7px;">üî™</div>`;
                } else if (cellType.name === 'Start' && i === 0) {
                    textContent = `<div style=\"font-weight:bold;color:#333333;font-size:8px;\">${cellType.name}</div>`; // Neutral text, no emoji for Start square
                } else {
                    textContent = `<div style="font-weight:bold;font-size:8px;">${cellType.name}</div>`;
                }
                
                // Add square number for debugging/reference
                textContent += `<div style="font-size:6px;color:#666;position:absolute;bottom:1px;right:1px;">${i+1}</div>`;
                textOverlay.innerHTML = textContent;
                cell.appendChild(textOverlay); // Text overlay added to cell

                // Handle background and image element based on cell type and image availability
                if (imageSourceToUse) { // This now includes the Start square if an image is set for it
                    const cellImage = document.createElement('img');
                    cellImage.src = imageSourceToUse;
                    cellImage.style.width = '100%';
                    cellImage.style.height = '100%';
                    cellImage.style.objectFit = 'contain'; // Ensures the entire image is visible within the cell
                    cellImage.style.position = 'absolute';
                    cellImage.style.top = '0';
                    cellImage.style.left = '0';
                    cellImage.style.zIndex = '2'; // Image layer, on top of text overlay (z-index 1)
                    cellImage.style.imageRendering = 'auto'; // Smooth rendering for better appearance
                    cell.appendChild(cellImage);
                    cell.style.backgroundColor = 'transparent'; // Make cell background transparent if image is used
                } else if (cellType.name === 'Start' && i === 0) { // Fallback for Start square if no imageSourceToUse
                     cell.style.backgroundColor = '#E0E0E0'; // Neutral grey background for Start square
                } else {
                    // For other cells that DO NOT have an image (and are not the Start square)
                    cell.style.backgroundColor = cellType.color + '33';
                }
                
                cell.classList.add(`era-${era}`);
                cell.dataset.pathIndex = i;
                cell.dataset.type = cellType.name;
                cell.style.borderColor = cellType.color;
                
                cell.addEventListener('click', () => showCellModal(i));
                
                let content = null;
                if (cellType.name === 'Treasure' && eraContent[era]) {
                    content = eraContent[era].treasures[Math.floor(Math.random() * eraContent[era].treasures.length)];
                } else if (cellType.name === 'Major Treasure' && eraContent[era]) {
                    content = eraContent[era].majorTreasures[Math.floor(Math.random() * eraContent[era].majorTreasures.length)];
                } else if (cellType.name === 'Twist of Fate' && eraContent[era]) {
                    content = eraContent[era].twists[Math.floor(Math.random() * eraContent[era].twists.length)];
                }
                
                gameState.board[i] = {
                    type: cellType.name,
                    effect: cellType.effect,
                    era: era,
                    x: position.x,
                    y: position.y,
                    content: content,
                    hazardName: hazardNames[i] || null,
                    titleName: titleNames[i] || null
                };
                
                gameBoard.appendChild(cell);
            }
        }
        
        // Set up event listeners
        function setupEventListeners() {
            // Remove existing listeners to prevent duplicates
            rollButton.removeEventListener('click', rollDice);
            inventoryButton.removeEventListener('click', toggleInventory);
            closeInventoryButton.removeEventListener('click', toggleInventory);
            eventButton.removeEventListener('click', hideEvent);
            
            // Add new listeners
            rollButton.addEventListener('click', rollDice);
            inventoryButton.addEventListener('click', toggleInventory);
            closeInventoryButton.addEventListener('click', toggleInventory); // This button is inside the main inventory panel
            // eventButton's listener is often set dynamically, but a generic hide can be a fallback.
            // It's better to ensure event-specific handlers are attached when an event modal is shown.
            // For the new select-inventory-modal:
            if (closeSelectInventoryModalButton) {
                 closeSelectInventoryModalButton.addEventListener('click', () => {
                    if(selectInventoryModal) selectInventoryModal.style.display = 'none';
                });
            }
        }
        
        // Toggle inventory panel logic
        function toggleInventory() {
            const mainInventoryPanel = document.getElementById('inventory');
            const selectInventoryModalElement = document.getElementById('select-inventory-modal');

            if (mainInventoryPanel.style.display === 'block') {
                mainInventoryPanel.style.display = 'none';
                return;
            }
            if (selectInventoryModalElement.style.display === 'block') {
                selectInventoryModalElement.style.display = 'none';
                return;
            }

            if (!gameState.players || gameState.players.length === 0) {
                toast("Game not started or no players available.");
                return;
            }

            const humanPlayers = gameState.players.map((p, index) => ({ ...p, originalIndex: index })).filter(p => !p.isAI);

            if (humanPlayers.length === 0) {
                toast("No human players to show inventory for.");
                return;
            }

            const playerWhoseInventory = gameState.players[playerIndexToShow];
            if (!playerWhoseInventory) {
                console.error("Player not found for inventory display, index:", playerIndexToShow);
                inventoryItems.innerHTML = '<p>Error: Player data not found.</p>';
                return;
            }
            inventoryItems.innerHTML = '';

            // If current player is human, show their inventory directly.
            // Or if only one human player exists in the game.
            if ((!currentPlayer.isAI && gameState.gameStarted) || humanPlayers.length === 1) {
                const playerIndexToShow = !currentPlayer.isAI ? gameState.currentPlayerIndex : humanPlayers[0].originalIndex;
                showPlayerSpecificInventory(playerIndexToShow);
            } else {
                // Multiple human players, and it's AI's turn, or game not focused on a single human player's turn context for inventory
                const playerButtonsContainer = document.getElementById('select-inventory-player-buttons');
                playerButtonsContainer.innerHTML = ''; // Clear previous buttons

                humanPlayers.forEach(player => {
                    const btn = document.createElement('button');
                    btn.textContent = player.name;
                    btn.style.margin = '5px'; // Ensure buttons have some spacing
                    btn.onclick = () => {
                        showPlayerSpecificInventory(player.originalIndex);
                        selectInventoryModalElement.style.display = 'none';
                    };
                    playerButtonsContainer.appendChild(btn);
                });
                selectInventoryModalElement.style.display = 'block';
            }
        }

        function showPlayerSpecificInventory(playerIndex) {
            updateInventoryDisplay(playerIndex); // Pass the target player index
            document.getElementById('inventory').style.display = 'block';
        }
        
        // Hide event display
        function hideEvent() {
            eventDisplay.style.display = 'none';
        }
        
        // Show event display
        function showEvent(title, description) {
            eventTitle.textContent = title;
            eventDescription.innerHTML = description;
            eventDisplay.style.display = 'block';
            
            // Reset event button
            const eventButtons = document.getElementById('event-buttons');
            eventButtons.innerHTML = '';
            const okButton = document.createElement('button');
            okButton.textContent = 'OK';
            okButton.id = 'event-button';
            okButton.onclick = hideEvent;
            eventButtons.appendChild(okButton);
        }
        
        // Update inventory display
        function updateInventoryDisplay(playerIndexToShow = gameState.currentPlayerIndex) {
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            inventoryItems.innerHTML = '';
            
            // Add player name and credits at the top of inventory
            const playerInfoElement = document.createElement('div');
            playerInfoElement.style.marginBottom = '15px';
            playerInfoElement.style.padding = '10px';
            playerInfoElement.style.backgroundColor = playerWhoseInventory.color;
            playerInfoElement.style.borderRadius = '5px';
            playerInfoElement.innerHTML = `<strong>${playerWhoseInventory.name}'s Inventory</strong><br>Credits: ${playerWhoseInventory.credits}`;
            inventoryItems.appendChild(playerInfoElement);
            
            // Display items section if any
            if (playerWhoseInventory.inventory.length > 0) {
                const itemsHeader = document.createElement('h4');
                itemsHeader.textContent = 'Items:';
                itemsHeader.style.marginBottom = '10px';
                inventoryItems.appendChild(itemsHeader);
                
                playerWhoseInventory.inventory.forEach((item, index) => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'inventory-item';
                    itemElement.innerHTML = `<strong>${item.name}</strong><br>${item.effect}`;
                    // Only allow using items if it's this player's actual turn
                    if (playerIndexToShow === gameState.currentPlayerIndex && !gameState.players[gameState.currentPlayerIndex].isAI) {
                       itemElement.onclick = () => useItem(index, playerIndexToShow); // Pass playerIndexToShow
                       itemElement.style.cursor = 'pointer';
                    } else {
                        itemElement.style.cursor = 'default'; // Not clickable if not their turn
                    }
                    inventoryItems.appendChild(itemElement);
                });
            } else {
                const noItemsElement = document.createElement('p');
                noItemsElement.textContent = 'No items in inventory';
                noItemsElement.style.fontStyle = 'italic';
                noItemsElement.style.marginBottom = '15px';
                inventoryItems.appendChild(noItemsElement);
            }
            
            // Display treasures section
            const treasuresHeader = document.createElement('h4');
            treasuresHeader.textContent = 'Treasures:';
            treasuresHeader.style.marginTop = '20px';
            treasuresHeader.style.marginBottom = '10px';
            inventoryItems.appendChild(treasuresHeader);
            
            if (playerWhoseInventory.treasures.length > 0) {
                // Sort treasures by value (highest first) for better display
                const sortedTreasures = [...playerWhoseInventory.treasures].sort((a, b) => {
                    const valueA = a.value || 0;
                    const valueB = b.value || 0;
                    return valueB - valueA;
                });
                
                sortedTreasures.forEach(treasure => {
                    const treasureElement = document.createElement('div');
                    treasureElement.className = 'inventory-item';
                    treasureElement.style.backgroundColor = 'rgba(255, 215, 0, 0.2)';
                    treasureElement.innerHTML = `<strong>${treasure.title}</strong><br>Value: ${treasure.value || 0} credits`;
                    treasureElement.onclick = () => showItemModal(treasure);
                    inventoryItems.appendChild(treasureElement);
                });
                
                // Calculate total treasure value
                const totalTreasureValue = playerWhoseInventory.treasures.reduce((sum, treasure) => sum + (treasure.value || 0), 0);
                
                // Add total treasure value
                const totalElement = document.createElement('div');
                totalElement.style.marginTop = '10px';
                totalElement.style.fontWeight = 'bold';
                totalElement.style.textAlign = 'right';
                totalElement.textContent = `Total Treasure Value: ${totalTreasureValue} credits`;
                inventoryItems.appendChild(totalElement);
                
                // Add combined value (credits + treasures)
                const combinedValue = playerWhoseInventory.credits + totalTreasureValue;
                const combinedElement = document.createElement('div');
                combinedElement.style.marginTop = '5px';
                combinedElement.style.fontWeight = 'bold';
                combinedElement.style.textAlign = 'right';
                combinedElement.style.color = '#4CAF50';
                combinedElement.textContent = `Combined Value: ${combinedValue} credits`;
                inventoryItems.appendChild(combinedElement);
            } else {
                const noTreasuresElement = document.createElement('p');
                noTreasuresElement.textContent = 'No treasures collected yet';
                noTreasuresElement.style.fontStyle = 'italic';
                inventoryItems.appendChild(noTreasuresElement);
            }
        }
        
        // Show cell modal
        function showCellModal(cellIndex) { // Removed autoClose parameter
            const cellData = gameState.board[cellIndex];
            if (!cellData) return;
            
            const cellModal = document.getElementById('cell-modal');
            const cellTitle = document.getElementById('cell-title');
            const cellDescription = document.getElementById('cell-description');
            const cellEra = document.getElementById('cell-era');
            
            cellTitle.textContent = cellData.type;
            cellDescription.textContent = cellData.effect;
            
            // Format era name for display
            let eraName = cellData.era.charAt(0).toUpperCase() + cellData.era.slice(1);
            if (eraName === 'Nirvana') eraName = 'Nirvana - End of the Journey';
            else eraName += ' Era';
            
            cellEra.textContent = eraName;
            
            cellModal.style.display = 'block';

            // Default close button action is just to hide THIS modal.
            // The actual game logic for the cell's effect is triggered elsewhere (in processCellEffect).
            document.getElementById('cell-close-button').onclick = () => {
                 cellModal.style.display = 'none';
            };
        }
        
        // Show item modal
        function showItemModal(item) {
            const itemModal = document.getElementById('item-modal');
            const itemTitle = document.getElementById('item-title');
            const itemDescription = document.getElementById('item-description');
            
            itemTitle.textContent = item.title || item.name;
            itemDescription.textContent = item.description || item.effect;
            
            // Check if the item has an image URL (for major treasures)
            if (item.imageUrl) {
                // Check if image container already exists, if not create it
                let imageContainer = document.getElementById('item-image-container');
                if (!imageContainer) {
                    imageContainer = document.createElement('div');
                    imageContainer.id = 'item-image-container';
                    imageContainer.style.textAlign = 'center';
                    imageContainer.style.marginBottom = '15px';
                    
                    // Insert the container before the description
                    itemModal.insertBefore(imageContainer, itemDescription);
                }
                
                // Clear any existing image
                imageContainer.innerHTML = '';
                
                // Create and add the image
                const img = document.createElement('img');
                img.src = item.imageUrl;
                img.style.maxWidth = '100%';
                img.style.maxHeight = '200px';
                img.style.objectFit = 'contain'; // Preserve aspect ratio
                img.style.marginBottom = '10px';
                imageContainer.appendChild(img);
                imageContainer.style.display = 'block';
            } else {
                // Hide image container if no image
                const imageContainer = document.getElementById('item-image-container');
                if (imageContainer) {
                    imageContainer.style.display = 'none';
                }
            }
            
            itemModal.style.display = 'block';
            
            document.getElementById('item-close-button').onclick = () => {
                itemModal.style.display = 'none';
                // If this is a treasure reveal after landing on a square, move to next player
                if (gameState.processingMove) {
                    setTimeout(nextPlayer, 500);
                }
            };
        }
        
        // Show toast message
        function toast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.display = 'block';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, duration);
        }
        
        // Use item from inventory
        function useItem(itemIndex, actingPlayerIndex = gameState.currentPlayerIndex) { // Added actingPlayerIndex
            const currentPlayer = gameState.players[actingPlayerIndex]; // Use actingPlayerIndex
            const item = currentPlayer.inventory[itemIndex];
            
            if (!item) return;
            
            // Apply item effect
            switch(item.name) {
                case 'Karma Shield':
                    currentPlayer.effects.push({
                        name: 'Karma Shield',
                        duration: 1,
                        effect: 'Protects against credit loss once'
                    });
                    toast(`${currentPlayer.name} activated a Karma Shield!`);
                    break;
                    
                case 'Credit Doubler':
                    currentPlayer.effects.push({
                        name: 'Credit Doubler',
                        duration: 3,
                        effect: 'Doubles credit gains for 3 turns'
                    });
                    toast(`${currentPlayer.name} activated a Credit Doubler for 3 turns!`);
                    break;
                    
                case 'Time Anchor':
                    currentPlayer.effects.push({
                        name: 'Time Anchor',
                        duration: 1,
                        effect: 'Prevents involuntary time jumps once'
                    });
                    toast(`${currentPlayer.name} activated a Time Anchor!`);
                    break;
                    
                case 'Karma Booster':
                    currentPlayer.effects.push({
                        name: 'Karma Booster',
                        duration: 3,
                        effect: 'Increases credit gain by 50% for 3 turns'
                    });
                    toast(`${currentPlayer.name} activated a Karma Booster for 3 turns!`);
                    break;
                    
                case 'Lucky Dice':
                    // Allow rerolling dice
                    toast(`${currentPlayer.name} can reroll the dice once!`);
                    break;
                    
                case 'Time Machine':
                    // Show era selection
                    showEvent('Time Machine', 
                        `${currentPlayer.name}, choose which era to travel to:`);
                    
                    const eventButtons = document.getElementById('event-buttons');
                    eventButtons.innerHTML = '';
                    
                    gameState.eras.forEach((era, index) => {
                        const button = document.createElement('button');
                        button.textContent = era.charAt(0).toUpperCase() + era.slice(1);
                        button.onclick = () => {
                            const newPosition = index * 40 + Math.floor(Math.random() * 10);
                            currentPlayer.position = Math.min(newPosition, boardPath.length - 1);
                            placePlayerTokens();
                            toast(`${currentPlayer.name} traveled to the ${era} era!`);
                            hideEvent();
                        };
                        eventButtons.appendChild(button);
                    });
                    break;
            }
            
            // Remove item from inventory
            currentPlayer.inventory.splice(itemIndex, 1);
            updateInventoryDisplay(actingPlayerIndex); // Update for the correct player
        }
        
        // Calculate total value of player's treasures
        function calculateTreasureValue(player) {
            let totalValue = 0;
            player.treasures.forEach(treasure => {
                if (treasure.value) {
                    totalValue += treasure.value;
                } else {
                    // Extract point value from description if possible
                    const pointMatch = treasure.description.match(/Worth (\d+) points/);
                    if (pointMatch) {
                        totalValue += parseInt(pointMatch[1]);
                    }
                }
            });
            return totalValue;
        }
        
        // Check if player can ascend to next karmic level
        function checkKarmicLevel(playerIndex) {
            const player = gameState.players[playerIndex];
            const treasureValue = calculateTreasureValue(player);
            const combinedTotal = player.credits + treasureValue;
            
            // Check if player has enough combined total to ascend
            if (combinedTotal >= 3000) {
                // Offer to ascend
                showEvent('Karmic Ascension', 
                    `${player.name}, you have reached a combined total of ${combinedTotal} credits and treasure value!\n\n` +
                    `Would you like to ascend to the next Karmic Level?\n\n` +
                    `Current level: ${gameState.karmicLevels[player.karmicLevel]}\n` +
                    `Next level: ${gameState.karmicLevels[player.karmicLevel + 1] || "Maximum Level Reached"}\n\n` +
                    `Cost: 3,000 from your combined total\n` +
                    `Current credits: ${player.credits}\n` +
                    `Current treasure value: ${treasureValue}\n` +
                    `Reward: 3,000 credits banked that cannot be lost`);
                
                // Clear previous buttons
                const eventButtons = document.getElementById('event-buttons');
                eventButtons.innerHTML = '';
                
                // Add Yes button
                const yesButton = document.createElement('button');
                yesButton.textContent = 'Yes';
                yesButton.style.marginRight = '10px';
                yesButton.style.backgroundColor = '#4CAF50';
                yesButton.onclick = () => {
                    if (combinedTotal >= 3000) {
                        // First use credits
                        let remaining = 3000;
                        if (player.credits >= remaining) {
                            player.credits -= remaining;
                            remaining = 0;
                        } else {
                            remaining -= player.credits;
                            player.credits = 0;
                        }
                        
                        // If we still need to deduct from treasures
                        if (remaining > 0) {
                            // Sort treasures by value (highest first) to optimize removal
                            player.treasures.sort((a, b) => {
                                const valueA = a.value || 0;
                                const valueB = b.value || 0;
                                return valueB - valueA;
                            });
                            
                            // Remove treasures until we've covered the remaining cost
                            while (remaining > 0 && player.treasures.length > 0) {
                                const treasure = player.treasures.shift(); // Remove the first (highest value) treasure
                                const treasureValue = treasure.value || 0;
                                remaining -= treasureValue;
                            }
                            
                            // If we've taken too much value, give some credits back
                            if (remaining < 0) {
                                player.credits += Math.abs(remaining);
                            }
                        }
                        
                        player.karmicLevel++;
                        player.bankedPoints += 3000;
                        toast(`${player.name} ascended to ${gameState.karmicLevels[player.karmicLevel]}!`);
                        hideEvent();
                        updatePlayerInfo();
                        setTimeout(proceedWithHumanRoll, 500); // Proceed with the turn
                    } else {
                        toast(`Not enough combined value to ascend!`);
                        hideEvent();
                        setTimeout(proceedWithHumanRoll, 500); // Still proceed if they somehow clicked yes without enough
                    }
                };
                eventButtons.appendChild(yesButton);
                
                // Add No button
                const noButton = document.createElement('button');
                noButton.textContent = 'No';
                noButton.style.backgroundColor = '#F44336';
                noButton.onclick = () => {
                    toast(`${player.name} chose not to ascend.`);
                    hideEvent();
                    setTimeout(proceedWithHumanRoll, 500); // Proceed with the turn
                };
                eventButtons.appendChild(noButton);
                
                return true; // Indicates we're handling karmic ascension
            }
            
            return false; // No karmic ascension happening
        }
        
        // Set up players
        function setupPlayers(numPlayers) {
            console.log('Setting up game with', numPlayers, 'players');
            startScreen.style.display = 'none';
            // Music will be stopped after the 'Game Started' modal
            gameState.players = [];
            gameState.lifetimeCredits = [];
            
            for (let i = 0; i < numPlayers; i++) {
                let playerName = prompt(`Enter name for Player ${i+1}:`, `Player ${i+1}`);
                if (!playerName) playerName = `Player ${i+1}`; // Default name if prompt is cancelled
                const isAI = false; // All players are human by default now
                
                
                const playerColors = ['#e74c3c', '#3498db', '#2ecc71', '#f1c40f', '#9b59b6'];
                const playerTokenImages = [
                    "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F5A59C78B-2A7B-4405-9873-0707F89C3BA6.png?alt=media&token=257fc43c-1796-4104-a6b3-2c33a9cf9b9a", // Player 1
                    "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2FE9272CBA-A623-4612-AE25-6ACE4F7BB25F.png?alt=media&token=11c3b652-52c4-4fd5-8e91-d68d97aecc4e", // Player 2
                    "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F41CB6EDC-277B-45BE-AE47-031BF571FFE6.png?alt=media&token=3037e7ca-20c3-4736-841b-1ddcf1bc3296", // Player 3
                    "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2FE0BDF60A-E089-4252-9C21-BE6B48463BAF.png?alt=media&token=bbbf7f52-4764-4201-9831-9571f2c56f0e", // Player 4
                    "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F4260A2E8-0F73-4F09-8824-0478437D665B.png?alt=media&token=ca7d76e7-8347-4224-8acf-6788a14524bf"  // Player 5
                ];
                
                gameState.players.push({
                    name: playerName,
                    credits: 1500, // Starting credits
                    position: 0,
                    inventory: [],
                    treasures: [], // Array to store treasures
                    color: playerColors[i],
                    tokenImage: playerTokenImages[i] || null, // Add token image URL
                    isAI: isAI,
                    hasInsurance: false,
                    skipNextTurn: false, // For Hazard squares
                    effects: [],
                    karmicLevel: 0, // Start at first level
                    bankedPoints: 0, // Points from karmic levels
                    offeredInsuranceThisTurn: false // Flag for insurance offer status this turn
                });
                
                // Initialize lifetime credits
                gameState.lifetimeCredits[i] = 0;
            }
            
            // Create the board first
            createBoard();
            
            // Populate all card data (Twist and Treasure)
            populateAllCardData();

            // Then update player info and place tokens
            updatePlayerInfo();
            placePlayerTokens();
            gameState.gameStarted = true;
            
            // Set up event listeners for game controls
            setupEventListeners();
            
            // Start game with the first player's turn sequence after setup.
            // The showTurnTransitionModal will lead to proceedWithTurn,
            // where the initial insurance offer will happen for the first player.
            showTurnTransitionModal(gameState.players[gameState.currentPlayerIndex]); // currentPlayerIndex is 0
        }
        

        
        // Update player information display
        function updatePlayerInfo() {
            playerInfo.innerHTML = '';
            
            // Add charity pool display
            const charityDiv = document.createElement('div');
            charityDiv.className = 'player-stats';
            charityDiv.style.backgroundColor = '#795548';
            charityDiv.innerHTML = `
                <strong>Charity Pool</strong><br>
                Credits: ${gameState.charityPool}
            `;
            playerInfo.appendChild(charityDiv);
            
            gameState.players.forEach((player, index) => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'player-stats';
                playerDiv.style.backgroundColor = player.color;
                playerDiv.style.display = index === gameState.currentPlayerIndex ? 'block' : 'none'; // Show only current player's stats
                
                // Add karmic level display
                const karmicLevelDisplay = `<span class="karmic-level">${gameState.karmicLevels[player.karmicLevel]}</span>`;
                
                playerDiv.innerHTML = `
                    <strong>${player.name}</strong> ${karmicLevelDisplay}<br>
                    Credits: ${player.credits}<br>
                    Treasures: ${player.treasures.length}<br>
                    ${player.hasInsurance ? 'üõ°Ô∏è Insured' : ''}
                    ${player.bankedPoints > 0 ? `<br>Banked: ${player.bankedPoints} credits` : ''}
                `;
                
                // Add a small treasures list if player has any and it's their turn
                if (index === gameState.currentPlayerIndex && player.treasures.length > 0) {
                    const treasuresList = document.createElement('div');
                    treasuresList.className = 'treasures-list';
                    
                    // Add a header for treasures
                    const treasuresHeader = document.createElement('div');
                    treasuresHeader.textContent = 'Treasures:';
                    treasuresHeader.style.fontWeight = 'bold';
                    treasuresHeader.style.marginBottom = '3px';
                    treasuresList.appendChild(treasuresHeader);
                    
                    player.treasures.forEach(treasure => {
                        const treasureItem = document.createElement('div');
                        treasureItem.textContent = `üèÜ ${treasure.title}`;
                        treasureItem.style.whiteSpace = 'nowrap';
                        treasureItem.style.overflow = 'hidden';
                        treasureItem.style.textOverflow = 'ellipsis';
                        treasureItem.style.cursor = 'pointer';
                        treasureItem.style.padding = '2px';
                        treasureItem.style.marginBottom = '2px';
                        treasureItem.style.backgroundColor = 'rgba(255, 215, 0, 0.2)';
                        treasureItem.style.borderRadius = '3px';
                        treasureItem.onclick = () => showItemModal(treasure);
                        treasuresList.appendChild(treasureItem);
                    });
                    
                    playerDiv.appendChild(treasuresList);
                }
                
                playerInfo.appendChild(playerDiv);
            });
        }
        
        // Place player tokens on the board
        function placePlayerTokens() {
            // Instead of removing and recreating all tokens, update existing ones when possible
            // This allows for smoother transitions between positions
            
            // First, get all existing tokens
            const existingTokens = {};
            document.querySelectorAll('.player-token').forEach(token => {
                const playerId = token.getAttribute('data-player-id');
                if (playerId) {
                    existingTokens[playerId] = token;
                } else {
                    // Remove tokens without player IDs (shouldn't happen, but just in case)
                    token.remove();
                }
            });
            
            // Add or update tokens for each player
            gameState.players.forEach((player, index) => {
                const position = player.position;
                const boardPosition = boardPath[position];
                
                if (!boardPosition) return;
                
                const cell = document.querySelector(`.cell[data-x="${boardPosition.x}"][data-y="${boardPosition.y}"]`);
                if (!cell) return;
                
                let token;
                const playerId = `player-${index}`;
                
                // Check if token already exists for this player
                if (existingTokens[playerId]) {
                    token = existingTokens[playerId];
                    // Remove from existingTokens object so we know it's been handled
                    delete existingTokens[playerId];
                    // Move token to the new cell if needed
                    if (token.parentElement !== cell) {
                        cell.appendChild(token);
                    }
                } else {
                    // Create new token if it doesn't exist
                    token = document.createElement('div');
                    token.className = 'player-token';
                    token.setAttribute('data-player-id', playerId);
                    
                    if (player.tokenImage) {
                        const img = document.createElement('img');
                        img.src = player.tokenImage;
                        img.style.width = '100%';
                        img.style.height = '100%';
                        img.style.objectFit = 'contain'; // Maintain aspect ratio
                        token.appendChild(img);
                        token.style.backgroundColor = 'transparent'; // No background color if using image
                    } else {
                        token.style.backgroundColor = player.color;
                        token.textContent = player.name.charAt(0);
                    }
                    
                    cell.appendChild(token);
                }
                
                // Update token appearance and position
                // Position token precisely at the center of the cell
                token.style.position = 'absolute';
                token.style.left = '50%';
                token.style.top = '50%';
                
                // Update current player highlight
                if (index === gameState.currentPlayerIndex) {
                    token.classList.add('current-player');
                } else {
                    token.classList.remove('current-player');
                }
                
                // Calculate offsets for multiple players on same cell
                let offsetX = 0, offsetY = 0;
                
                if (gameState.players.length <= 2) {
                    // For 1-2 players, simple left/right placement
                    offsetX = index * 6 - 3; // Smaller offset for better centering
                    offsetY = 0;
                } else if (gameState.players.length <= 4) {
                    // For 3-4 players, 2x2 grid pattern
                    offsetX = (index % 2) * 6 - 3; // Smaller offset
                    offsetY = Math.floor(index / 2) * 6 - 3; // Smaller offset
                } else {
                    // For 5+ players, circular arrangement
                    const angle = (index / gameState.players.length) * 2 * Math.PI;
                    const radius = 5; // Smaller radius for tighter grouping
                    offsetX = Math.cos(angle) * radius;
                    offsetY = Math.sin(angle) * radius;
                }
                
                // Apply transform with precise offset
                token.style.transform = `translate(calc(-50% + ${offsetX}px), calc(-50% + ${offsetY}px))`;
                
                // Ensure token is above cell content and board tiles
                token.style.zIndex = index === gameState.currentPlayerIndex ? '21' : '20';
            });
            
            // Remove any tokens that weren't updated (players that no longer exist)
            Object.values(existingTokens).forEach(token => token.remove());
            
            // Center on current player after placing tokens
            // Use a shorter delay and don't force instant centering for smoother camera movement
            setTimeout(() => {
                // Only use instant centering if this is the first placement (game start)
                const useInstantCentering = gameState.turnCount <= gameState.players.length;
                centerOnPlayer(gameState.currentPlayerIndex, useInstantCentering);
            }, 30);
        }
        
        // Animate player movement step-by-step with smoother transitions
        function animateMovement(playerIndex, startPos, endPos, isMovingForward, callback) {
            const player = gameState.players[playerIndex];
            let currentAnimatedPosition = startPos;
            
            // Set the player's logical position to the start of the animation path initially
            player.position = startPos; 
            placePlayerTokens(); // Show token at the very start of animation path before first step
            
            // Always center camera on player - do this instantly for the first position
            centerOnPlayer(playerIndex, true); // true = instant centering

            // Adjust step time based on the length of the move for more natural pacing
            const totalSteps = Math.abs(endPos - startPos);
            const baseStepTime = 250; // Base milliseconds per step
            const stepTime = totalSteps > 10 ? 180 : (totalSteps > 5 ? 220 : baseStepTime); // Faster for longer moves
            const isLongMove = totalSteps > 5; // Consider moves of more than 5 spaces as "long moves"

            // Adjust zoom level for better visibility during movement
            // For long moves, we want to ensure the player can see more of the board
            if (isLongMove && zoomLevel > 1.5) {
                // Smoothly reduce zoom for long movements to show more context
                const originalZoom = zoomLevel;
                const targetZoom = Math.max(1.5, zoomLevel * 0.8);
                
                // Apply smooth zoom transition
                const boardWrapper = document.getElementById('board-wrapper');
                boardWrapper.style.transition = 'transform 0.5s ease-out';
                zoomLevel = targetZoom;
                updateBoardTransform();
                
                // Restore original zoom after movement completes with smooth transition
                setTimeout(() => {
                    boardWrapper.style.transition = 'transform 0.6s ease-out';
                    zoomLevel = originalZoom;
                    updateBoardTransform();
                    setTimeout(() => centerOnPlayer(playerIndex), 100); // Slight delay for smoother feel
                }, stepTime * totalSteps + 500);
            }

            function step() {
                let animationFinished = false;
                let nextStepPosition = currentAnimatedPosition;

                if (isMovingForward) {
                    if (currentAnimatedPosition < endPos) {
                        nextStepPosition++;
                    } else {
                        animationFinished = true;
                    }
                } else { // Moving backward
                    if (currentAnimatedPosition > endPos) {
                        nextStepPosition--;
                    } else {
                        animationFinished = true;
                    }
                }

                if (!animationFinished) {
                    currentAnimatedPosition = nextStepPosition;
                    player.position = currentAnimatedPosition; // Update logical position for visual placement
                    
                    // Apply CSS transition to player tokens for smoother movement
                    const tokens = document.querySelectorAll('.player-token');
                    tokens.forEach(token => {
                        token.style.transition = 'transform 0.2s ease-out, left 0.2s ease-out, top 0.2s ease-out';
                    });
                    
                    placePlayerTokens(); 
                    
                    // Only center camera on the active player during movement
                    if (followPlayer && playerIndex === gameState.currentPlayerIndex) {
                        if (isLongMove) {
                            // For long moves, use smoother transitions with a slight delay
                            // This creates a more cinematic camera that follows the player with a slight lag
                            setTimeout(() => {
                                const boardWrapper = document.getElementById('board-wrapper');
                                boardWrapper.style.transition = 'transform 0.4s cubic-bezier(0.25, 0.1, 0.25, 1)';
                                centerOnPlayer(playerIndex, false);
                            }, stepTime / 5);
                        } else {
                            // For short moves, follow more tightly but still smoothly
                            const boardWrapper = document.getElementById('board-wrapper');
                            boardWrapper.style.transition = 'transform 0.3s cubic-bezier(0.25, 0.1, 0.25, 1)';
                            centerOnPlayer(playerIndex, false);
                        }
                        
                        // For positions near the edge of the board, ensure we can see the token
                        const position = boardPath[currentAnimatedPosition];
                        if (position && (position.x <= 1 || position.x >= 14 || position.y <= 1 || position.y >= 14)) {
                            // Force an immediate centering for edge positions
                            centerOnPlayer(playerIndex, false);
                        }
                    }
                    
                    // Adaptive timing for smoother movement - slow down slightly at the end
                    const remainingSteps = Math.abs(endPos - currentAnimatedPosition);
                    const adjustedStepTime = remainingSteps <= 2 ? stepTime * 1.2 : stepTime;
                    
                    setTimeout(step, adjustedStepTime);
                } else {
                    player.position = endPos; // Ensure final logical position is accurate
                    
                    // Final token placement with smooth transition
                    const tokens = document.querySelectorAll('.player-token');
                    tokens.forEach(token => {
                        token.style.transition = 'transform 0.3s ease-out, left 0.3s ease-out, top 0.3s ease-out';
                    });
                    
                    placePlayerTokens(); // Final draw at the actual end position
                    
                    // Final centering on player - only if it's the active player
                    if (followPlayer && playerIndex === gameState.currentPlayerIndex) {
                        const boardWrapper = document.getElementById('board-wrapper');
                        boardWrapper.style.transition = 'transform 0.4s ease-out';
                        centerOnPlayer(playerIndex, false);
                    }
                    
                    // Reset token transitions after animation completes
                    setTimeout(() => {
                        const tokens = document.querySelectorAll('.player-token');
                        tokens.forEach(token => {
                            token.style.transition = '';
                        });
                        
                        if (callback) {
                            callback(); // Proceed with game logic (era check, cell effect)
                        }
                    }, 300); // Wait for final transition to complete
                }
            }

            if (startPos === endPos) { // No actual movement needed
                if (callback) callback();
                return;
            }
            
            // Start the first actual step of movement after a short delay to ensure initial render
            setTimeout(step, stepTime / 2); 
        }

        // Roll the dice
        // This function will contain the core dice rolling and movement logic for human players
        function proceedWithHumanRoll() {
            rollButton.disabled = true; // Ensure it's disabled at the start of processing the roll
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            
            // Disable roll button during turn
            rollButton.disabled = true;
            
            // Roll the dice
            const diceResult = rollTwoDice();
            animateDiceRoll(diceResult);
            
            // Increment turn count
            gameState.turnCount++;
            
            // Check if doubles were rolled
            if (diceResult.isDoubles && !currentPlayer.isAI) {
                // For human players, offer choice to move forward or backward
                setTimeout(() => {
                    showEvent('Doubles Rolled!', 
                        `${currentPlayer.name}, you rolled doubles (${diceResult.die1} and ${diceResult.die2})!\n\n` +
                        `You can choose to move forward or backward ${diceResult.total} spaces.`);
                    
                    // Clear previous buttons
                    const directionButtons = document.getElementById('event-buttons');
                    directionButtons.innerHTML = '';
                    
                    // Forward button
                    const forwardButton = document.createElement('button');
                    forwardButton.textContent = 'Forward';
                    forwardButton.onclick = () => {
                        hideEvent();
                        const oldPosForMove = currentPlayer.position;
                        const targetPosForMove = Math.min(oldPosForMove + diceResult.total, 169);
                        
                        animateMovement(gameState.currentPlayerIndex, oldPosForMove, targetPosForMove, true, () => {
                            currentPlayer.offeredInsuranceThisTurn = false; 
                            const landedEra = getEraFromPosition(targetPosForMove);
                            const originalEraForCheck = getEraFromPosition(oldPosForMove);

                            if (originalEraForCheck !== landedEra && landedEra !== 'nirvana' && gameState.turnCount > gameState.players.length) {
                                gameState.currentEra = landedEra; 
                                currentPlayer.credits += 200;
                                gameState.lifetimeCredits[gameState.currentPlayerIndex] += 200;
                                toast(`${currentPlayer.name} has entered the ${landedEra.charAt(0).toUpperCase() + landedEra.slice(1)} Era and received 200 credits!`);
                                updatePlayerInfo(); 

                                currentPlayer.offeredInsuranceThisTurn = true;
                                offerInsuranceConditional(true, () => { 
                                    processCellEffect(); 
                                });
                            } else {
                                processCellEffect();
                            }
                        });
                    };
                    directionButtons.appendChild(forwardButton);
                    
                    // Backward button
                    const backwardButton = document.createElement('button');
                    backwardButton.textContent = 'Backward';
                    backwardButton.onclick = () => {
                        hideEvent();
                        const oldPosForMove = currentPlayer.position;
                        const targetPosForMove = Math.max(oldPosForMove - diceResult.total, 0);
                        
                        animateMovement(gameState.currentPlayerIndex, oldPosForMove, targetPosForMove, false, () => {
                            currentPlayer.offeredInsuranceThisTurn = false; 
                            const landedEra = getEraFromPosition(targetPosForMove);
                            const originalEraForCheck = getEraFromPosition(oldPosForMove);

                            if (originalEraForCheck !== landedEra && landedEra !== 'nirvana' && gameState.turnCount > gameState.players.length) {
                                gameState.currentEra = landedEra; 
                                currentPlayer.credits += 200;
                                gameState.lifetimeCredits[gameState.currentPlayerIndex] += 200;
                                toast(`${currentPlayer.name} has entered the ${landedEra.charAt(0).toUpperCase() + landedEra.slice(1)} Era and received 200 credits!`);
                                updatePlayerInfo(); 

                                currentPlayer.offeredInsuranceThisTurn = true;
                                offerInsuranceConditional(true, () => { 
                                    processCellEffect(); 
                                });
                            } else {
                                processCellEffect();
                            }
                        });
                    };
                    directionButtons.appendChild(backwardButton);
                }, 2000); // Wait for dice animation to complete
                return;
            }
            
            // Proceed with normal movement
            const oldPosForMove = currentPlayer.position; // Capture position before animation starts
            const targetPosForMove = Math.min(oldPosForMove + diceResult.total, 169);

            animateMovement(gameState.currentPlayerIndex, oldPosForMove, targetPosForMove, true, () => {
                // Callback after animation completes
                currentPlayer.offeredInsuranceThisTurn = false; 
                const landedEra = getEraFromPosition(targetPosForMove);
                const originalEraForCheck = getEraFromPosition(oldPosForMove);

                if (originalEraForCheck !== landedEra && landedEra !== 'nirvana' && gameState.turnCount > gameState.players.length) {
                    gameState.currentEra = landedEra; 
                    currentPlayer.credits += 200;
                    gameState.lifetimeCredits[gameState.currentPlayerIndex] += 200;
                    toast(`${currentPlayer.name} has entered the ${landedEra.charAt(0).toUpperCase() + landedEra.slice(1)} Era and received 200 credits!`);
                    updatePlayerInfo(); 

                    currentPlayer.offeredInsuranceThisTurn = true;
                    offerInsuranceConditional(true, () => { 
                        processCellEffect(); 
                    });
                } else {
                    processCellEffect();
                }
            });
        }

        // Main function called when human player clicks the roll button
        function rollDice() {
            if (!gameState.gameStarted) return;
            if (gameState.processingMove) return; // Prevent multiple rolls during processing
            gameState.processingMove = true; // Ensure the game state reflects that a move is being processed
            
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            
            // Disable roll button by default, enable for human player later if it's their turn
            rollButton.disabled = true;

            // Check if it's an AI player's turn

            
            // Check if player can ascend to next karmic level
            if (checkKarmicLevel(gameState.currentPlayerIndex)) {
                // checkKarmicLevel shows a modal, and its buttons will call proceedWithHumanRoll.
                return; // Stop here, wait for ascension decision.
            }

            // If no ascension pathway taken by checkKarmicLevel, proceed directly.
            // Ensure roll button is disabled while human player makes ascension choice
            rollButton.disabled = true;
            proceedWithHumanRoll();
        }
        
        // Handle AI player turn
        function handleAITurn() {
            if (gameState.processingMove) return; // Prevent multiple turns during processing
            
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            
            // Disable roll button during AI turn
            rollButton.disabled = true;
            
            // Check if AI can ascend to next karmic level
            const playerIndex = gameState.currentPlayerIndex;
            const treasureValue = calculateTreasureValue(currentPlayer);
            const combinedTotal = currentPlayer.credits + treasureValue;
            
            if (combinedTotal >= 3000) {
                // AI always ascends if it can afford it
                // First use credits
                let remaining = 3000;
                if (currentPlayer.credits >= remaining) {
                    currentPlayer.credits -= remaining;
                    remaining = 0;
                } else {
                    remaining -= currentPlayer.credits;
                    currentPlayer.credits = 0;
                }
                
                // If we still need to deduct from treasures
                if (remaining > 0) {
                    // Sort treasures by value (highest first) to optimize removal
                    currentPlayer.treasures.sort((a, b) => {
                        const valueA = a.value || 0;
                        const valueB = b.value || 0;
                        return valueB - valueA;
                    });
                    
                    // Remove treasures until we've covered the remaining cost
                    while (remaining > 0 && currentPlayer.treasures.length > 0) {
                        const treasure = currentPlayer.treasures.shift(); // Remove the first (highest value) treasure
                        const treasureValue = treasure.value || 0;
                        remaining -= treasureValue;
                    }
                    
                    // If we've taken too much value, give some credits back
                    if (remaining < 0) {
                        currentPlayer.credits += Math.abs(remaining);
                    }
                }
                
                currentPlayer.karmicLevel++;
                currentPlayer.bankedPoints += 3000;
                toast(`${currentPlayer.name} ascended to ${gameState.karmicLevels[currentPlayer.karmicLevel]}!`);
                updatePlayerInfo();
                
                // Continue with turn after a delay
                setTimeout(() => {
                    continueAITurn();
                }, 1500);
                return;
            }
            
            continueAITurn();
        }
        
        // Continue AI turn after karmic level check
        function continueAITurn() {
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            
            // Simple AI logic: use items if beneficial
            let itemUsed = false;
            
            if (currentPlayer.inventory.length > 0) {
                // Use Karma Shield if karma is low
                const karmaShield = currentPlayer.inventory.find(item => item.name === 'Karma Shield');
                if (karmaShield && currentPlayer.credits < 200) {
                    useItem(currentPlayer.inventory.indexOf(karmaShield));
                    itemUsed = true;
                }
                
                // Use Credit Doubler if available
                const creditDoubler = currentPlayer.inventory.find(item => item.name === 'Credit Doubler');
                if (creditDoubler && !itemUsed) {
                    useItem(currentPlayer.inventory.indexOf(creditDoubler));
                    itemUsed = true;
                }
            }
            
            // Roll the dice after a short delay
            setTimeout(() => {
                const roll = rollTwoDice();
                diceDisplay.textContent = `üé≤ ${roll}`;
                toast(`${currentPlayer.name} rolled a ${roll}`);
                
                // Increment turn count
                gameState.turnCount++;
                
                // Increment turn count for AI as well
                gameState.turnCount++;

                // Move the player using animateMovement for full logic
                const oldPosForMove = currentPlayer.position;
                const targetPosForMove = Math.min(oldPosForMove + roll, 169);
                const isMovingForward = true; // AI always moves forward from dice roll

                animateMovement(gameState.currentPlayerIndex, oldPosForMove, targetPosForMove, isMovingForward, () => {
                    currentPlayer.offeredInsuranceThisTurn = false; // Reset flag
                    const landedEra = getEraFromPosition(targetPosForMove);
                    const originalEraForCheck = getEraFromPosition(oldPosForMove);

                    if (originalEraForCheck !== landedEra && landedEra !== 'nirvana' && gameState.turnCount > gameState.players.length) {
                         gameState.currentEra = landedEra;
                         currentPlayer.credits += 200;
                         gameState.lifetimeCredits[gameState.currentPlayerIndex] += 200;
                         toast(`${currentPlayer.name} (AI) entered the ${landedEra.charAt(0).toUpperCase() + landedEra.slice(1)} Era and received 200 credits.`);
                         updatePlayerInfo();

                         currentPlayer.offeredInsuranceThisTurn = true; // Mark that insurance context is era change
                         offerInsuranceConditional(true, () => { // true for eraChangeOffer, AI logic is handled within
                             processCellEffect();
                         });
                    } else {
                         // Not an era change, it's an early turn, or it's Nirvana
                         processCellEffect(); // Directly process cell effect
                    }
                });
            }, 1500);
        }
        
        // This function is now obsolete as animateMovement handles the full sequence.
        /* function movePlayer(spaces) { ... } */
        
        // Get the era based on position
        function getEraFromPosition(position) { // position is 0-indexed
            if (position < 46) return 'industrial'; // Indices 0-45
            if (position < 89) return 'kings';    // Indices 46-88
            if (position < 137) return 'dark';     // Indices 89-136
            if (position < 169) return 'ancient';  // Indices 137-168
            return 'nirvana'; // Index 169
        }
        
        // Function to move to the next player
        function nextPlayer() {
            // Reset processing flag
            gameState.processingMove = false;
            
            // Enable roll button (will be re-enabled specifically for human player in proceedWithTurn)
            // rollButton.disabled = false; 
            
            // Check if game is over (someone reached Nirvana)
            if (gameState.players.some(p => p.position === 169)) {
                endGame();
                return;
            }
            
            // IMPORTANT: Keep the current player centered until we show the transition modal
            // This ensures the active player remains visible throughout their entire turn
            // Force an immediate centering with true parameter to ensure perfect centering
            centerOnPlayer(gameState.currentPlayerIndex, true);
            updatePlayerInfo(); // Update info to reflect the end of the current player's turn visuals before modal
            
            // Move to next player index
            gameState.currentPlayerIndex = (gameState.currentPlayerIndex + 1) % gameState.players.length;
            const playerForThisTurn = gameState.players[gameState.currentPlayerIndex];

            // Update player info display early so the highlight moves immediately
            updatePlayerInfo(); 
            
            // Show the transition modal. Camera centering for the new player happens inside showTurnTransitionModal.
            showTurnTransitionModal(playerForThisTurn);
        }

        function showTurnTransitionModal(player) {
            turnTransitionPlayerName.textContent = `${player.name}'s Turn`;
            turnTransitionMessage.textContent = "It's your turn!";
            
            // CRITICAL: Only NOW center camera on the new active player when the modal is shown
            // This ensures the previous player remains perfectly centered until this modal appears
            // The true parameter forces an immediate camera transition without animation
            centerOnPlayer(gameState.currentPlayerIndex, true);
            
            turnTransitionOkButton.onclick = () => {
                turnTransitionModal.style.display = 'none';
                proceedWithTurn(player); 
            };

            turnTransitionModal.style.display = 'block';

            turnTransitionOkButton.disabled = false; // Ensure button is enabled for human player
        }

        function proceedWithTurn(playerForThisTurn) {
            // Offer initial insurance if it's their first turn and not yet offered
            if (!playerForThisTurn.initialInsuranceOffered) {
                playerForThisTurn.initialInsuranceOffered = true;
                const insuranceCost = 500;

                const startPlayerTurnLogic = () => {
                    if (playerForThisTurn.skipNextTurn) {
                        toast(`${playerForThisTurn.name} misses their turn!`);
                        playerForThisTurn.skipNextTurn = false; // Consume the skip
                        setTimeout(() => { nextPlayer(); }, 1500);
                        return;
                    }
                    rollButton.disabled = false;
                    toast(`It's ${playerForThisTurn.name}'s turn. Roll the dice!`);
                };



                // Human Player Logic for initial insurance
                showEvent('Initial Insurance Offer',
                    `Welcome to your first turn, ${playerForThisTurn.name}! Would you like to buy insurance?\n\nIt costs ${insuranceCost} credits and protects against Sudden Death.\n\nYour current credits: ${playerForThisTurn.credits}`);

                const eventButtons = document.getElementById('event-buttons');
                eventButtons.innerHTML = '';

                const yesButton = document.createElement('button');
                yesButton.textContent = 'Yes, Buy Insurance';
                yesButton.style.marginRight = '10px';
                yesButton.style.backgroundColor = '#4CAF50';
                yesButton.disabled = playerForThisTurn.credits < insuranceCost;

                yesButton.onclick = () => {
                    if (playerForThisTurn.credits >= insuranceCost) {
                        playerForThisTurn.credits -= insuranceCost;
                        playerForThisTurn.hasInsurance = true;
                        toast(`${playerForThisTurn.name} bought initial insurance!`);
                    } else {
                        toast(`${playerForThisTurn.name} cannot afford initial insurance.`);
                    }
                    hideEvent();
                    updatePlayerInfo();
                    startPlayerTurnLogic(); // Proceed with turn logic
                };
                eventButtons.appendChild(yesButton);

                const noButton = document.createElement('button');
                noButton.textContent = 'No, Decline';
                noButton.style.backgroundColor = '#F44336';
                noButton.onclick = () => {
                    toast(`${playerForThisTurn.name} declined initial insurance.`);
                    hideEvent();
                    updatePlayerInfo();
                    startPlayerTurnLogic(); // Proceed with turn logic
                };
                eventButtons.appendChild(noButton);
                return; // Human needs to click, then turn proceeds via startPlayerTurnLogic
            }

            // Original proceedWithTurn logic (if not first turn or initial insurance already handled)
            if (playerForThisTurn.skipNextTurn) {
                toast(`${playerForThisTurn.name} misses their turn!`);
                playerForThisTurn.skipNextTurn = false; // Consume the skip
                
                // Automatically advance to the next player after a delay
                setTimeout(() => {
                    nextPlayer(); // Recursive call to find the actual next player
                }, 1500); // Delay to show the message
                return; // Stop further processing for the skipped player's turn
            }
            
            // Human player's turn
            rollButton.disabled = false; // Enable roll button ONLY for the human player whose turn it is.
            toast(`It's ${playerForThisTurn.name}'s turn. Roll the dice!`);
        }
        
        // End the game and show final scores
        function endGame() {
            // Calculate final scores
            const scores = gameState.players.map(player => {
                // Base score is credits
                let score = player.credits;
                
                // Add value of treasures
                player.treasures.forEach(treasure => {
                    score += treasure.value || 0; // Use the stored value property, fallback to 0 if undefined/null
                });
                
                // Add banked points from karmic levels
                score += player.bankedPoints;
                
                return {
                    name: player.name,
                    score: score,
                    treasures: player.treasures.length,
                    karmicLevel: player.karmicLevel,
                    bankedPoints: player.bankedPoints
                };
            });
            
            // Sort by score
            scores.sort((a, b) => b.score - a.score);
            
            // Create results message
            let resultsMessage = "Game Over! Final Scores:\n\n";
            
            scores.forEach((playerScore, index) => {
                resultsMessage += `${index + 1}. ${playerScore.name}: ${playerScore.score} credits\n`;
                resultsMessage += `   ‚Ä¢ Karmic Level: ${gameState.karmicLevels[playerScore.karmicLevel]} (${playerScore.bankedPoints} credits)\n`;
                resultsMessage += `   ‚Ä¢ Treasures: ${playerScore.treasures}\n`;
            });
            
            // Show winner
            const winner = scores[0];
            resultsMessage += `\n${winner.name} has reached Nirvana with the highest score!`;
            
            // Display results
            showEvent('Game Over', resultsMessage);
            
            // Modify event button to trigger Past Life Reveal sequence
            const eventButtonsContainer = document.getElementById('event-buttons');
            const revealButton = eventButtonsContainer.firstChild; // Assuming it's the first/only button
            if (revealButton) {
                revealButton.textContent = 'Reveal Past Lives';
                revealButton.onclick = () => startPastLifeReveal(scores);
            } else {
                // Fallback if no button found, create one
                const newRevealButton = document.createElement('button');
                newRevealButton.textContent = 'Reveal Past Lives';
                newRevealButton.onclick = () => startPastLifeReveal(scores);
                eventButtonsContainer.appendChild(newRevealButton);
            }
        }
        


        // Offer insurance conditionally (e.g., on era change or Title square)
        function offerInsuranceConditional(isEraChangeOffer, nextActionCallback) {
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            const insuranceCost = 500;
            let offerReasonMessage = "";

            if (isEraChangeOffer) {
                offerReasonMessage = `Welcome to the ${gameState.currentEra.charAt(0).toUpperCase() + gameState.currentEra.slice(1)} Era, ${currentPlayer.name}! `;
            }



            // Human Player Logic
            showEvent('Insurance Offer',
                `${offerReasonMessage}Would you like to buy insurance protection?\n\n` +
                `Insurance costs ${insuranceCost} credits and protects against Sudden Death.\n\n` +
                `Your current credits: ${currentPlayer.credits}${currentPlayer.hasInsurance ? '. You are already insured.' : '.'}`);

            const eventButtons = document.getElementById('event-buttons');
            eventButtons.innerHTML = '';

            const yesButton = document.createElement('button');
            yesButton.textContent = 'Yes, Buy Insurance';
            yesButton.style.marginRight = '10px';
            yesButton.style.backgroundColor = '#4CAF50';
            yesButton.disabled = currentPlayer.credits < insuranceCost || currentPlayer.hasInsurance;
            if (currentPlayer.hasInsurance) {
                yesButton.textContent = "Already Insured"; 
            }

            yesButton.onclick = () => {
                if (!currentPlayer.hasInsurance && currentPlayer.credits >= insuranceCost) { 
                    currentPlayer.credits -= insuranceCost;
                    currentPlayer.hasInsurance = true;
                    toast(`${currentPlayer.name} bought insurance!`);
                } else if (currentPlayer.hasInsurance) {
                    toast(`${currentPlayer.name} is already insured.`);
                } else {
                    toast(`${currentPlayer.name} cannot afford insurance.`);
                }
                hideEvent();
                updatePlayerInfo(); 
                if (nextActionCallback) setTimeout(nextActionCallback, 500);
            };
            eventButtons.appendChild(yesButton);

            const noButton = document.createElement('button');
            noButton.textContent = 'No, Decline';
            noButton.style.backgroundColor = '#F44336';
            noButton.onclick = () => {
                toast(`${currentPlayer.name} declined insurance.`);
                hideEvent();
                if (nextActionCallback) setTimeout(nextActionCallback, 500);
            };
            eventButtons.appendChild(noButton);
        }


        
        // Process the effect of the cell the player landed on
        function processCellEffect() {
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            const cellData = gameState.board[currentPlayer.position];
            
            if (!cellData) {
                console.warn("No cell data found for player position, proceeding to next player.");
                gameState.processingMove = false; // Reset flag if something went wrong
                nextPlayer();
                return;
            }

            const applyEffect = () => {
                document.getElementById('cell-modal').style.display = 'none'; // Ensure cell modal is hidden

                switch (cellData.type) {
                    case 'Start':
                        toast(`${currentPlayer.name} is at the starting point.`);
                        setTimeout(nextPlayer, 1000);
                        break;
                        
                    case 'Title':
                        // Title square - only give credits if not the first turn
                        if (gameState.turnCount > gameState.players.length) {
                            toast(`${currentPlayer.name} landed on a Title square and gained 200 credits.`);
                            currentPlayer.credits += 200;
                            gameState.lifetimeCredits[gameState.currentPlayerIndex] += 200;
                            updatePlayerInfo();
                        } else {
                            toast(`${currentPlayer.name} landed on a Title square.`);
                        }
                        updatePlayerInfo(); // Update info after potential credit gain
                        
                        // Offer insurance for landing on Title, but only if not already offered for era change
                        if (!currentPlayer.offeredInsuranceThisTurn) {
                            offerInsuranceConditional(false, () => { // false indicates it's the standard Title square offer
                                setTimeout(nextPlayer, 1000); // After insurance, proceed to next player
                            });
                        } else {
                            // Insurance was already offered due to era change, so just proceed to next player
                            setTimeout(nextPlayer, 1000);
                        }

                        break;
                        
                    case 'Treasure':
                        // Flash treasure chest image
                        const treasureFlash = document.getElementById('treasure-flash');
                        treasureFlash.style.display = 'block';
                        sounds.treasureChestOpen.play();
                        setTimeout(() => {
                            treasureFlash.style.display = 'none';
                        }, 1000);
                        
                        // Pay 200 credits to draw a treasure card
                        if (currentPlayer.credits >= 100) {
                            showEvent('Treasure Square', 
                                `${currentPlayer.name}, would you like to pay 100 credits to draw a treasure card?\n\n` +
                                `Your current credits: ${currentPlayer.credits}`);
                            
                            // Clear previous buttons
                            const treasureButtons = document.getElementById('event-buttons');
                            treasureButtons.innerHTML = '';
                            
                            // Yes button
                            const yesButton = document.createElement('button');
                            yesButton.textContent = 'Yes';
                            yesButton.onclick = () => {
                                // Deduct credits
                                currentPlayer.credits -= 100;
                                updatePlayerInfo(); // Update credits display immediately
                                
                                // Get a treasure based on era
                                if (eraContent[cellData.era] && eraContent[cellData.era].treasures.length > 0) {
                                    const treasureIndex = Math.floor(Math.random() * eraContent[cellData.era].treasures.length);
                                    let treasure = {...eraContent[cellData.era].treasures[treasureIndex]}; // Create a copy

                                    // Ensure 'value' property is set, parsing from description if needed (as a fallback)
                                    if (treasure.value === undefined) {
                                        const pointMatch = treasure.description.match(/Worth (\\d+) points/);
                                        treasure.value = pointMatch ? parseInt(pointMatch[1]) : 0;
                                    }
                                    
                                    currentPlayer.treasures.push(treasure);
                                    
                                    // Show the treasure
                                    hideEvent();
                                    toast(`${currentPlayer.name} acquired: ${treasure.title} (Worth ${treasure.value} credits)!`);
                                    setTimeout(() => {
                                        showItemModal(treasure); // showItemModal will handle moving to next player after close
                                    }, 1000);
                                } else {
                                    hideEvent();
                                    toast(`${currentPlayer.name} paid 100 credits but found no treasure in the ${cellData.era} era!`);
                                    setTimeout(nextPlayer, 1000);
                                }
                                updatePlayerInfo(); // Update treasures display
                            };
                            treasureButtons.appendChild(yesButton);
                            
                            // No button
                            const noButton = document.createElement('button');
                            noButton.textContent = 'No';
                            noButton.onclick = () => {
                                // Refund the credits since player declined (if any were pre-deducted by mistake, ensure logic is only one deduction)
                                // The current logic deducts *after* 'Yes', so no refund is needed here if 'No' is chosen.
                                // However, if we wanted to pre-deduct and refund, it would be currentPlayer.credits += 100;
                                updatePlayerInfo(); // Ensure this is called to reflect any state changes if needed
                                hideEvent();
                                toast(`${currentPlayer.name} chose not to buy a treasure.`);
                                setTimeout(nextPlayer, 1000);
                            };
                            treasureButtons.appendChild(noButton);
                            
                            return; // Return here as we'll handle next steps after selection
                        } else {
                            toast(`${currentPlayer.name} doesn't have enough credits (100 required) to buy a treasure.`);
                            setTimeout(nextPlayer, 1000);
                        }
                        break;
                        
                    case 'Twist of Fate':
                        // Flash twist image
                        const twistFlash = document.getElementById('twist-flash');
                        twistFlash.style.display = 'block';
                        setTimeout(() => {
                            twistFlash.style.display = 'none';
                        }, 1200);

                        // Play twist of fate sound
                        sounds.twistOfFate.stop(); // Stop any previous instance
                        sounds.twistOfFate.play();
                        // Make sure it's audible
                        sounds.twistOfFate.volume(1.0);
                        
                        const card = drawTwistCard(cellData.era);
                        if (!card) {
                            toast(`${currentPlayer.name} experienced a twist of fate, but no card was available in the ${cellData.era} era.`);
                            sounds.twistOfFate.stop();
                            setTimeout(nextPlayer, 1000);
                            break;
                        }

                        showEvent(`${card.originalEra} - Twist of Fate`, card.description);

                        const twistButtons = document.getElementById('event-buttons');
                        twistButtons.innerHTML = ''; // Clear default 'OK' from showEvent

                        if (card.type === 'Roll again') {
                            toast(`${currentPlayer.name} gets to roll again: ${card.description}`);
                            // The modal might still be visible briefly, or hideEvent can be called sooner
                            hideEvent(); 
                            sounds.twistOfFate.stop(); // Stop the sound before setting up the re-roll
                            setTimeout(() => {
                                gameState.processingMove = false; // Allow next roll
                                rollButton.disabled = false;
                                if (currentPlayer.isAI) {
                                    setTimeout(handleAITurn, 1000); // AI handles its re-roll
                                } else {
                                    toast(`${currentPlayer.name}, it's your turn to roll again!`);
                                }
                                // Current player takes another turn, so DO NOT call nextPlayer()
                            }, 1500);
                            // updatePlayerInfo(); // Only if credits could have changed before this point in a 'Roll Again' card
                            return; // Critical: exit cell processing for this turn.
                        }

                        // Handle Collect, Pay, Lose a turn
                        if (card.type === 'Collect') {
                            let amountToGain = card.amount;
                            // Apply Credit Doubler if active
                            if (currentPlayer.effects.some(effect => effect.name === 'Credit Doubler' && effect.duration > 0)) {
                                amountToGain *= 2;
                                toast(`Credit Doubler activated! Gain doubled to ${amountToGain}!`);
                            }
                            // Apply Karma Booster if active
                            if (currentPlayer.effects.some(effect => effect.name === 'Karma Booster' && effect.duration > 0)) {
                                const boostedAmount = Math.floor(amountToGain * 0.5); // Check if this is cumulative or based on original card.amount
                                amountToGain += boostedAmount; // Let's assume based on current amountToGain
                                toast(`Karma Booster activated! Gain increased to ${amountToGain}!`);
                            }
                            currentPlayer.credits += amountToGain;
                            gameState.lifetimeCredits[gameState.currentPlayerIndex] += amountToGain;
                            toast(`${currentPlayer.name} collected ${amountToGain} credits.`);
                        } else if (card.type === 'Pay') {
                            let amountToPay = card.amount;
                            const hasKarmaShield = currentPlayer.effects.findIndex(effect => effect.name === 'Karma Shield' && effect.duration > 0);
                            if (hasKarmaShield >= 0) {
                                toast(`${currentPlayer.name}'s Karma Shield protected against losing ${amountToPay} credits!`);
                                currentPlayer.effects.splice(hasKarmaShield, 1); // Remove the shield
                                amountToPay = 0;
                            }

                            if (amountToPay > 0) {
                                const actualPayment = Math.min(amountToPay, currentPlayer.credits);
                                currentPlayer.credits = Math.max(0, currentPlayer.credits - actualPayment);
                                gameState.charityPool += actualPayment;
                                toast(`${currentPlayer.name} paid ${actualPayment} credits. ${actualPayment} credits added to charity pool.`);
                            }
                        } else if (card.type === 'Lose a turn') {
                            currentPlayer.skipNextTurn = true;
                            toast(`${currentPlayer.name} loses their next turn: ${card.description}`);
                        }

                        // Add an OK button for Collect, Pay, Lose a turn outcomes
                        const okButton = document.createElement('button');
                        okButton.textContent = 'OK';
                        okButton.onclick = () => {
                            hideEvent();
                            updatePlayerInfo();
                            // Stop twist of fate sound when turn ends
                            sounds.twistOfFate.stop();
                            setTimeout(nextPlayer, 1000);
                        };
                        twistButtons.appendChild(okButton);
                        break;
                        
                    case 'Robbery':
                        // Flash robbery image
                        const robberyFlash = document.getElementById('robbery-flash');
                        robberyFlash.style.display = 'block';
                        setTimeout(() => {
                            robberyFlash.style.display = 'none';
                        }, 1200);

                        // Steal a treasure from another player
                        if (gameState.players.length > 1) {
                            const playersWithNonMajorTreasures = gameState.players.filter((p, i) => 
                                i !== gameState.currentPlayerIndex && p.treasures.some(t => !t.major)
                            );
                            
                            if (playersWithNonMajorTreasures.length > 0) {
                                // Play interaction sound only if there are targets
                                sounds.interaction.stop(); // Stop any previous instance
                                sounds.interaction.play();
                                sounds.interaction.volume(1.0);

                                showEvent('Robbery', 
                                    `${currentPlayer.name}, choose a player to steal a non-major treasure from:`);
                                
                                // Create buttons for each player with treasures
                                const eventButtons = document.getElementById('event-buttons');
                                eventButtons.innerHTML = '';
                                
                                playersWithNonMajorTreasures.forEach((targetPlayer) => {
                                    const button = document.createElement('button');
                                    const vulnerableTreasureCount = targetPlayer.treasures.filter(t => !t.major).length;
                                    button.textContent = `${targetPlayer.name} (${vulnerableTreasureCount} vulnerable treasures)`;
                                    button.onclick = () => {
                                        const stealableTreasures = targetPlayer.treasures.filter(t => !t.major);
                                        // No need to check stealableTreasures.length > 0 due to outer filter

                                        const treasureIndexInStealable = Math.floor(Math.random() * stealableTreasures.length);
                                        const stolenTreasureDetails = stealableTreasures[treasureIndexInStealable];

                                        let foundIndex = -1;
                                        for(let k=0; k < targetPlayer.treasures.length; k++){
                                            if(targetPlayer.treasures[k].title === stolenTreasureDetails.title &&
                                               targetPlayer.treasures[k].value === stolenTreasureDetails.value &&
                                               !targetPlayer.treasures[k].major){ // ensure it's the correct non-major treasure
                                                foundIndex = k;
                                                break;
                                            }
                                        }

                                        if (foundIndex !== -1) {
                                            const stolenTreasure = targetPlayer.treasures.splice(foundIndex, 1)[0];
                                            currentPlayer.treasures.push(stolenTreasure);
                                            toast(`${currentPlayer.name} stole ${stolenTreasure.title} from ${targetPlayer.name}!`);
                                            setTimeout(() => {
                                                showItemModal(stolenTreasure);
                                            }, 1000);
                                        } else {
                                            toast(`Error: Could not find the selected treasure to steal from ${targetPlayer.name}.`);
                                        }
                                        hideEvent();
                                        updatePlayerInfo();
                                        sounds.interaction.stop();
                                    };
                                    eventButtons.appendChild(button);
                                });
                                
                                // Add skip button
                                const skipButton = document.createElement('button');
                                skipButton.textContent = 'Skip';
                                skipButton.onclick = () => {
                                    hideEvent();
                                    toast(`${currentPlayer.name} chose not to rob anyone.`);
                                    sounds.interaction.stop(); // Stop sound on skip
                                    setTimeout(nextPlayer, 1000);
                                };
                                eventButtons.appendChild(skipButton);
                                
                                return; // Return here as we'll handle next steps after selection
                            } else {
                                toast(`No players have any non-major treasures to steal!`);
                                // No sound played, so no stop needed here
                                setTimeout(nextPlayer, 1000);
                            }
                        } else {
                            toast(`${currentPlayer.name} has no one to rob!`);
                            // No sound played, so no stop needed here
                            setTimeout(nextPlayer, 1000);
                        }
                        break;
                        
                    case 'Vengeance':
                        // Flash vengeance image
                        const vengeanceFlash = document.getElementById('vengeance-flash');
                        vengeanceFlash.style.display = 'block';
                        setTimeout(() => {
                            vengeanceFlash.style.display = 'none';
                        }, 1200);

                        // Play interaction sound
                        sounds.interaction.stop(); // Stop any previous instance
                        sounds.interaction.play();
                        // Make sure it's audible
                        sounds.interaction.volume(1.0);
                        
                        // Take exactly 200 credits from another player
                        if (gameState.players.length > 1) {
                            const otherPlayers = gameState.players.filter((p, i) => i !== gameState.currentPlayerIndex);
                            const targetOptions = otherPlayers.map(p => `${p.name} (${p.credits} credits)`).join('\n');
                            
                            showEvent('Vengeance', 
                                `${currentPlayer.name}, choose a player to take 200 credits from:\n\n${targetOptions}`);
                            
                            // Create buttons for each player
                            const eventButtons = document.getElementById('event-buttons');
                            eventButtons.innerHTML = '';
                            
                            otherPlayers.forEach((player, idx) => {
                                const button = document.createElement('button');
                                button.textContent = player.name;
                                button.onclick = () => {
                                    const vengeanceAmount = 200;
                                    const actualAmount = Math.min(vengeanceAmount, player.credits);
                                    player.credits = Math.max(0, player.credits - actualAmount);
                                    currentPlayer.credits += actualAmount;
                                    gameState.lifetimeCredits[gameState.currentPlayerIndex] += actualAmount;
                                    toast(`${currentPlayer.name} took ${actualAmount} credits from ${player.name}!`);
                                    hideEvent();
                                    updatePlayerInfo();
                                    // Stop interaction sound
                                    sounds.interaction.stop();
                                    setTimeout(nextPlayer, 1000);
                                };
                                eventButtons.appendChild(button);
                            });
                            
                            // Add skip button
                            const skipButton = document.createElement('button');
                            skipButton.textContent = 'Skip';
                            skipButton.onclick = () => {
                                hideEvent();
                                toast(`${currentPlayer.name} chose not to take vengeance.`);
                                // Stop interaction sound
                                sounds.interaction.stop();
                                setTimeout(nextPlayer, 1000);
                            };
                            eventButtons.appendChild(skipButton);
                            
                            return; // Return here as we'll handle next steps after selection
                        } else {
                            toast(`${currentPlayer.name} has no one to take vengeance on!`);
                            // Stop interaction sound
                            sounds.interaction.stop();
                            setTimeout(nextPlayer, 1000);
                        }
                        break;
                        
                    case 'Time Portal':
                        sounds.timePortalEffect.play();
                        // Choose any era to travel to
                        showEvent('Time Portal',
                            `${currentPlayer.name}, you've entered a Time Portal! Choose any era to travel to:`);

                        // Set up buttons for choices
                        const eventButtons = document.getElementById('event-buttons');
                        eventButtons.innerHTML = '';

                        // Create a button for each era
                        const eraNames = ['Industrial', 'Kings', 'Dark', 'Ancient'];
                        const titleSquareIndices = [1, 46, 89, 137]; // Indices of Title squares for Industrial, Kings, Dark, Ancient

                        eraNames.forEach((eraName, index) => { // 'index' here is targetEraIndex essentially
                            const eraButton = document.createElement('button');
                            eraButton.textContent = eraName;
                            eraButton.onclick = () => {
                                const newPosition = titleSquareIndices[index]; // index is the targetEraIndex
                                currentPlayer.position = newPosition;
                                placePlayerTokens();
                                toast(`${currentPlayer.name} traveled to the ${eraName} era's Title square!`);

                                hideEvent();
                                updatePlayerInfo();

                                // The player has landed on a new square (Title), so process its effect.
                                gameState.processingMove = false; // Allow processCellEffect to run
                                processCellEffect(); // This will handle the Title square logic itself
                            };
                            eventButtons.appendChild(eraButton);
                        });

                        // Stay button
                        const stayButton = document.createElement('button');
                        stayButton.textContent = 'Stay';
                        stayButton.onclick = () => {
                            toast(`${currentPlayer.name} chose to stay in the current era.`);
                            hideEvent();
                            setTimeout(nextPlayer, 1000);
                        };
                        eventButtons.appendChild(stayButton);

                        return; // Return here as we're handling next steps after selection
                        break;
                        
                    case 'Sudden Death':
                        // Flash sudden death image
                        const suddenDeathFlash = document.getElementById('sudden-death-flash');
                        suddenDeathFlash.style.display = 'block';
                        setTimeout(() => {
                            suddenDeathFlash.style.display = 'none';
                        }, 1200);

                        sounds.suddenDeath.play();
                        sounds.suddenDeath.volume(1.0);

                        if (currentPlayer.hasInsurance) {
                            toast(`${currentPlayer.name}'s insurance protected against Sudden Death!`);
                            currentPlayer.hasInsurance = false; // Consume insurance
                            updatePlayerInfo(); // Reflect change
                            setTimeout(nextPlayer, 1500); // Proceed (works for human & AI)
                        } else {
                            // No insurance
                            const creditsLost = currentPlayer.credits;
                            let valueOfTreasuresLost = 0;
                            const treasuresLostArray = [...currentPlayer.treasures]; // Store for message and calculation

                            treasuresLostArray.forEach(treasure => {
                                valueOfTreasuresLost += treasure.value || 0; // All treasures are lost, including Major ones
                            });

                            // Add lost credits and the total value of lost treasures to charity pool
                            gameState.charityPool = (gameState.charityPool || 0) + creditsLost + valueOfTreasuresLost;

                            currentPlayer.credits = 0;
                            currentPlayer.treasures = []; // All treasures are lost from player
                            updatePlayerInfo(); // Update state immediately

                            const eventMessageBase = `${currentPlayer.name} landed on Sudden Death! Lost ${creditsLost} credits and ${treasuresLostArray.length} treasure(s) (total value ${valueOfTreasuresLost}) to the Charity Pool.`;
                            
                            // Human player gets a modal
                            const fullEventMessage = eventMessageBase + '\n\nLand on a Charity square to collect from the pool.';
                            showEvent('Sudden Death', fullEventMessage); 
                            const humanOkButton = document.getElementById('event-buttons').firstChild; 
                            if (humanOkButton) {
                                humanOkButton.onclick = () => {
                                    hideEvent();
                                    setTimeout(nextPlayer, 1000);
                                };
                            }
                            return; // Crucial: Human interaction needed
                        }
                        break; // End of Sudden Death case
                        
                    case 'Gamble':
                        sounds.gambleSquareEffect.play();
                        // Gambling square - risk credits for bigger reward
                        showEvent('Gamble', 
                            `${currentPlayer.name}, you've landed on a Gamble square!\n\n` +
                            `How much would you like to bet? (Current credits: ${currentPlayer.credits})`);
                        
                        // Clear previous buttons
                        const gamblingButtons = document.getElementById('event-buttons');
                        gamblingButtons.innerHTML = '';
                        
                        // Add betting options
                        const betOptions = [50, 100, 200, 'Half', 'All'];
                        
                        betOptions.forEach(option => {
                            const betButton = document.createElement('button');
                            let betAmount = option;
                            
                            if (option === 'Half') {
                                betAmount = Math.floor(currentPlayer.credits / 2);
                                betButton.textContent = `Half (${betAmount})`;
                            } else if (option === 'All') {
                                betAmount = currentPlayer.credits;
                                betButton.textContent = `All (${betAmount})`;
                            } else {
                                betButton.textContent = option.toString();
                            }
                            
                            // Disable button if player doesn't have enough credits
                            if (betAmount > currentPlayer.credits) {
                                betButton.disabled = true;
                            }
                            
                            betButton.onclick = () => {
                                // Hide the betting options first
                                hideEvent();
                                
                                // Roll dice for gambling with animation
                                const diceResult = rollTwoDice();
                                animateDiceRoll(diceResult);
                                
                                // Wait for dice animation to complete before showing outcome
                                setTimeout(() => {
                                    // Determine outcome
                                    let outcome = '';
                                    if (diceResult.total > 7) { // Win on 8-12
                                        currentPlayer.credits += betAmount; // Player profits by betAmount
                                        gameState.lifetimeCredits[gameState.currentPlayerIndex] += betAmount;
                                        outcome = `You rolled ${diceResult.die1} and ${diceResult.die2} (total: ${diceResult.total})! You win ${betAmount} credits!`;
                                    } else if (diceResult.total < 7) { // Lose on 2-6
                                        const actualLoss = Math.min(betAmount, currentPlayer.credits);
                                        currentPlayer.credits -= actualLoss;
                                        gameState.charityPool += actualLoss; // Add lost credits to charity pool
                                        outcome = `You rolled ${diceResult.die1} and ${diceResult.die2} (total: ${diceResult.total})! You lose ${actualLoss} credits, which are added to the Charity Pool.`;
                                    } else { // Roll is 7, Draw
                                        // No change in credits, bet is effectively returned
                                        outcome = `You rolled ${diceResult.die1} and ${diceResult.die2} (total: ${diceResult.total})! It's a draw! Your bet of ${betAmount} is returned.`;
                                    }
                                    
                                    // Show outcome in a new event display
                                    showEvent('Gamble Result', `${currentPlayer.name}, you bet ${betAmount} credits.\n\n${outcome}\n\nYour new balance: ${currentPlayer.credits} credits`);
                                    
                                    // Clear previous buttons and add OK button
                                    const gamblingResultButtons = document.getElementById('event-buttons');
                                    gamblingResultButtons.innerHTML = '';
                                    const okButton = document.createElement('button');
                                    okButton.textContent = 'OK';
                                    okButton.onclick = () => {
                                        hideEvent();
                                        updatePlayerInfo();
                                        setTimeout(nextPlayer, 1000);
                                    };
                                    gamblingResultButtons.appendChild(okButton);
                                }, 2000); // Wait for dice animation to complete
                            };
                            
                            gamblingButtons.appendChild(betButton);
                        });
                        
                        // Add skip button
                        const skipButton = document.createElement('button');
                        skipButton.textContent = 'Skip';
                        skipButton.onclick = () => {
                            toast(`${currentPlayer.name} chose not to gamble.`);
                            hideEvent();
                            setTimeout(nextPlayer, 1000);
                        };
                        gamblingButtons.appendChild(skipButton);
                        
                        return; // Return here as we'll handle next steps after selection
                        break;
                        
                    case 'Major Treasure':
                        // Initialize major treasures tracking if not exists
                        if (!gameState.majorTreasuresClaimed) {
                            gameState.majorTreasuresClaimed = {
                                industrial: false,
                                kings: false,
                                dark: false,
                                ancient: false
                            };
                        }
                        
                        // Check if this era's major treasure has already been claimed
                        if (gameState.majorTreasuresClaimed[cellData.era]) {
                            toast(`${currentPlayer.name} found the Major Treasure spot, but it has already been claimed!`);
                            setTimeout(nextPlayer, 1000);
                            break;
                        }
                        
                        // Define the specific major treasures for each era
                        const majorTreasures = {
                            industrial: { 
                                title: "The Patent of Electricity", 
                                value: 1250, 
                                description: "The Patent of Electricity. Worth 1250 credits.",
                                imageUrl: "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F45CCE2C3-35F2-4E17-BE11-6E805BF7C474.png?alt=media&token=c9a08e76-78fe-4ad1-976a-462abc4dc6e8"
                            },
                            kings: { 
                                title: "The Sword of Charlemagne", 
                                value: 1750, 
                                description: "The Sword of Charlemagne. Worth 1750 credits.",
                                imageUrl: "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F5E34659C-C8B8-4C56-B4FD-9864C48F75F7.png?alt=media&token=dd83b584-8fd4-49f1-8376-e3b71e9fd87b"
                            },
                            dark: { 
                                title: "The Holy Grail", 
                                value: 2000, 
                                description: "The Holy Grail. Worth 2000 credits.",
                                imageUrl: "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F10C63A44-6080-4F02-A2EA-EF384AD1CFAF.png?alt=media&token=ad433c70-761e-4622-a355-30306af24cff"
                            },
                            ancient: { 
                                title: "The Sphinx", 
                                value: 2500, 
                                description: "The Sphinx. Worth 2500 credits.",
                                imageUrl: "https://firebasestorage.googleapis.com:443/v0/b/sticky-20bca.appspot.com/o/game%2Fec245d37-f7dd-42ea-b9e6-290d3b34a45b%2Fassets%2F33FCE8E7-9FE4-4109-8358-77D62DB1B2AE.png?alt=media&token=35ad5360-4cc8-4d02-82bd-a312c1b114cd"
                            }
                        };
                        
                        // Get the appropriate major treasure for this era
                        let majorTreasure = {...majorTreasures[cellData.era]}; // Create a copy
                        majorTreasure.major = true; // Mark as a Major Treasure (for protection from robbery/evil eye)
                        
                        // Mark this era's major treasure as claimed
                        gameState.majorTreasuresClaimed[cellData.era] = true;
                        
                        // Add the treasure to player's inventory
                        currentPlayer.treasures.push(majorTreasure);
                        sounds.treasureChestOpen.play();
                        
                        // Show the treasure
                        toast(`${currentPlayer.name} found a major treasure: ${majorTreasure.title}! (Worth ${majorTreasure.value} credits)`);
                        setTimeout(() => {
                            showItemModal(majorTreasure);
                        }, 1000);
                        
                        updatePlayerInfo();
                        break;
                        
                    case 'Hazard':
                        // Lose a turn
                        const hazardName = cellData.hazardName || 'Unknown Hazard';
                        const hazardMessage = `${currentPlayer.name}, you've encountered a hazard: ${hazardName}!\n\n` +
                                            `You will lose your next turn.`;
                        
                        // Prepare the event display and manage buttons manually for this case
                        eventTitle.textContent = 'Hazard: ' + hazardName;
                        eventDescription.innerHTML = hazardMessage;
                        eventDisplay.style.display = 'block';

                        currentPlayer.skipNextTurn = true;

                        const hazardEventButtons = document.getElementById('event-buttons');
                        hazardEventButtons.innerHTML = ''; // Clear any existing/default buttons

                        const okButtonHazard = document.createElement('button');
                        okButtonHazard.textContent = 'OK';
                        okButtonHazard.id = 'event-button'; // Assign ID if needed for styling or consistency
                        okButtonHazard.onclick = () => {
                            hideEvent();
                            updatePlayerInfo(); // Update UI before moving to next player
                            setTimeout(nextPlayer, 1000);
                        };
                        hazardEventButtons.appendChild(okButtonHazard);
                        
                        return; // Important: game progression waits for this specific OK button.
                        break; // Unreachable due to the return statement
                        
                    case 'Lucky Day':
                        // Move forward or backward and gain 100 credits
                        showEvent('Lucky Day', 
                            `${currentPlayer.name}, it's your lucky day!\n\n` +
                            `You gain 100 credits and can roll again. You may move forward or backward.`);
                        
                        // Add credits
                        currentPlayer.credits += 100;
                        gameState.lifetimeCredits[gameState.currentPlayerIndex] += 100;
                        updatePlayerInfo(); // Update credits display immediately
                        
                        // Clear previous buttons
                        const luckyButtons = document.getElementById('event-buttons');
                        luckyButtons.innerHTML = '';
                        
                        // Add Roll Again button
                        const rollAgainButton = document.createElement('button');
                        rollAgainButton.textContent = 'Roll Again';
                        rollAgainButton.onclick = () => {
                            hideEvent();
                            
                            // Roll the dice again
                            const diceResult = rollTwoDice();
                            animateDiceRoll(diceResult);
                            toast(`${currentPlayer.name} rolled a ${diceResult.total}`);
                            
                            // Ask if they want to move forward or backward after dice animation completes
                            setTimeout(() => {
                                showEvent('Lucky Day', 
                                    `${currentPlayer.name}, you rolled a ${diceResult.total} (${diceResult.die1} and ${diceResult.die2}).\n\n` +
                                    `Do you want to move forward or backward?`);
                                
                                // Create direction buttons
                                const directionButtons = document.getElementById('event-buttons');
                                directionButtons.innerHTML = '';
                                
                                // Forward button
                                const forwardButton = document.createElement('button');
                                forwardButton.textContent = 'Forward';
                                forwardButton.onclick = () => {
                                    hideEvent();
                                    const currentPos = currentPlayer.position;
                                    const newLuckyPos = Math.min(currentPos + diceResult.total, 169); // Max board index is 169
                                    animateMovement(gameState.currentPlayerIndex, currentPos, newLuckyPos, true, () => {
                                        placePlayerTokens(); // Ensure final placement
                                        toast(`${currentPlayer.name} moved forward ${diceResult.total} spaces.`);
                                        processCellEffect(); // Process the new cell
                                    });
                                };
                                directionButtons.appendChild(forwardButton);
                                
                                // Backward button
                                const backwardButton = document.createElement('button');
                                backwardButton.textContent = 'Backward';
                                backwardButton.onclick = () => {
                                    hideEvent();
                                    const currentPos = currentPlayer.position;
                                    const newLuckyPosBack = Math.max(currentPos - diceResult.total, 0);
                                    animateMovement(gameState.currentPlayerIndex, currentPos, newLuckyPosBack, false, () => {
                                        placePlayerTokens(); // Ensure final placement
                                        toast(`${currentPlayer.name} moved backward ${diceResult.total} spaces.`);
                                        processCellEffect(); // Process the new cell
                                    });
                                };
                                directionButtons.appendChild(backwardButton);
                            }, 2000); // Wait for dice animation to complete
                        };
                        luckyButtons.appendChild(rollAgainButton);
                        return;
                        break;
                        
                    case 'Evil Eye':
                        // Play evil eye sound
                        sounds.evilEye.play();
                        // Make sure it's audible
                        sounds.evilEye.volume(1.0);
                        
                        // Duel another player for a treasure
                        if (gameState.players.length > 1) {
                            const playersWithAnyTreasures = gameState.players.filter((p, i) => 
                                i !== gameState.currentPlayerIndex && p.treasures.length > 0);
                            
                            if (playersWithAnyTreasures.length > 0) {
                                showEvent('Evil Eye', 
                                    `${currentPlayer.name}, choose a player to duel for a treasure:`);
                                
                                // Create buttons for each player with treasures
                                const eventButtons = document.getElementById('event-buttons');
                                eventButtons.innerHTML = '';
                                
                                playersWithAnyTreasures.forEach((targetPlayer) => {
                                    const button = document.createElement('button');
                                    const vulnerableTreasureCount = targetPlayer.treasures.filter(t => !t.major).length;
                                    const totalTreasureCount = targetPlayer.treasures.length;
                                    button.textContent = `${targetPlayer.name} (${vulnerableTreasureCount} vulnerable / ${totalTreasureCount} total treasures)`;
                                    button.onclick = () => {
                                        // Roll for duel
                                        const playerRoll = rollTwoDice();
                                        const opponentRoll = rollTwoDice();
                                        
                                        let result = `${currentPlayer.name} rolled ${playerRoll}, ${player.name} rolled ${opponentRoll}.\n\n`;
                                        
                                        if (playerRoll > opponentRoll) {
                                            // Current player wins
                                            // Only steal non-major treasures
                                            const stealableTreasures = player.treasures.filter(t => !t.major);
                                            if (stealableTreasures.length === 0) {
                                                result += `${player.name} has no stealable treasures!`;
                                            } else {
                                                const treasureIndex = Math.floor(Math.random() * stealableTreasures.length);
                                                const stolenTreasureDetails = stealableTreasures[treasureIndex];
                                                
                                                // Find this treasure in the player's actual inventory
                                                let foundIndex = -1;
                                                for(let k=0; k < player.treasures.length; k++){
                                                    if(player.treasures[k].title === stolenTreasureDetails.title &&
                                                       player.treasures[k].value === stolenTreasureDetails.value &&
                                                       !player.treasures[k].major){
                                                        foundIndex = k;
                                                        break;
                                                    }
                                                }
                                                
                                                if (foundIndex !== -1) {
                                                    const stolenTreasure = player.treasures.splice(foundIndex, 1)[0];
                                                    currentPlayer.treasures.push(stolenTreasure);
                                                    result += `${currentPlayer.name} wins and takes ${stolenTreasure.title} from ${player.name}!`;
                                                } else {
                                                    result += `Error: Could not find the selected treasure to steal.`;
                                                }
                                            }
                                            const stolenTreasure = player.treasures.splice(treasureIndex, 1)[0];
                                            currentPlayer.treasures.push(stolenTreasure);
                                            
                                            result += `${currentPlayer.name} wins and takes ${stolenTreasure.title} from ${player.name}!`;
                                        } else {
                                            // Opponent wins or tie (defender wins ties)
                                            result += `${player.name} wins and keeps their treasure!`;
                                        }
                                        
                                        // Show result
                                        eventDescription.innerHTML = result;
                                        
                                        // Clear buttons and add OK button
                                        eventButtons.innerHTML = '';
                                        const okButton = document.createElement('button');
                                        okButton.textContent = 'OK';
                                        okButton.onclick = () => {
                                            hideEvent();
                                            updatePlayerInfo();
                                            setTimeout(nextPlayer, 1000);
                                        };
                                        eventButtons.appendChild(okButton);
                                    };
                                    eventButtons.appendChild(button);
                                });
                                
                                // Add skip button
                                const skipButton = document.createElement('button');
                                skipButton.textContent = 'Skip';
                                skipButton.onclick = () => {
                                    hideEvent();
                                    toast(`${currentPlayer.name} chose not to duel anyone.`);
                                    setTimeout(nextPlayer, 1000);
                                };
                                eventButtons.appendChild(skipButton);
                                
                                return; // Return here as we'll handle next steps after selection
                            } else {
                                toast(`No players have treasures to duel for!`);
                                setTimeout(nextPlayer, 1000);
                            }
                        } else {
                            toast(`${currentPlayer.name} has no one to duel!`);
                            setTimeout(nextPlayer, 1000);
                        }
                        break;
                        
                    case 'Charity':
                        // Collect from charity pool
                        if (gameState.charityPool > 0) {
                            const charityAmount = gameState.charityPool;
                            currentPlayer.credits += charityAmount;
                            gameState.lifetimeCredits[gameState.currentPlayerIndex] += charityAmount;
                            gameState.charityPool = 0; // Pool is now 0
                            updatePlayerInfo(); // Update UI to show new player credits AND zeroed pool
                            toast(`${currentPlayer.name} collected ${charityAmount} credits from the Charity pool!`);
                        } else {
                            // Even if pool is empty, call updatePlayerInfo to ensure UI reflects this state correctly.
                            updatePlayerInfo(); 
                            toast(`The Charity pool is empty.`);
                        }
                        setTimeout(nextPlayer, 1000);
                        break;
                        
                    case 'Roll Again':
                        // Roll again immediately
                        toast(`${currentPlayer.name} gets to roll again!`);
                        setTimeout(() => {
                            gameState.processingMove = false; // Reset processing flag
                            rollButton.disabled = false; // Enable roll button
                            
                            // If AI player, trigger their turn
                            if (currentPlayer.isAI) {
                                setTimeout(handleAITurn, 1000);
                            } else {
                                // For human player, just show a message
                                toast(`${currentPlayer.name}, roll again!`);
                            }
                        }, 1000);
                        break;
                        
                    case 'Barter':
                        // Flash barter image
                        const barterFlash = document.getElementById('barter-flash');
                        barterFlash.style.display = 'block';
                        setTimeout(() => {
                            barterFlash.style.display = 'none';
                        }, 1200);

                        // Trade one treasure for another random one
                        const barterableTreasures = currentPlayer.treasures.filter(t => !t.major);
                        if (barterableTreasures.length > 0) {
                            // Play interaction sound only if player has treasures
                            sounds.interaction.stop(); // Stop any previous instance
                            sounds.interaction.play();
                            sounds.interaction.volume(1.0);

                            showEvent('Barter', 
                                `${currentPlayer.name}, choose a treasure to trade for a random one:`);
                            
                            // Create buttons for each treasure
                            const eventButtons = document.getElementById('event-buttons');
                            eventButtons.innerHTML = '';
                            
                            barterableTreasures.forEach((treasure, indexInBarterable) => {
                                const button = document.createElement('button');
                                button.textContent = treasure.title;
                                button.onclick = () => {
                                    // Find and remove the selected non-major treasure from the player's actual inventory
                                    const actualTreasureIndex = currentPlayer.treasures.findIndex(t => t.title === treasure.title && t.value === treasure.value && !t.major);
                                    if (actualTreasureIndex === -1) { 
                                         toast(`Error: Could not find ${treasure.title} in your inventory to barter.`);
                                         hideEvent();
                                         setTimeout(nextPlayer, 1000);
                                         return;
                                    }
                                    const tradedOutTreasure = currentPlayer.treasures.splice(actualTreasureIndex, 1)[0];
                                    
                                    // Get a random treasure from the current era
                                    if (eraContent[cellData.era] && eraContent[cellData.era].treasures.length > 0) {
                                        const newTreasureIndex = Math.floor(Math.random() * eraContent[cellData.era].treasures.length);
                                        let newTreasure = {...eraContent[cellData.era].treasures[newTreasureIndex]}; // Create a copy

                                        // Ensure 'value' property is set, parsing from description if needed (as a fallback)
                                        if (newTreasure.value === undefined) {
                                            const pointMatch = newTreasure.description.match(/Worth (\\d+) points/);
                                            newTreasure.value = pointMatch ? parseInt(pointMatch[1]) : 0;
                                        }

                                        currentPlayer.treasures.push(newTreasure);
                                        
                                        // Show the new treasure
                                        hideEvent();
                                        toast(`${currentPlayer.name} traded ${tradedOutTreasure.title} (Worth ${tradedOutTreasure.value || 0}) for ${newTreasure.title} (Worth ${newTreasure.value})!`);
                                        updatePlayerInfo();
                                        sounds.interaction.stop(); // Stop sound on completion
                                        setTimeout(() => {
                                            showItemModal(newTreasure); // showItemModal handles next player
                                        }, 1000);
                                    } else {
                                        hideEvent();
                                        toast(`${currentPlayer.name} traded ${tradedOutTreasure.title} but got nothing in return from the ${cellData.era} era!`);
                                        updatePlayerInfo();
                                        sounds.interaction.stop(); // Stop sound here as well
                                        setTimeout(nextPlayer, 1000);
                                    }
                                };
                                eventButtons.appendChild(button);
                            });
                            
                            // Add skip button
                            const skipButton = document.createElement('button');
                            skipButton.textContent = 'Skip';
                            skipButton.onclick = () => {
                                hideEvent();
                                toast(`${currentPlayer.name} chose not to barter.`);
                                sounds.interaction.stop(); // Stop sound on skip
                                setTimeout(nextPlayer, 1000);
                            };
                            eventButtons.appendChild(skipButton);
                            
                            return; // Return here as we'll handle next steps after selection
                        } else {
                            toast(`${currentPlayer.name} has no non-major treasures to barter with.`);
                            // No sound played, so no stop needed here
                            setTimeout(nextPlayer, 1000);
                        }
                        break;
                        
                    case 'Nirvana':
                        // End the game
                        sounds.nirvanaReached.play();
                        toast(`${currentPlayer.name} has reached Nirvana!`);
                        setTimeout(endGame, 1000);
                        break;
                        
                    default:
                        toast(`${currentPlayer.name} landed on ${cellData.type}.`);
                        setTimeout(nextPlayer, 1000);
                        break;
                }
            };

            // Show cell information modal
            showCellModal(currentPlayer.position);

            if (currentPlayer.isAI) {
                // AI "auto-closes" the cell-modal effects logic after a short delay
                setTimeout(() => {
                    if (document.getElementById('cell-modal').style.display === 'block') {
                        document.getElementById('cell-modal').style.display = 'none'; // Explicitly hide if still open
                    }
                    applyEffect();
                }, 1500); // Delay for AI to "see" the cell modal info.
            } else {
                // For human players, the 'cell-close-button' from cell-modal triggers the effect.
                document.getElementById('cell-close-button').onclick = () => {
                    // document.getElementById('cell-modal').style.display = 'none'; // applyEffect will hide it or it's already hidden
                    applyEffect();
                };
            }
        }
    </script>
</body>
</html>
